---
/**
 * Template: Salon/Peluqueria
 * Renderiza la plantilla de salon usando datos del tenant
 */
import type { TenantData } from "../../middleware";

// Import components from salon template
import Layout from "@salon/layouts/Layout.astro";
import Header from "@salon/components/Header.astro";
import AppointmentForm from "@salon/components/AppointmentForm.astro";
import { HeroClassic, HeroModern, HeroBold, HeroMinimal, HeroFullscreen, HeroSplit } from "@salon/components/Hero";
import { ServicesTabs, ServicesGrid, ServicesList, ServicesCarousel } from "@salon/components/Services";
import { FeaturesCards, FeaturesIcons, FeaturesBanner } from "@salon/components/Features";
import { FooterFull, FooterMinimal, FooterCentered } from "@salon/components/Footer";
import { ReviewsGrid, ReviewsCarousel, ReviewsMinimal } from "@salon/components/Reviews";
import { FAQSection, ContactSection, OpenStatusSection, TeamSection, GallerySection, BrandsSection, PlansSection } from "@salon/components/Sections";

// Import Supabase helpers
import { getBusinessHours, getProfessionalCategories, getProfessionals, getServiceCatalog } from "@salon/lib/supabase";
import { createPortalClient } from "../../lib/supabase-portal";

// Get tenant from middleware
const tenant = Astro.locals.tenant as TenantData;
const rawConfig = tenant.config as Record<string, unknown>;
const nestedContent = rawConfig && typeof rawConfig === "object" && rawConfig.content && typeof rawConfig.content === "object"
  ? (rawConfig.content as Record<string, unknown>)
  : undefined;
const config = (nestedContent ? { ...rawConfig, ...nestedContent } : rawConfig) as Record<string, unknown>;

// Preview mode: permite probar variantes via URL params
// Ejemplo: ?preview=1&v_hero=modern&v_services=grid&theme=dark
const url = new URL(Astro.request.url);
const isPreview = url.searchParams.get("preview") === "1";
const previewTheme = url.searchParams.get("theme");
const previewVariants = {
  hero: url.searchParams.get("v_hero"),
  services: url.searchParams.get("v_services"),
  features: url.searchParams.get("v_features"),
  footer: url.searchParams.get("v_footer"),
};
const previewSectionVariants = {
  team: url.searchParams.get("v_team"),
  gallery: url.searchParams.get("v_gallery"),
  brands: url.searchParams.get("v_brands"),
  faq: url.searchParams.get("v_faq"),
  plans: url.searchParams.get("v_plans"),
  contact: url.searchParams.get("v_contact"),
};

// Check if user is authenticated (SSR)
let currentUser: { email: string; id: string; customerId: string | null; name?: string; phone?: string | null } | null = null;
try {
  const supabase = createPortalClient(Astro.cookies, Astro.request);
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {

    // Get customer profile for this tenant
    const { data: customer, error: customerError } = await supabase
      .from("customers")
      .select("id, name, phone")
      .eq("website_id", tenant.id)
      .eq("auth_user_id", user.id)
      .single();


    currentUser = {
      email: user.email || "",
      id: user.id,
      customerId: customer?.id || null,
      name: customer?.name || user.user_metadata?.full_name || user.user_metadata?.name || "",
      phone: customer?.phone || null,
    };

  }
} catch (e) {
  // Auth check failed, user not logged in
}

// Component mapping
const componentMap = {
  hero: { classic: HeroClassic, modern: HeroModern, bold: HeroBold, minimal: HeroMinimal, fullscreen: HeroFullscreen, split: HeroSplit },
  services: { tabs: ServicesTabs, grid: ServicesGrid, list: ServicesList, carousel: ServicesCarousel },
  features: { cards: FeaturesCards, icons: FeaturesIcons, banner: FeaturesBanner },
  footer: { full: FooterFull, minimal: FooterMinimal, centered: FooterCentered },
  testimonials: { grid: ReviewsGrid, carousel: ReviewsCarousel, minimal: ReviewsMinimal },
};

// Get variants from config or use defaults
const configVariants = (config.variants as Record<string, string>) || {
  hero: "classic",
  services: "tabs",
  features: "cards",
  footer: "full",
};

// Apply preview overrides if in preview mode
const variants = isPreview ? {
  hero: previewVariants.hero || configVariants.hero,
  services: previewVariants.services || configVariants.services,
  features: previewVariants.features || configVariants.features,
  footer: previewVariants.footer || configVariants.footer,
} : configVariants;

// Select components based on variants
const Hero = componentMap.hero[variants.hero as keyof typeof componentMap.hero] || HeroClassic;
const Services = componentMap.services[variants.services as keyof typeof componentMap.services] || ServicesTabs;
const Features = componentMap.features[variants.features as keyof typeof componentMap.features] || FeaturesCards;
const FooterComponent = componentMap.footer[variants.footer as keyof typeof componentMap.footer] || FooterFull;
const Testimonials = componentMap.testimonials[(configVariants as Record<string, string>).testimonials as keyof typeof componentMap.testimonials] || ReviewsCarousel;

// Get service catalog from Supabase
const serviceCatalog = await getServiceCatalog(tenant.id);
const businessHours = await getBusinessHours(tenant.id);
const professionals = await getProfessionals(tenant.id);
const professionalCategories = await getProfessionalCategories(tenant.id);
const categoryInfo = new Map(
  serviceCatalog.map((category, index) => [
    category.id,
    {
      name: category.name,
      order: typeof category.sort_order === "number" ? category.sort_order : index,
    },
  ])
);
const professionalCategoryMap = new Map<string, string[]>();
professionalCategories.forEach((item) => {
  if (!professionalCategoryMap.has(item.professional_id)) {
    professionalCategoryMap.set(item.professional_id, []);
  }
  professionalCategoryMap.get(item.professional_id)?.push(item.category_id);
});
const teamMembers = professionals.map((professional) => {
  const categoryIds = professionalCategoryMap.get(professional.id) || [];
  const primaryCategory = categoryIds
    .map((id) => categoryInfo.get(id))
    .filter((item): item is { name: string; order: number } => Boolean(item))
    .sort((a, b) => (a.order - b.order) || a.name.localeCompare(b.name, "es"))
    .map((item) => item.name)[0];
  return {
    name: professional.name,
    role: primaryCategory,
    description: professional.description || undefined,
  };
});
const buildScheduleLabel = (hours: { is_open: boolean; open_time: string; close_time: string }[]) => {
  const openDay = hours.find((item) => item.is_open && item.open_time && item.close_time);
  if (!openDay) return "Cerrado";
  return `${openDay.open_time.slice(0, 5)} - ${openDay.close_time.slice(0, 5)}`;
};
const scheduleLabel = buildScheduleLabel(businessHours);

// Mapa de iconos (sincronizado con servicios-client.tsx del admin)
const ICON_MAP: Record<string, string> = {
  scissors: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>`,
  palette: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/><path d="m9 15 3-3 3 3"/><circle cx="12" cy="10" r="2"/></svg>`,
  clock: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>`,
  user: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
  heart: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
  star: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
  sparkles: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/><path d="M5 19l.5 1.5L7 21l-1.5.5L5 23l-.5-1.5L3 21l1.5-.5L5 19z"/><path d="M19 5l.5 1.5L21 7l-1.5.5L19 9l-.5-1.5L17 7l1.5-.5L19 5z"/></svg>`,
  hand: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2 2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>`,
  flower: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2a3 3 0 0 0 0 6 3 3 0 0 0 0 6"/><path d="M12 16a3 3 0 0 0 0 6"/><path d="M2 12a3 3 0 0 0 6 0 3 3 0 0 0 6 0"/><path d="M16 12a3 3 0 0 0 6 0"/></svg>`,
  droplet: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
  sun: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
  brush: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 4V2h-4v4h2v2h2V4z"/><path d="M14 4H6a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h8"/><path d="m14 10 3.5 10.5a1 1 0 0 1-1 1.5h-1a1 1 0 0 1-1-.5L11 10"/></svg>`,
};
const defaultIcon = ICON_MAP.scissors;

// ============================================
// CONFIGURACION DE SECCIONES DINAMICAS
// ============================================

interface SectionConfig {
  id: string;
  enabled: boolean;
  variant: string;
  order: number;
}

// Secciones por defecto (backward compatibility)
const defaultSections: SectionConfig[] = [
  { id: "hero", enabled: true, variant: "classic", order: 0 },
  { id: "features", enabled: true, variant: "cards", order: 1 },
  { id: "services", enabled: true, variant: "tabs", order: 2 },
  { id: "booking", enabled: true, variant: "classic", order: 3 },
  { id: "footer", enabled: true, variant: "full", order: 4 },
];

// Obtener sectionsConfig de la BD o usar defaults
const sectionsConfigRaw = config.sectionsConfig as { sections: SectionConfig[] } | undefined;
const sectionsConfig = sectionsConfigRaw || { sections: defaultSections };

// DEBUG

// Filtrar secciones habilitadas y ordenar
const enabledSections = sectionsConfig.sections
  .filter((s) => s.enabled)
  .sort((a, b) => a.order - b.order);


// Helper para verificar si una seccion esta habilitada
const isSectionEnabled = (sectionId: string): boolean => {
  return enabledSections.some(s => s.id === sectionId);
};

// ============================================
// SERVICE DATA
// ============================================

const serviceCategories = serviceCatalog.length
  ? serviceCatalog.map((category) => ({
      name: category.name,
      icon: category.icon ? (ICON_MAP[category.icon] || defaultIcon) : defaultIcon,
      items: category.items.map((item) => ({
        name: item.name,
        description: item.notes || "Servicio profesional personalizado",
        price: (item.price_cents / 100).toFixed(2),
        duration: `${item.duration_minutes} min`,
      })),
    }))
  : undefined;

// Features se generan desde las categorías de servicios (no desde config.features)
const serviceFeatures = serviceCatalog.length
  ? {
      title: "Nuestros Servicios",
      subtitle: "Descubre todo lo que podemos hacer por ti",
      features: serviceCatalog.slice(0, 4).map((category) => ({
        icon: category.icon ? (ICON_MAP[category.icon] || defaultIcon) : defaultIcon,
        title: category.name,
        description: category.items.length > 0
          ? `${category.items.length} servicios disponibles`
          : "Servicios profesionales",
        link: "#services",
      })),
    }
  : undefined;

// Extraer configuración de personalización visual
const customization = {
  colors: config.colors as Record<string, unknown> | undefined,
  primaryColor: config.primaryColor as string | undefined,
  secondaryColor: config.secondaryColor as string | undefined,
  typography: config.typography as Record<string, unknown> | undefined,
  effects: config.effects as Record<string, unknown> | undefined,
  branding: config.branding as Record<string, unknown> | undefined,
  logo: config.logo as string | undefined,
};

const getContentText = (key: string) => {
  const value = config?.[key];
  if (typeof value !== "string") return undefined;
  const trimmed = value.trim();
  return trimmed.length > 0 ? trimmed : undefined;
};

const getContentArray = (key: string) => {
  const value = config?.[key];
  return Array.isArray(value) && value.length > 0 ? value : undefined;
};

// === DEBUG LOGS ===

// Preview content params
const previewContent = isPreview ? {
  heroTitle: url.searchParams.get("heroTitle"),
  heroSubtitle: url.searchParams.get("heroSubtitle"),
  heroImage: url.searchParams.get("heroImage"),
  address: url.searchParams.get("address"),
  phone: url.searchParams.get("phone"),
  email: url.searchParams.get("email"),
  logo: url.searchParams.get("logo"),
} : null;

// Build page config (preview theme overrides tenant theme)
const activeTheme = (isPreview && previewTheme) ? previewTheme : tenant.theme;
const activeSkin = config.skin as "neumorphic" | "brutalist" | "3d" | "flat" | "glassmorphism" | undefined;
const pageConfig = {
  businessName: tenant.businessName,
  theme: activeTheme as "light" | "dark" | "auto",
  siteTitle: `${tenant.businessName} | Salon`,
  siteDescription: (config.siteDescription as string) || "Salon de belleza profesional",
  heroTitle: previewContent?.heroTitle || (config.heroTitle as string) || "Tu Estilo, Nuestra Pasion",
  heroSubtitle: previewContent?.heroSubtitle || (config.heroSubtitle as string) || "Expertos en cuidado capilar y estetica",
  heroImage: previewContent?.heroImage || (config.heroImage as string) || "https://images.unsplash.com/photo-1560066984-138dadb4c035?w=800&q=80",
  address: previewContent?.address || (config.address as string) || "",
  phone: previewContent?.phone || (config.phone as string) || "",
  email: previewContent?.email || (config.email as string) || "",
  logo: previewContent?.logo || (customization.branding?.logo as string) || customization.logo || "",
  socialLinks: (config.socialLinks as { instagram: string; facebook: string; whatsapp: string }) || {
    instagram: "#",
    facebook: "#",
    whatsapp: "#",
  },
  schedule: (config.schedule as { weekdays?: string; saturday?: string; sunday?: string }) || undefined,
  // Features ahora se generan desde serviceCatalog, no desde config.features
};

const webhookUrl = import.meta.env.PUBLIC_ADMIN_URL
  ? `${import.meta.env.PUBLIC_ADMIN_URL}/api/citas`
  : "";
---

<Layout
  title={pageConfig.siteTitle}
  description={pageConfig.siteDescription}
  theme={pageConfig.theme === "auto" ? "light" : pageConfig.theme}
  skin={activeSkin}
  customization={customization}
>
  <Header
    businessName={pageConfig.businessName}
    logo={pageConfig.logo}
    logoDisplay={(customization.branding as { logoDisplay?: "logo" | "name" } | undefined)?.logoDisplay}
  />

  <main class="sections-container" style="display: flex; flex-direction: column;">
    {/*
      Renderizado de TODAS las secciones para permitir live preview.
      Las secciones deshabilitadas se ocultan con display:none.
      El orden se controla con CSS order para reordenamiento en tiempo real.
    */}
    {(() => {
      const allSections = [
        "hero",
        "features",
        "services",
        "testimonials",
        "team",
  "gallery",
  "brands",
        "faq",
        "plans",
        "contact",
        "booking",
      ];
      const sectionConfigMap = new Map(sectionsConfig.sections.map((s) => [s.id, s]));
      const legacyEnabledSections = new Set(
        defaultSections.filter((section) => section.enabled).map((section) => section.id)
      );

      return allSections.map((sectionId) => {
        const sectionCfg = sectionConfigMap.get(sectionId);
        const isEnabled = sectionCfg?.enabled ?? legacyEnabledSections.has(sectionId);
        const order = sectionCfg?.order ?? 99;
        const style = `order: ${order}; ${!isEnabled ? 'display: none;' : ''}`;

        switch (sectionId) {
          case "hero":
            return (
              <section data-section-id="hero" style={style}>
                <Hero
                  title={pageConfig.heroTitle}
                  subtitle={pageConfig.heroSubtitle}
                  ctaText={getContentText("heroCta")}
                  backgroundImage={pageConfig.heroImage}
                  scheduleLabel={scheduleLabel}
                  address={pageConfig.address}
                  phone={pageConfig.phone}
                />
              </section>
            );
          case "features":
            return (
              <section data-section-id="features" style={style}>
                <Features
                  title={serviceFeatures?.title}
                  subtitle={serviceFeatures?.subtitle}
                  features={serviceFeatures?.features}
                />
              </section>
            );
          case "services":
            return (
              <section data-section-id="services" style={style}>
                <Services label={getContentText("servicesLabel")} title={getContentText("servicesTitle")} subtitle={getContentText("servicesSubtitle")} categories={serviceCategories} />
              </section>
            );
          case "testimonials":
            return (
              <section data-section-id="testimonials" style={style}>
                <Testimonials
                  title={getContentText("reviewsTitle")}
                  subtitle={getContentText("reviewsSubtitle")}
                  googleRating={config.googleRating as number | undefined}
                  totalReviews={config.totalReviews as number | undefined}
                />
              </section>
            );
          case "team":
            return (
              <section data-section-id="team" style={style}>
                <TeamSection
                  title={getContentText("teamTitle")}
                  subtitle={getContentText("teamSubtitle")}
                  members={teamMembers}
                  variant={(previewSectionVariants.team || sectionCfg?.variant || "grid") as "grid" | "carousel" | "list"}
                />
              </section>
            );
          case "gallery":
            return (
              <section data-section-id="gallery" style={style}>
                <GallerySection
                  title={getContentText("galleryTitle")}
                  subtitle={getContentText("gallerySubtitle")}
                  images={getContentArray("galleryImages")}
                  variant={(previewSectionVariants.gallery || sectionCfg?.variant || "masonry") as "grid" | "carousel" | "masonry"}
                />
              </section>
            );
          case "brands":
            return (
              <section data-section-id="brands" style={style}>
                <BrandsSection
                  title={getContentText("brandsTitle")}
                  subtitle={getContentText("brandsSubtitle")}
                  logos={getContentArray("brandsLogos")}
                  variant={previewSectionVariants.brands || sectionCfg?.variant || "carousel"}
                />
              </section>
            );
          case "faq":
            return (
              <section data-section-id="faq" style={style}>
                <FAQSection
                  title={getContentText("faqTitle")}
                  subtitle={getContentText("faqSubtitle")}
                    items={getContentArray("faqItems")}
                  variant={(previewSectionVariants.faq || sectionCfg?.variant || "accordion") as "accordion" | "cards" | "simple"}
                />
              </section>
            );
          case "plans":
            return (
              <section data-section-id="plans" style={style}>
                <PlansSection
                  title={getContentText("plansTitle")}
                  subtitle={getContentText("plansSubtitle")}
                  variant={(previewSectionVariants.plans || sectionCfg?.variant || "cards") as "cards" | "table" | "comparison"}
                />
              </section>
            );
          case "contact":
            return (
              <section data-section-id="contact" style={style}>
                <ContactSection
                  title={getContentText("contactTitle")}
                  subtitle={getContentText("contactSubtitle")}
                  address={config.address as string | undefined}
                  phone={config.phone as string | undefined}
                  email={config.email as string | undefined}
                  webhookUrl={webhookUrl}
                  websiteId={tenant.id}
                  variant={(previewSectionVariants.contact || sectionCfg?.variant || "form") as "form" | "info"}
                />
              </section>
            );
          case "booking":
            return (
              <div data-section-id="booking" style={style}>
                <AppointmentForm
                  webhookUrl={webhookUrl}
                  websiteId={tenant.id}
                  currentUser={currentUser}
                  address={pageConfig.address}
                  phone={pageConfig.phone}
                  email={pageConfig.email}
                />
              </div>
            );
          default:
            return null;
        }
      });
    })()}
    {/* Footer - siempre renderizado para live preview */}
    {(() => {
      const footerCfg = sectionsConfig.sections.find((s) => s.id === "footer");
      const isFooterEnabled = footerCfg?.enabled ?? true;
      const footerOrder = footerCfg?.order ?? 999999;
      const footerStyle = `order: ${footerOrder}; ${!isFooterEnabled ? 'display: none;' : ''}`;

      return (
        <div data-section-id="footer" style={footerStyle}>
          <FooterComponent
            businessName={pageConfig.businessName}
            address={pageConfig.address}
            phone={pageConfig.phone}
            email={pageConfig.email}
            schedule={pageConfig.schedule}
            socialLinks={pageConfig.socialLinks}
          />
        </div>
      );
    })()}
  </main>
</Layout>
