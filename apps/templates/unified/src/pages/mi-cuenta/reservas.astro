---
import PortalLayout from "../../components/portal/PortalLayout.astro";
import { getCustomerProfile, getCustomerBookings } from "../../lib/supabase-portal";
import type { TenantData } from "../../middleware";

// Get tenant from middleware
const tenant = Astro.locals.tenant as TenantData | undefined;

if (!tenant) {
  return Astro.redirect("/");
}

// Get customer profile
const customer = await getCustomerProfile(Astro.cookies, tenant.id, Astro.request);

if (!customer) {
  return Astro.redirect("/mi-cuenta");
}

// Get bookings
const bookings = await getCustomerBookings(Astro.cookies, customer.id, Astro.request);

// Format date
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString("es-ES", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  });
};

const isSalon = tenant.businessType === "salon";

// Status badge
const getStatusBadge = (status: string) => {
  if (isSalon && status === "pending") {
    return { class: "portal-badge-confirmed", label: "Confirmada" };
  }
  const statusMap: Record<string, { class: string; label: string }> = {
    pending: { class: "portal-badge-pending", label: "Pendiente" },
    confirmed: { class: "portal-badge-confirmed", label: "Confirmada" },
    completed: { class: "portal-badge-completed", label: "Completada" },
    cancelled: { class: "portal-badge-cancelled", label: "Cancelada" },
  };
  return statusMap[status] || { class: "portal-badge-pending", label: status };
};

// Label based on business type
const getLabel = () => {
  switch (tenant.businessType) {
    case "restaurant":
      return "Mis Reservas";
    case "gym":
      return "Mis Sesiones";
    default:
      return "Mis Citas";
  }
};

const emptyText =
  tenant.businessType === "restaurant"
    ? "Aun no tienes ninguna reserva registrada."
    : tenant.businessType === "gym"
      ? "Aun no tienes ninguna sesion registrada."
      : "Aun no tienes ninguna cita registrada.";

const getBookingDateTime = (booking: CustomerBooking) => {
  const datePart = booking.booking_date;
  const timePart = booking.booking_time || "00:00";
  const dt = new Date(`${datePart}T${timePart}`);
  return Number.isNaN(dt.getTime()) ? null : dt;
};

const getEffectiveStatus = (booking: CustomerBooking) => {
  if (booking.status === "cancelled") return "cancelled";
  const dt = getBookingDateTime(booking);
  if (dt && dt < new Date()) return "completed";
  return booking.status;
};

const canCancelBooking = (booking: CustomerBooking) => {
  const status = getEffectiveStatus(booking);
  if (status === "cancelled" || status === "completed") return false;
  const dt = getBookingDateTime(booking);
  if (!dt) return false;
  const minCancelTime = new Date(Date.now() + 2 * 60 * 60 * 1000);
  return dt > minCancelTime;
};

const getCancelLabel = () => {
  switch (tenant.businessType) {
    case "restaurant":
      return "Cancelar reserva";
    case "gym":
      return "Cancelar sesion";
    default:
      return "Cancelar cita";
  }
};

// Helper to extract service name (handles both string and object formats)
const getServiceName = (service: unknown): string => {
  if (typeof service === "string") return service;
  if (service && typeof service === "object" && "name" in service) {
    return (service as { name: string }).name;
  }
  return "Servicio";
};
---

<PortalLayout title={getLabel()} tenant={tenant} customer={customer} currentPage="reservas">
  <h1 class="portal-page-title">{getLabel()}</h1>

  {bookings.length > 0 ? (
    <div class="portal-list">
      {bookings.map((booking) => {
        const badge = getStatusBadge(getEffectiveStatus(booking));
        return (
          <div class="portal-list-item">
            <div class="portal-list-item-header">
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {(booking.services || []).map((service) => (
                  <span class="salon-service-badge">{getServiceName(service)}</span>
                ))}
                {booking.services?.length === 0 && (
                  <span class="portal-list-item-title">
                    {tenant.businessType === "restaurant"
                      ? "Reserva"
                      : tenant.businessType === "gym"
                        ? "Sesion"
                        : "Cita"}
                  </span>
                )}
              </div>
              <span class={`portal-badge ${badge.class}`}>{badge.label}</span>
            </div>
            <div class="portal-list-item-meta" style="margin-top: 0.5rem;">
              {formatDate(booking.booking_date)} a las {booking.booking_time}
            </div>
            {booking.total_price_cents && booking.total_price_cents > 0 && (
              <div style="margin-top: 0.5rem; font-weight: 600; color: var(--ng-text-primary);">
                {(booking.total_price_cents / 100).toFixed(2)} EUR
              </div>
            )}
            {booking.notes && (
              <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--ng-text-secondary);">
                {booking.notes}
              </div>
            )}
            {canCancelBooking(booking) && (
              <form class="portal-action-row" method="POST" action="/mi-cuenta/cancelar">
                <input type="hidden" name="booking_id" value={booking.id} />
                <button
                  type="button"
                  class="portal-action-btn portal-action-btn-danger"
                  data-cancel-trigger
                >
                  {getCancelLabel()}
                </button>
              </form>
            )}
          </div>
        );
      })}
    </div>
  ) : (
    <div class="portal-empty">
      <svg class="portal-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <p class="portal-empty-title">Sin reservas</p>
      <p class="portal-empty-text">{emptyText}</p>
    </div>
  )}

  <div class="portal-modal-backdrop" data-cancel-backdrop style="display: none;">
    <div class="portal-modal" role="dialog" aria-modal="true" aria-labelledby="cancel-modal-title">
      <h2 id="cancel-modal-title" class="portal-modal-title">Cancelar cita</h2>
      <p class="portal-modal-text">¿Seguro que quieres cancelar esta cita?</p>
      <div class="portal-modal-actions">
        <button type="button" class="portal-action-btn" data-cancel-close>Volver</button>
        <button type="button" class="portal-action-btn portal-action-btn-danger" data-cancel-confirm>
          Confirmar cancelación
        </button>
      </div>
    </div>
  </div>

  <script is:inline>
    const backdrop = document.querySelector('[data-cancel-backdrop]');
    let activeForm = null;

    const openModal = (form) => {
      activeForm = form;
      if (backdrop) {
        backdrop.style.display = 'flex';
        document.body.classList.add('portal-modal-open');
      }
    };

    const closeModal = () => {
      if (backdrop) backdrop.style.display = 'none';
      document.body.classList.remove('portal-modal-open');
      activeForm = null;
    };

    document.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;

      const trigger = target.closest('[data-cancel-trigger]');
      if (trigger) {
        event.preventDefault();
        const form = trigger.closest('form');
        if (form) openModal(form);
        return;
      }

      if (target.closest('[data-cancel-close]')) {
        event.preventDefault();
        closeModal();
        return;
      }

      if (target.closest('[data-cancel-confirm]')) {
        event.preventDefault();
        if (activeForm) activeForm.submit();
        return;
      }

      if (backdrop && target === backdrop) {
        closeModal();
      }
    });
  </script>
</PortalLayout>
