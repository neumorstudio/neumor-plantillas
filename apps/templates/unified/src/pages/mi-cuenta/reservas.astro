---
import PortalLayout from "../../components/portal/PortalLayout.astro";
import { getCustomerProfile, getCustomerBookings } from "../../lib/supabase-portal";
import type { TenantData } from "../../middleware";

// Get tenant from middleware
const tenant = Astro.locals.tenant as TenantData | undefined;

if (!tenant) {
  return Astro.redirect("/");
}

// Get customer profile
const customer = await getCustomerProfile(Astro.cookies, tenant.id, Astro.request);

if (!customer) {
  return Astro.redirect("/mi-cuenta");
}

// Get bookings
const bookings = await getCustomerBookings(Astro.cookies, customer.id, Astro.request);

// Format date
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString("es-ES", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  });
};

const isSalon = tenant.businessType === "salon";

// Status badge
const getStatusBadge = (status: string) => {
  if (isSalon && status === "pending") {
    return { class: "portal-badge-confirmed", label: "Confirmada" };
  }
  const statusMap: Record<string, { class: string; label: string }> = {
    pending: { class: "portal-badge-pending", label: "Pendiente" },
    confirmed: { class: "portal-badge-confirmed", label: "Confirmada" },
    completed: { class: "portal-badge-completed", label: "Completada" },
    cancelled: { class: "portal-badge-cancelled", label: "Cancelada" },
  };
  return statusMap[status] || { class: "portal-badge-pending", label: status };
};

// Label based on business type
const getLabel = () => {
  switch (tenant.businessType) {
    case "restaurant":
      return "Mis Reservas";
    case "gym":
      return "Mis Sesiones";
    default:
      return "Mis Citas";
  }
};

const emptyText =
  tenant.businessType === "restaurant"
    ? "Aun no tienes ninguna reserva registrada."
    : tenant.businessType === "gym"
      ? "Aun no tienes ninguna sesion registrada."
      : "Aun no tienes ninguna cita registrada.";

// Helper to extract service name (handles both string and object formats)
const getServiceName = (service: unknown): string => {
  if (typeof service === "string") return service;
  if (service && typeof service === "object" && "name" in service) {
    return (service as { name: string }).name;
  }
  return "Servicio";
};
---

<PortalLayout title={getLabel()} tenant={tenant} customer={customer} currentPage="reservas">
  <h1 class="portal-page-title">{getLabel()}</h1>

  {bookings.length > 0 ? (
    <div class="portal-list">
      {bookings.map((booking) => {
        const badge = getStatusBadge(booking.status);
        return (
          <div class="portal-list-item">
            <div class="portal-list-item-header">
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {(booking.services || []).map((service) => (
                  <span class="salon-service-badge">{getServiceName(service)}</span>
                ))}
                {booking.services?.length === 0 && (
                  <span class="portal-list-item-title">
                    {tenant.businessType === "restaurant"
                      ? "Reserva"
                      : tenant.businessType === "gym"
                        ? "Sesion"
                        : "Cita"}
                  </span>
                )}
              </div>
              <span class={`portal-badge ${badge.class}`}>{badge.label}</span>
            </div>
            <div class="portal-list-item-meta" style="margin-top: 0.5rem;">
              {formatDate(booking.booking_date)} a las {booking.booking_time}
            </div>
            {booking.total_price_cents && booking.total_price_cents > 0 && (
              <div style="margin-top: 0.5rem; font-weight: 600; color: var(--ng-text-primary);">
                {(booking.total_price_cents / 100).toFixed(2)} EUR
              </div>
            )}
            {booking.notes && (
              <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--ng-text-secondary);">
                {booking.notes}
              </div>
            )}
          </div>
        );
      })}
    </div>
  ) : (
    <div class="portal-empty">
      <svg class="portal-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <p class="portal-empty-title">Sin reservas</p>
      <p class="portal-empty-text">{emptyText}</p>
    </div>
  )}
</PortalLayout>
