---
import "../../styles/global.css";
import "../../styles/portal.css";
import GoogleLoginButton from "../../components/portal/GoogleLoginButton.astro";
import { createPortalClient, getCustomerProfile } from "../../lib/supabase-portal";

// Verificar si ya está autenticado
const supabase = createPortalClient(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

// Si está autenticado, redirigir al inicio
if (user) {
  const customer = await getCustomerProfile(Astro.cookies, Astro.url.host);
  if (customer) {
    return Astro.redirect("/mi-cuenta/inicio");
  }
}

const theme = "neuglass";
const themeClass = `theme-${theme}`;
---

<!doctype html>
<html lang="es" class={themeClass}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Accede a tu cuenta de cliente" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <title>Acceder | Mi Cuenta</title>
  </head>
  <body class="portal-body" style="padding-bottom: 0;">
    <div class="portal-login-container">
      <div class="portal-login-card">
        <div class="portal-login-logo">
          <!-- Dumbbell Icon -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6.5 6.5a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2V6.5Z"/>
            <path d="M12.5 6.5a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2V6.5Z"/>
            <path d="M4 10h1"/>
            <path d="M4 14h1"/>
            <path d="M19 10h1"/>
            <path d="M19 14h1"/>
            <path d="M11.5 6v12"/>
            <path d="M2 12h2"/>
            <path d="M20 12h2"/>
          </svg>
        </div>

        <h1 class="portal-login-title">Bienvenido</h1>
        <p class="portal-login-subtitle">
          Accede a tu cuenta para ver tus sesiones, progreso y más.
        </p>

        <GoogleLoginButton />

        <div style="margin-top: 1rem; text-align: center;">
          <span style="font-size: 0.875rem; color: var(--text-secondary);">¿No tienes cuenta?</span>
          <button
            id="openRegisterModal"
            style="background: none; border: none; color: var(--accent); font-size: 0.875rem; cursor: pointer; text-decoration: underline; margin-left: 0.25rem;"
          >
            Regístrate
          </button>
        </div>

        <p style="margin-top: 1.5rem; font-size: 0.75rem; color: var(--text-secondary);">
          Al continuar, aceptas nuestros términos de servicio y política de privacidad.
        </p>
      </div>

      <a href="/" style="margin-top: 2rem; font-size: 0.875rem; color: var(--text-secondary);">
        &larr; Volver al inicio
      </a>
    </div>

    <!-- Modal de Registro -->
    <div id="registerModal" class="portal-modal" style="display: none;">
      <div class="portal-modal-backdrop" id="modalBackdrop"></div>
      <div class="portal-modal-content">
        <button id="closeModal" class="portal-modal-close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>

        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
          Crear cuenta
        </h2>
        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
          Regístrate en segundos con tu cuenta de Google
        </p>

        <GoogleLoginButton text="Registrarse con Google" />

        <p style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-secondary);">
          Si ya tienes cuenta, simplemente inicia sesión con el mismo método.
        </p>
      </div>
    </div>

    <style>
      .portal-modal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .portal-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }
      .portal-modal-content {
        position: relative;
        background: var(--card-bg);
        border-radius: 1rem;
        padding: 2rem;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        text-align: center;
      }
      .portal-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.5rem;
        transition: color 0.2s;
      }
      .portal-modal-close:hover {
        color: var(--text-primary);
      }
    </style>

    <script>
      const modal = document.getElementById('registerModal');
      const openBtn = document.getElementById('openRegisterModal');
      const closeBtn = document.getElementById('closeModal');
      const backdrop = document.getElementById('modalBackdrop');

      openBtn?.addEventListener('click', () => {
        modal!.style.display = 'flex';
      });

      closeBtn?.addEventListener('click', () => {
        modal!.style.display = 'none';
      });

      backdrop?.addEventListener('click', () => {
        modal!.style.display = 'none';
      });

      // Cerrar con Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal?.style.display === 'flex') {
          modal.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
