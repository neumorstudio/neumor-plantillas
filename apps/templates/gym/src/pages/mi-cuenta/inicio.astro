---
import PortalLayout from "../../layouts/PortalLayout.astro";
import {
  getCustomerProfile,
  getCustomerSessions,
  getCustomerPackages,
  getCustomerProgress,
} from "../../lib/supabase-portal";

const currentDomain = Astro.url.host;
const request = Astro.request;

// Obtener datos del cliente
const customer = await getCustomerProfile(Astro.cookies, currentDomain, request);

// Si no hay cliente, redirigir al login
if (!customer) {
  return Astro.redirect("/mi-cuenta");
}

// Obtener datos para el dashboard
const sessions = await getCustomerSessions(Astro.cookies, currentDomain, request);
const packages = await getCustomerPackages(Astro.cookies, currentDomain, request);
const progress = await getCustomerProgress(Astro.cookies, currentDomain, request);

// Calcular estadísticas
const upcomingSessions = sessions.filter(
  (s) => s.status === "scheduled" && new Date(s.date) >= new Date()
).length;

const completedSessions = sessions.filter((s) => s.status === "completed").length;

const activePackages = packages.filter((p) => p.status === "active");
const totalSessionsRemaining = activePackages.reduce(
  (sum, p) => sum + p.sessions_remaining,
  0
);

const latestProgress = progress[0];

// Próximas sesiones (las 3 más cercanas)
const nextSessions = sessions
  .filter((s) => s.status === "scheduled" && new Date(s.date) >= new Date())
  .slice(0, 3);

// Formatear fecha
function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  return date.toLocaleDateString("es-ES", {
    weekday: "short",
    day: "numeric",
    month: "short",
  });
}
---

<PortalLayout title="Inicio" customer={customer} currentPage="inicio">
  <h1 class="portal-page-title">Hola, {customer.name.split(" ")[0]}</h1>

  <!-- Stats Grid -->
  <div class="portal-stats-grid">
    <div class="portal-stat-card">
      <div class="portal-stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </div>
      <div class="portal-stat-value">{upcomingSessions}</div>
      <div class="portal-stat-label">Próximas sesiones</div>
    </div>

    <div class="portal-stat-card">
      <div class="portal-stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="portal-stat-value">{completedSessions}</div>
      <div class="portal-stat-label">Completadas</div>
    </div>

    <div class="portal-stat-card">
      <div class="portal-stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
      </div>
      <div class="portal-stat-value">{totalSessionsRemaining}</div>
      <div class="portal-stat-label">Sesiones disponibles</div>
    </div>
  </div>

  <!-- Próximas sesiones -->
  <div class="portal-section-header">
    <h2 class="portal-section-title">Próximas sesiones</h2>
    <a href="/mi-cuenta/reservas" class="portal-section-link">Ver todas</a>
  </div>

  {nextSessions.length > 0 ? (
    <div class="portal-list">
      {nextSessions.map((session) => (
        <div class="portal-list-item">
          <div class="portal-list-item-header">
            <span class="portal-list-item-title">{session.class_name}</span>
            <span class="portal-badge portal-badge-confirmed">Programada</span>
          </div>
          <div class="portal-list-item-meta">
            {formatDate(session.date)} a las {session.time}
            {session.trainer_name && ` · ${session.trainer_name}`}
          </div>
        </div>
      ))}
    </div>
  ) : (
    <div class="portal-empty">
      <svg class="portal-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <p class="portal-empty-title">Sin sesiones programadas</p>
      <p class="portal-empty-text">
        Contacta con nosotros para programar tu próxima sesión.
      </p>
    </div>
  )}

  <!-- Último progreso -->
  {latestProgress && (
    <div style="margin-top: 2rem;">
      <div class="portal-section-header">
        <h2 class="portal-section-title">Tu progreso</h2>
        <a href="/mi-cuenta/progreso" class="portal-section-link">Ver historial</a>
      </div>

      <div class="portal-card">
        <div class="portal-card-header">
          <span class="portal-card-title">Última medición</span>
          <span style="font-size: 0.75rem; color: var(--text-secondary);">
            {formatDate(latestProgress.date)}
          </span>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
          {latestProgress.weight && (
            <div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">
                {latestProgress.weight} kg
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary);">Peso</div>
            </div>
          )}
          {latestProgress.body_fat && (
            <div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">
                {latestProgress.body_fat}%
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary);">Grasa</div>
            </div>
          )}
          {latestProgress.muscle_mass && (
            <div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">
                {latestProgress.muscle_mass} kg
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary);">Músculo</div>
            </div>
          )}
        </div>
      </div>
    </div>
  )}
</PortalLayout>
