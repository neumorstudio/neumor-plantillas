---
/**
 * NEUMORSTUDIO - Plantilla Entrenador Personal / Fitness
 *
 * Esta plantilla carga la configuracion desde Supabase automaticamente.
 * Si no hay conexion a Supabase, usa los valores por defecto.
 *
 * Variables de entorno requeridas:
 * - PUBLIC_SUPABASE_URL: URL de tu proyecto Supabase
 * - PUBLIC_SUPABASE_ANON_KEY: Clave anonima de Supabase
 * - PUBLIC_WEBSITE_ID: ID del website en la tabla websites
 *
 * Preview Mode:
 * Anadir ?preview=1 a la URL para activar el modo preview.
 * Parametros de preview:
 * - theme: Tema a previsualizar
 * - v_hero, v_classes, v_features, v_reviews, v_footer: Variantes individuales
 * - v_team, v_gallery, v_faq, v_plans, v_contact: Variantes de secciones genericas
 */

import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import ClassBookingForm from "@components/ClassBookingForm.astro";

// Importar TODAS las variantes de componentes
import { HeroClassic, HeroModern, HeroBold, HeroMinimal, HeroFullscreen, HeroSplit } from "@components/Hero";
import { ClassesTabs, ClassesGrid, ClassesList, ClassesCarousel } from "@components/Classes";
import { FeaturesCards, FeaturesIcons, FeaturesBanner } from "@components/Features";
import { FooterFull, FooterMinimal, FooterCentered } from "@components/Footer";
import { ReviewsGrid, ReviewsCarousel, ReviewsMinimal } from "@components/Reviews";
import { FAQSection, ContactSection, TeamSection, GallerySection, BrandsSection, PlansSection } from "@components/Sections";

// Importar cliente Supabase
import { getBusinessHours, getWebsiteConfig, type Theme, type WebsiteVariants, type SectionConfig, type SectionsConfig } from "@lib/supabase";

// ============================================
// PREVIEW MODE - Leer parametros de URL
// ============================================
const url = new URL(Astro.request.url);
const isPreview = url.searchParams.get("preview") === "1";

// Parametros de preview
const previewTheme = url.searchParams.get("theme") as Theme | null;
const previewVariants = {
  hero: url.searchParams.get("v_hero"),
  classes: url.searchParams.get("v_classes"),
  features: url.searchParams.get("v_features"),
  reviews: url.searchParams.get("v_reviews"),
  footer: url.searchParams.get("v_footer"),
};
const previewSectionVariants = {
  team: url.searchParams.get("v_team"),
  gallery: url.searchParams.get("v_gallery"),
  brands: url.searchParams.get("v_brands"),
  faq: url.searchParams.get("v_faq"),
  plans: url.searchParams.get("v_plans"),
  contact: url.searchParams.get("v_contact"),
};

// ============================================
// MAPEO DE VARIANTES
// ============================================
const componentMap = {
  hero: {
    classic: HeroClassic,
    modern: HeroModern,
    bold: HeroBold,
    minimal: HeroMinimal,
    fullscreen: HeroFullscreen,
    split: HeroSplit,
  },
  classes: {
    tabs: ClassesTabs,
    grid: ClassesGrid,
    list: ClassesList,
    carousel: ClassesCarousel,
  },
  features: {
    cards: FeaturesCards,
    icons: FeaturesIcons,
    banner: FeaturesBanner,
  },
  reviews: {
    grid: ReviewsGrid,
    carousel: ReviewsCarousel,
    minimal: ReviewsMinimal,
  },
  footer: {
    full: FooterFull,
    minimal: FooterMinimal,
    centered: FooterCentered,
  },
};

// ============================================
// VALORES POR DEFECTO (fallback si no hay Supabase)
// ============================================
const defaultConfig = {
  businessName: "Tu Entrenador Personal",
  theme: "light" as Theme,
  variants: {
    hero: "classic",
    classes: "tabs",
    features: "cards",
    footer: "full",
  } as WebsiteVariants,
  siteTitle: "Tu Entrenador Personal | Transforma tu vida",
  siteDescription: "Entrenamiento personalizado para alcanzar tus objetivos de fitness",
  heroTitle: "Tu transformacion empieza hoy",
  heroSubtitle: "Entrenamiento 100% personalizado. Resultados garantizados con seguimiento continuo.",
  heroImage: "https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=800&q=80",
  webhookUrl: import.meta.env.PUBLIC_ADMIN_URL
    ? `${import.meta.env.PUBLIC_ADMIN_URL}/api/entrenamientos`
    : (import.meta.env.PUBLIC_BOOKING_WEBHOOK_URL || ""),
  address: "Tu direccion aqui",
  phone: "+34 000 000 000",
  email: "hola@tuentrenador.com",
  socialLinks: {
    instagram: "#",
    facebook: "#",
    whatsapp: "#",
  } as { instagram: string; facebook: string; whatsapp: string },
};

// ============================================
// CARGAR CONFIGURACION DESDE SUPABASE
// ============================================
const websiteId = import.meta.env.PUBLIC_WEBSITE_ID;
const websiteData = await getWebsiteConfig(websiteId, url.hostname);

// Construir configuracion final mezclando Supabase + defaults
let config: typeof defaultConfig;

if (websiteData) {
  // Tenemos datos de Supabase
  const dbConfig = websiteData.config || {};

  // Merge socialLinks asegurando que todos los campos existan
  const mergedSocialLinks = {
    instagram: dbConfig.socialLinks?.instagram || defaultConfig.socialLinks.instagram,
    facebook: dbConfig.socialLinks?.facebook || defaultConfig.socialLinks.facebook,
    whatsapp: dbConfig.socialLinks?.whatsapp || defaultConfig.socialLinks.whatsapp,
  };

  config = {
    businessName: dbConfig.businessName || defaultConfig.businessName,
    theme: websiteData.theme || defaultConfig.theme,
    variants: dbConfig.variants || defaultConfig.variants,
    siteTitle: `${dbConfig.businessName || defaultConfig.businessName} | Entrenador Personal`,
    siteDescription: defaultConfig.siteDescription,
    heroTitle: dbConfig.heroTitle || defaultConfig.heroTitle,
    heroSubtitle: dbConfig.heroSubtitle || defaultConfig.heroSubtitle,
    heroImage: dbConfig.heroImage || defaultConfig.heroImage,
    webhookUrl: defaultConfig.webhookUrl,
    address: dbConfig.address || defaultConfig.address,
    phone: dbConfig.phone || defaultConfig.phone,
    email: dbConfig.email || defaultConfig.email,
    socialLinks: mergedSocialLinks,
  };

} else {
  // No hay conexion a Supabase, usar defaults
  config = defaultConfig;
}

// Extraer configuración de personalización visual
const customization = websiteData?.config ? {
  colors: websiteData.config.colors,
  primaryColor: websiteData.config.primaryColor,
  secondaryColor: websiteData.config.secondaryColor,
  typography: websiteData.config.typography,
  effects: websiteData.config.effects,
  branding: websiteData.config.branding,
  logo: websiteData.config.logo,
} : {};
const rawConfig = websiteData?.config as Record<string, unknown> | undefined;
const nestedContent = rawConfig && typeof rawConfig === "object" && rawConfig.content && typeof rawConfig.content === "object"
  ? (rawConfig.content as Record<string, unknown>)
  : undefined;
const reviewsConfig = nestedContent ? { ...rawConfig, ...nestedContent } : rawConfig;
const contentConfig = reviewsConfig;
const getContentText = (key: string) => {
  const value = contentConfig?.[key];
  if (typeof value !== "string") return undefined;
  const trimmed = value.trim();
  return trimmed.length > 0 ? trimmed : undefined;
};
const getContentArray = (key: string) => {
  const value = contentConfig?.[key];
  return Array.isArray(value) && value.length > 0 ? value : undefined;
};

// ============================================
// SELECCION DINAMICA DE COMPONENTES
// ============================================

// Determinar el tema activo (preview override > Supabase)
const activeTheme: Theme = (isPreview && previewTheme)
  ? previewTheme
  : config.theme;

// Determinar variantes: preview override > Supabase config > defaults
let selectedVariants: WebsiteVariants = config.variants;

// En modo preview, aplicar variantes individuales si se especifican
if (isPreview) {
  selectedVariants = {
    hero: (previewVariants.hero as WebsiteVariants["hero"]) || selectedVariants.hero,
    classes: (previewVariants.classes as WebsiteVariants["classes"]) || selectedVariants.classes,
    features: (previewVariants.features as WebsiteVariants["features"]) || selectedVariants.features,
    reviews: (previewVariants.reviews as WebsiteVariants["reviews"]) || selectedVariants.reviews,
    footer: (previewVariants.footer as WebsiteVariants["footer"]) || selectedVariants.footer,
  };
}

// Seleccionar componentes segun la configuracion
const Hero = componentMap.hero[selectedVariants.hero] || HeroClassic;
const Classes = componentMap.classes[selectedVariants.classes] || ClassesTabs;
const Features = componentMap.features[selectedVariants.features] || FeaturesCards;
const ReviewsComponent = componentMap.reviews[selectedVariants.reviews] || ReviewsCarousel;
const FooterComponent = componentMap.footer[selectedVariants.footer] || FooterFull;

// Website ID para el formulario de citas
const currentWebsiteId = websiteData?.id || websiteId || "";
const businessHours = await getBusinessHours(currentWebsiteId);
const buildScheduleLabel = (hours: { is_open: boolean; open_time: string; close_time: string }[]) => {
  const openDay = hours.find((item) => item.is_open && item.open_time && item.close_time);
  if (!openDay) return "Cerrado";
  return `${openDay.open_time.slice(0, 5)} - ${openDay.close_time.slice(0, 5)}`;
};
const scheduleLabel = buildScheduleLabel(businessHours);

// ============================================
// CONFIGURACION DE SECCIONES DINAMICAS
// ============================================

// Secciones por defecto para gym/fitness
const defaultSections: SectionConfig[] = [
  { id: "hero", enabled: true, variant: "classic", order: 0 },
  { id: "features", enabled: true, variant: "cards", order: 1 },
  { id: "services", enabled: true, variant: "tabs", order: 2 },
  { id: "booking", enabled: true, variant: "classic", order: 3 },
  { id: "footer", enabled: true, variant: "full", order: 4 },
];

// Obtener sectionsConfig de la BD o usar defaults
const sectionsConfig: SectionsConfig = websiteData?.config?.sectionsConfig || {
  sections: defaultSections,
};

// Crear un mapa para acceso rapido a la configuracion de cada seccion
const sectionConfigMap = new Map(sectionsConfig.sections.map((s) => [s.id, s]));
---

<Layout
  title={config.siteTitle}
  description={config.siteDescription}
  theme={activeTheme}
  customization={customization}
>
  <Header
    businessName={config.businessName}
    logo={customization.branding?.logo || customization.logo}
    logoDisplay={(customization.branding as { logoDisplay?: "logo" | "name" } | undefined)?.logoDisplay}
  />

  <main class="sections-container" style="display: flex; flex-direction: column;">
    {(() => {
      const allSections = [
        "hero",
        "features",
        "services",
        "testimonials",
        "team",
  "gallery",
  "brands",
        "faq",
        "plans",
        "contact",
        "booking",
      ];
      const legacyEnabledSections = new Set(
        defaultSections.filter((section) => section.enabled).map((section) => section.id)
      );

      return allSections.map((sectionId) => {
        const sectionCfg = sectionConfigMap.get(sectionId);
        const isEnabled = sectionCfg?.enabled ?? legacyEnabledSections.has(sectionId);
        const order = sectionCfg?.order ?? 99;
        const style = `order: ${order}; ${!isEnabled ? 'display: none;' : ''}`;

        switch (sectionId) {
          case "hero":
            return (
              <section data-section-id="hero" style={style}>
                <Hero
                  title={config.heroTitle}
                  subtitle={config.heroSubtitle}
                  ctaText={getContentText("heroCta")}
                  backgroundImage={config.heroImage}
                  scheduleLabel={scheduleLabel}
                  address={config.address}
                  phone={config.phone}
                />
              </section>
            );
          case "features":
            return (
              <section data-section-id="features" style={style}>
                <Features />
              </section>
            );
          case "services":
            return (
              <section data-section-id="services" style={style}>
                <Classes />
              </section>
            );
          case "testimonials":
            return (
              <section data-section-id="testimonials" style={style}>
                <ReviewsComponent
                  title={reviewsConfig?.reviewsTitle as string | undefined}
                  subtitle={reviewsConfig?.reviewsSubtitle as string | undefined}
                  googleRating={reviewsConfig?.googleRating as number | undefined}
                  totalReviews={reviewsConfig?.totalReviews as number | undefined}
                />
              </section>
            );
          case "team":
            return (
              <section data-section-id="team" style={style}>
                <TeamSection
                  title={getContentText("teamTitle")}
                  subtitle={getContentText("teamSubtitle")}
                  variant={(previewSectionVariants.team || sectionCfg?.variant || "grid") as "grid" | "carousel" | "list"}
                />
              </section>
            );
          case "gallery":
            return (
              <section data-section-id="gallery" style={style}>
                <GallerySection
                  title={getContentText("galleryTitle")}
                  subtitle={getContentText("gallerySubtitle")}
                  images={getContentArray("galleryImages")}
                  variant={(previewSectionVariants.gallery || sectionCfg?.variant || "masonry") as "carousel" | "grid" | "masonry"}
                />
              </section>
            );
          case "brands":
            return (
              <section data-section-id="brands" style={style}>
                <BrandsSection
                  title={getContentText("brandsTitle")}
                  subtitle={getContentText("brandsSubtitle")}
                  logos={getContentArray("brandsLogos")}
                  variant={previewSectionVariants.brands || sectionCfg?.variant || "carousel"}
                />
              </section>
            );
          case "faq":
            return (
              <section data-section-id="faq" style={style}>
                <FAQSection
                  title={getContentText("faqTitle")}
                  subtitle={getContentText("faqSubtitle")}
                    items={getContentArray("faqItems")}
                  variant={(previewSectionVariants.faq || sectionCfg?.variant || "accordion") as "accordion" | "cards" | "simple"}
                />
              </section>
            );
          case "plans":
            return (
              <section data-section-id="plans" style={style}>
                <PlansSection
                  title={getContentText("plansTitle")}
                  subtitle={getContentText("plansSubtitle")}
                  variant={(previewSectionVariants.plans || sectionCfg?.variant || "cards") as "table" | "cards" | "comparison"}
                />
              </section>
            );
          case "contact":
            return (
              <section data-section-id="contact" style={style}>
                <ContactSection
                  title={getContentText("contactTitle")}
                  subtitle={getContentText("contactSubtitle")}
                  address={config.address}
                  phone={config.phone}
                  email={config.email}
                  webhookUrl={config.webhookUrl}
                  websiteId={currentWebsiteId}
                  variant={(previewSectionVariants.contact || sectionCfg?.variant || "form") as "form" | "info"}
                />
              </section>
            );
          case "booking":
            return (
              <section data-section-id="booking" style={style}>
                <ClassBookingForm webhookUrl={config.webhookUrl} websiteId={currentWebsiteId} />
              </section>
            );
          default:
            return null;
        }
      });
    })()}
  </main>

  {(() => {
    const footerCfg = sectionConfigMap.get("footer");
    const isFooterEnabled = footerCfg?.enabled ?? true;
    const footerOrder = footerCfg?.order ?? 100;
    const footerStyle = `order: ${footerOrder}; ${!isFooterEnabled ? 'display: none;' : ''}`;

    return (
      <div data-section-id="footer" style={footerStyle}>
        <FooterComponent
          businessName={config.businessName}
          address={config.address}
          phone={config.phone}
          email={config.email}
          socialLinks={config.socialLinks}
        />
      </div>
    );
  })()}
</Layout>
