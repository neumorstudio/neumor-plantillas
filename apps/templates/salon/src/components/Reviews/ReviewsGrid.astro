---
interface Review {
  author: string;
  avatar?: string;
  platform: "google" | "instagram" | "facebook" | "tripadvisor";
  rating?: number;
  text: string;
  date: string;
  images?: string[];
}

interface Props {
  title?: string;
  subtitle?: string;
  reviews?: Review[];
  googleRating?: number;
  totalReviews?: number;
}

const platformConfig = {
  google: {
    name: "Google",
    color: "#4285F4",
    icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>`,
  },
  instagram: {
    name: "Instagram",
    color: "#E4405F",
    icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>`,
  },
  facebook: {
    name: "Facebook",
    color: "#1877F2",
    icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>`,
  },
  tripadvisor: {
    name: "TripAdvisor",
    color: "#34E0A1",
    icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.006 4.295c-2.67 0-5.338.784-7.645 2.353H0l1.963 2.135a5.997 5.997 0 00-.896 3.141c0 3.314 2.686 6 6 6a5.97 5.97 0 003.933-1.472l1.006 1.093 1.007-1.093A5.97 5.97 0 0016.946 18c3.314 0 6-2.686 6-6 0-1.152-.324-2.23-.896-3.141L24 6.725h-4.36a14.254 14.254 0 00-7.634-2.43zm0 2.174c2.038 0 4.076.608 5.849 1.823H6.157a12.148 12.148 0 015.849-1.823zm-5.94 3.048a4.793 4.793 0 014.8 4.8 4.793 4.793 0 01-4.8 4.8 4.793 4.793 0 01-4.8-4.8 4.793 4.793 0 014.8-4.8zm11.88 0a4.793 4.793 0 014.8 4.8 4.793 4.793 0 01-4.8 4.8 4.793 4.793 0 01-4.8-4.8 4.793 4.793 0 014.8-4.8zm-11.88 1.6a3.2 3.2 0 100 6.4 3.2 3.2 0 000-6.4zm11.88 0a3.2 3.2 0 100 6.4 3.2 3.2 0 000-6.4zm-11.88 1.6a1.6 1.6 0 110 3.2 1.6 1.6 0 010-3.2zm11.88 0a1.6 1.6 0 110 3.2 1.6 1.6 0 010-3.2z"/></svg>`,
  },
};

const defaultReviews: Review[] = [
  {
    author: "Maria Garcia",
    platform: "google",
    rating: 5,
    text: "Una experiencia gastronomica increible. El solomillo Wellington estaba en su punto perfecto y el servicio fue impecable. Sin duda volveremos.",
    date: "Hace 2 dias",
  },
  {
    author: "foodie_madrid",
    platform: "instagram",
    text: "El mejor restaurante que he probado este ano. La presentacion de los platos es una obra de arte.",
    date: "Hace 1 semana",
    images: ["https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&q=80"],
  },
  {
    author: "Carlos Ruiz",
    platform: "tripadvisor",
    rating: 5,
    text: "Celebramos nuestro aniversario aqui y fue magico. El ambiente, la comida, todo perfecto. La tarta de queso es obligatoria.",
    date: "Hace 3 dias",
  },
  {
    author: "Laura Martinez",
    platform: "facebook",
    rating: 5,
    text: "Fuimos por recomendacion y no decepciono. El tartar de atun espectacular. Reservad con antelacion porque se llena rapido.",
    date: "Hace 5 dias",
  },
  {
    author: "gourmet_adventures",
    platform: "instagram",
    text: "Cada visita es una sorpresa. El menu degustacion del chef es una experiencia que hay que vivir.",
    date: "Hace 2 semanas",
    images: ["https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&q=80"],
  },
  {
    author: "Pedro Sanchez",
    platform: "google",
    rating: 4,
    text: "Muy buena comida y ambiente acogedor. El unico pero es que tuvimos que esperar un poco por la mesa, pero valio la pena.",
    date: "Hace 1 semana",
  },
];

const {
  title = "Lo Que Dicen De Nosotros",
  subtitle = "Opiniones reales de clientes en diferentes plataformas",
  reviews = defaultReviews,
  googleRating = 4.8,
  totalReviews = 324,
} = Astro.props;

// Render stars
function renderStars(rating: number): string {
  return Array(5).fill(0).map((_, i) =>
    i < rating
      ? '<span class="star filled">★</span>'
      : '<span class="star">★</span>'
  ).join('');
}
---

<section id="reviews" class="reviews-section">
  <div class="container">
    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">{title}</h2>
      <p class="section-subtitle">{subtitle}</p>

      <!-- Overall Rating Badge -->
      <div class="rating-badge neumor-card">
        <div class="rating-icon" set:html={platformConfig.google.icon} />
        <div class="rating-info">
          <div class="rating-score">
            <span class="score-value">{googleRating}</span>
            <div class="stars" set:html={renderStars(Math.round(googleRating))} />
          </div>
          <span class="review-count">{totalReviews} opiniones en Google</span>
        </div>
      </div>
    </div>

    <!-- Reviews Masonry Grid -->
    <div class="reviews-grid">
      {reviews.map((review, index) => {
        const platform = platformConfig[review.platform];
        return (
          <article
            class={`review-card neumor-card ${review.images ? 'has-image' : ''}`}
            style={`animation-delay: ${index * 100}ms`}
          >
            <!-- Platform Badge -->
            <div class="platform-badge" style={`--platform-color: ${platform.color}`}>
              <span class="platform-icon" set:html={platform.icon} />
            </div>

            <!-- Review Image (if exists) -->
            {review.images && review.images[0] && (
              <div class="review-image">
                <img src={review.images[0]} alt="Foto de la resena" loading="lazy" />
              </div>
            )}

            <!-- Review Content -->
            <div class="review-content">
              <!-- Author -->
              <div class="review-author">
                <div class="author-avatar">
                  {review.avatar
                    ? <img src={review.avatar} alt={review.author} />
                    : <span>{review.author.charAt(0).toUpperCase()}</span>
                  }
                </div>
                <div class="author-info">
                  <span class="author-name">{review.author}</span>
                  <span class="review-date">{review.date}</span>
                </div>
              </div>

              <!-- Rating (if exists) -->
              {review.rating && (
                <div class="review-rating" set:html={renderStars(review.rating)} />
              )}

              <!-- Text -->
              <p class="review-text">{review.text}</p>
            </div>
          </article>
        );
      })}
    </div>

    <!-- Platform Links -->
    <div class="platform-links">
      <span class="links-label">Ver mas opiniones en:</span>
      <div class="links-row">
        {Object.entries(platformConfig).map(([key, platform]) => (
          <a
            href="#"
            class="platform-link neumor-btn"
            style={`--platform-color: ${platform.color}`}
            title={`Ver opiniones en ${platform.name}`}
          >
            <span class="link-icon" set:html={platform.icon} />
            <span class="link-name">{platform.name}</span>
          </a>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  .reviews-section {
    padding: 6rem 0;
    position: relative;
    overflow: hidden;
  }

  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
  }

  .section-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    max-width: 500px;
    margin: 0 auto 2rem;
  }

  /* Rating Badge */
  .rating-badge {
    display: inline-flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 1rem;
  }

  .rating-icon {
    width: 32px;
    height: 32px;
    color: #4285F4;
  }

  .rating-icon :global(svg) {
    width: 100%;
    height: 100%;
  }

  .rating-info {
    text-align: left;
  }

  .rating-score {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .score-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .stars {
    display: flex;
    gap: 2px;
  }

  .star {
    color: #ddd;
    font-size: 1rem;
  }

  .star.filled {
    color: #fbbf24;
  }

  .review-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  /* Reviews Grid - Masonry-like */
  .reviews-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  /* Review Card */
  .review-card {
    padding: 0;
    border-radius: 1.25rem;
    overflow: hidden;
    position: relative;
    animation: fadeInUp 0.5s ease backwards;
    transition: transform 0.3s ease;
  }

  .review-card:hover {
    transform: translateY(-4px);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Vary card heights for masonry effect */
  .review-card:nth-child(3n+2) {
    grid-row: span 1;
  }

  .review-card.has-image {
    grid-row: span 1;
  }

  /* Platform Badge */
  .platform-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--neumor-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      3px 3px 6px var(--shadow-dark),
      -3px -3px 6px var(--shadow-light);
    z-index: 2;
  }

  .platform-icon {
    width: 18px;
    height: 18px;
    color: var(--platform-color);
  }

  .platform-icon :global(svg) {
    width: 100%;
    height: 100%;
  }

  /* Review Image */
  .review-image {
    width: 100%;
    aspect-ratio: 16/10;
    overflow: hidden;
  }

  .review-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .review-card:hover .review-image img {
    transform: scale(1.05);
  }

  /* Review Content */
  .review-content {
    padding: 1.5rem;
  }

  .review-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    overflow: hidden;
  }

  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-info {
    display: flex;
    flex-direction: column;
  }

  .author-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
  }

  .review-date {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .review-rating {
    display: flex;
    gap: 2px;
    margin-bottom: 0.75rem;
  }

  .review-rating .star {
    font-size: 0.9rem;
  }

  .review-text {
    font-size: 0.95rem;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  /* Platform Links */
  .platform-links {
    text-align: center;
  }

  .links-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  .links-row {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .platform-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    border-radius: 0.75rem;
    font-size: 0.9rem;
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.3s ease;
  }

  .platform-link:hover {
    color: var(--platform-color);
  }

  .link-icon {
    width: 18px;
    height: 18px;
    color: var(--platform-color);
  }

  .link-icon :global(svg) {
    width: 100%;
    height: 100%;
  }

  /* Responsive */
  @media (max-width: 968px) {
    .reviews-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .reviews-section {
      padding: 4rem 0;
    }

    .reviews-grid {
      grid-template-columns: 1fr;
    }

    .links-row {
      flex-direction: column;
      align-items: center;
    }

    .platform-link {
      width: 100%;
      max-width: 200px;
      justify-content: center;
    }
  }
</style>
