---
/**
 * NEUMORSTUDIO - Plantilla Salon/Peluqueria
 *
 * Esta plantilla carga la configuracion desde Supabase automaticamente.
 * Si no hay conexion a Supabase, usa los valores por defecto.
 *
 * Variables de entorno requeridas:
 * - PUBLIC_SUPABASE_URL: URL de tu proyecto Supabase
 * - PUBLIC_SUPABASE_ANON_KEY: Clave anonima de Supabase
 * - PUBLIC_WEBSITE_ID: ID del website en la tabla websites
 *
 * Preview Mode:
 * Anadir ?preview=1 a la URL para activar el modo preview.
 * Parametros de preview:
 * - theme: Tema a previsualizar
 * - v_hero, v_services, v_features, v_reviews, v_footer: Variantes individuales
 */

import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import AppointmentForm from "@components/AppointmentForm.astro";

// Importar TODAS las variantes de componentes
import { HeroClassic, HeroModern, HeroBold, HeroMinimal } from "@components/Hero";
import { ServicesTabs, ServicesGrid, ServicesList, ServicesCarousel } from "@components/Services";
import { FeaturesCards, FeaturesIcons, FeaturesBanner } from "@components/Features";
import { FooterFull, FooterMinimal, FooterCentered } from "@components/Footer";

// Importar cliente Supabase
import { getBusinessHours, getServiceCatalog, getWebsiteConfig, type Theme, type WebsiteVariants, type SectionConfig, type SectionsConfig } from "@lib/supabase";

// ============================================
// PREVIEW MODE - Leer parametros de URL
// ============================================
const url = new URL(Astro.request.url);
const isPreview = url.searchParams.get("preview") === "1";

// Parametros de preview
const previewTheme = url.searchParams.get("theme") as Theme | null;
const previewVariants = {
  hero: url.searchParams.get("v_hero"),
  services: url.searchParams.get("v_services"),
  features: url.searchParams.get("v_features"),
  footer: url.searchParams.get("v_footer"),
};

// ============================================
// MAPEO DE VARIANTES
// ============================================
const componentMap = {
  hero: {
    classic: HeroClassic,
    modern: HeroModern,
    bold: HeroBold,
    minimal: HeroMinimal,
  },
  services: {
    tabs: ServicesTabs,
    grid: ServicesGrid,
    list: ServicesList,
    carousel: ServicesCarousel,
  },
  features: {
    cards: FeaturesCards,
    icons: FeaturesIcons,
    banner: FeaturesBanner,
  },
  footer: {
    full: FooterFull,
    minimal: FooterMinimal,
    centered: FooterCentered,
  },
};

// ============================================
// VALORES POR DEFECTO (fallback si no hay Supabase)
// ============================================
const defaultConfig = {
  businessName: "Mi Salon",
  theme: "light" as Theme,
  variants: {
    hero: "classic",
    services: "tabs",
    features: "cards",
    footer: "full",
  } as WebsiteVariants,
  siteTitle: "Mi Salon | Peluqueria y Estetica",
  siteDescription: "Salon de belleza con estilo neumorfico",
  heroTitle: "Tu Estilo, Nuestra Pasion",
  heroSubtitle: "Expertos en cuidado capilar y estetica",
  heroImage: "https://images.unsplash.com/photo-1560066984-138dadb4c035?w=800&q=80",
  webhookUrl: import.meta.env.PUBLIC_ADMIN_URL
    ? `${import.meta.env.PUBLIC_ADMIN_URL}/api/citas`
    : (import.meta.env.PUBLIC_APPOINTMENT_WEBHOOK_URL || ""),
  address: "Tu direccion aqui",
  phone: "+34 000 000 000",
  email: "contacto@tusalon.com",
  socialLinks: {
    instagram: "#",
    facebook: "#",
    whatsapp: "#",
  } as { instagram: string; facebook: string; whatsapp: string },
};

// ============================================
// CARGAR CONFIGURACION DESDE SUPABASE
// ============================================
const websiteId = import.meta.env.PUBLIC_WEBSITE_ID;
const websiteData = await getWebsiteConfig(websiteId, url.hostname);

// Construir configuracion final mezclando Supabase + defaults
let config: typeof defaultConfig;

if (websiteData) {
  // Tenemos datos de Supabase
  const dbConfig = websiteData.config || {};

  // Merge socialLinks asegurando que todos los campos existan
  const mergedSocialLinks = {
    instagram: dbConfig.socialLinks?.instagram || defaultConfig.socialLinks.instagram,
    facebook: dbConfig.socialLinks?.facebook || defaultConfig.socialLinks.facebook,
    whatsapp: dbConfig.socialLinks?.whatsapp || defaultConfig.socialLinks.whatsapp,
  };

  const resolvedBusinessName =
    dbConfig.businessName ||
    dbConfig.business_name ||
    websiteData.clients?.business_name ||
    defaultConfig.businessName;

  config = {
    businessName: resolvedBusinessName,
    theme: websiteData.theme || defaultConfig.theme,
    variants: dbConfig.variants || defaultConfig.variants,
    siteTitle: `${resolvedBusinessName} | Salon`,
    siteDescription: defaultConfig.siteDescription,
    heroTitle: dbConfig.heroTitle || defaultConfig.heroTitle,
    heroSubtitle: dbConfig.heroSubtitle || defaultConfig.heroSubtitle,
    heroImage: dbConfig.heroImage || defaultConfig.heroImage,
    webhookUrl: defaultConfig.webhookUrl,
    address: dbConfig.address || websiteData.clients?.address || defaultConfig.address,
    phone: dbConfig.phone || websiteData.clients?.phone || defaultConfig.phone,
    email: dbConfig.email || websiteData.clients?.email || defaultConfig.email,
    socialLinks: mergedSocialLinks,
  };

  console.log("Configuracion cargada desde Supabase:", websiteData.domain);
} else {
  // No hay conexion a Supabase, usar defaults
  config = defaultConfig;
  console.log("Usando configuracion por defecto (Supabase no disponible)");
}

// Extraer configuración de personalización visual
const customization = websiteData?.config ? {
  colors: websiteData.config.colors,
  primaryColor: websiteData.config.primaryColor,
  secondaryColor: websiteData.config.secondaryColor,
  typography: websiteData.config.typography,
  effects: websiteData.config.effects,
  branding: websiteData.config.branding,
  logo: websiteData.config.logo,
} : {};

// ============================================
// CONFIGURACION DE SECCIONES DINAMICAS
// ============================================

// Secciones por defecto para salon (backward compatibility)
const defaultSections: SectionConfig[] = [
  { id: "hero", enabled: true, variant: "classic", order: 0 },
  { id: "features", enabled: true, variant: "cards", order: 1 },
  { id: "services", enabled: true, variant: "tabs", order: 2 },
  { id: "booking", enabled: true, variant: "classic", order: 3 },
  { id: "footer", enabled: true, variant: "full", order: 4 },
];

// Obtener sectionsConfig de la BD o usar defaults
const sectionsConfig: SectionsConfig = websiteData?.config?.sectionsConfig || {
  sections: defaultSections,
};

// DEBUG: Log para diagnosticar problemas con sectionsConfig
console.log("=== SECTIONS DEBUG ===");
console.log("Has sectionsConfig from DB:", !!websiteData?.config?.sectionsConfig);
console.log("Total sections:", sectionsConfig.sections?.length || 0);
console.log("Sections raw:", JSON.stringify(sectionsConfig.sections?.map(s => ({ id: s.id, enabled: s.enabled, order: s.order }))));

// Filtrar secciones habilitadas y ordenar por order
const enabledSections = sectionsConfig.sections
  .filter((s) => s.enabled)
  .sort((a, b) => a.order - b.order);

console.log("Enabled sections:", enabledSections.map(s => s.id).join(", "));
console.log("=== END SECTIONS DEBUG ===");

// Crear un mapa para acceso rapido a la configuracion de cada seccion
const sectionConfigMap = new Map(enabledSections.map((s) => [s.id, s]));

// Helper para verificar si una seccion esta habilitada
const isSectionEnabled = (sectionId: SectionId): boolean => {
  const sectionCfg = sectionConfigMap.get(sectionId);
  return sectionCfg?.enabled ?? false;
};

// ============================================
// SELECCION DINAMICA DE COMPONENTES
// ============================================

// Determinar el tema activo (preview override > Supabase)
const activeTheme: Theme = (isPreview && previewTheme)
  ? previewTheme
  : config.theme;

// Determinar variantes: preview override > Supabase config > defaults
let selectedVariants: WebsiteVariants = config.variants;

// En modo preview, aplicar variantes individuales si se especifican
if (isPreview) {
  selectedVariants = {
    hero: (previewVariants.hero as WebsiteVariants["hero"]) || selectedVariants.hero,
    services: (previewVariants.services as WebsiteVariants["services"]) || selectedVariants.services,
    features: (previewVariants.features as WebsiteVariants["features"]) || selectedVariants.features,
    reviews: selectedVariants.reviews,
    footer: (previewVariants.footer as WebsiteVariants["footer"]) || selectedVariants.footer,
  };
}

// Seleccionar componentes segun la configuracion
const Hero = componentMap.hero[selectedVariants.hero] || HeroClassic;
const Services = componentMap.services[selectedVariants.services] || ServicesTabs;
const Features = componentMap.features[selectedVariants.features] || FeaturesCards;
const FooterComponent = componentMap.footer[selectedVariants.footer] || FooterFull;

// Website ID para el formulario de citas
const currentWebsiteId = websiteData?.id || websiteId || "";
const serviceCatalog = await getServiceCatalog(currentWebsiteId);
const businessHours = await getBusinessHours(currentWebsiteId);
const buildScheduleLabel = (hours: { is_open: boolean; open_time: string; close_time: string }[]) => {
  const openDay = hours.find((item) => item.is_open && item.open_time && item.close_time);
  if (!openDay) return "Cerrado";
  return `${openDay.open_time.slice(0, 5)} - ${openDay.close_time.slice(0, 5)}`;
};
const scheduleLabel = buildScheduleLabel(businessHours);

// Mapa de iconos disponibles (sincronizado con FEATURE_ICONS en personalizacion-client.tsx)
const ICON_MAP: Record<string, string> = {
  scissors: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>`,
  palette: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/><path d="m9 15 3-3 3 3"/><circle cx="12" cy="10" r="2"/></svg>`,
  clock: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
  user: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
  heart: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
  star: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
  sparkles: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l1.2 3.2L9 7l-2.8 1.2L5 12l-1.2-3.8L1 7l2.8-.8L5 3z"/><path d="M16 5l1.8 4.6L22 11l-4.2 1.4L16 17l-1.8-4.6L10 11l4.2-1.4L16 5z"/></svg>`,
  hand: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2 2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>`,
  flower: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2a3 3 0 0 0 0 6 3 3 0 0 0 0 6"/><path d="M12 16a3 3 0 0 0 0 6"/><path d="M2 12a3 3 0 0 0 6 0 3 3 0 0 0 6 0"/><path d="M16 12a3 3 0 0 0 6 0"/></svg>`,
  droplet: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
  sun: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
  brush: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 4V2h-4v4h2v2h2V4z"/><path d="M14 4H6a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h8"/><path d="m14 10 3.5 10.5a1 1 0 0 1-1 1.5h-1a1 1 0 0 1-1-.5L11 10"/></svg>`,
  // Iconos adicionales para features (sincronizados con admin FEATURE_ICONS)
  calendar: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 15l2.5 2.5L16 12"/></svg>`,
  check: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
  shield: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
  award: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>`,
  users: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  home: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
  tool: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>`,
  truck: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>`,
  coffee: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
  gift: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>`,
  phone: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
};

const defaultIcon = ICON_MAP.star;

// Features se generan automáticamente desde las categorías de servicios (Admin → Servicios)
// Esto evita duplicación y confusión - solo hay UNA fuente de verdad para los servicios
const serviceFeatures = serviceCatalog.length
  ? {
      title: "Nuestros Servicios",
      subtitle: "Descubre todo lo que podemos hacer por ti",
      features: serviceCatalog.slice(0, 4).map((category) => ({
        icon: category.icon ? (ICON_MAP[category.icon] || defaultIcon) : defaultIcon,
        title: category.name,
        description: category.items.length > 0
          ? `${category.items.length} servicios disponibles`
          : "Servicios profesionales",
        link: "#services",
      })),
    }
  : undefined;

const serviceCategories = serviceCatalog.length
  ? serviceCatalog.map((category) => ({
      name: category.name,
      icon: category.icon ? (ICON_MAP[category.icon] || defaultIcon) : defaultIcon,
      items: category.items.map((item) => ({
        name: item.name,
        description: item.notes || "Servicio profesional personalizado",
        price: (item.price_cents / 100).toFixed(2),
        duration: `${item.duration_minutes} min`,
      })),
    }))
  : undefined;
---

<Layout
  title={config.siteTitle}
  description={config.siteDescription}
  theme={activeTheme}
  customization={customization}
>
  <Header
    businessName={config.businessName}
    logo={customization.branding?.logo || customization.logo}
    logoDisplay={(customization.branding as { logoDisplay?: "logo" | "name" } | undefined)?.logoDisplay}
  />

  <main>
    {/* Renderizado dinamico de secciones basado en sectionsConfig */}
    {enabledSections
      .filter((s) => s.id !== "footer") // Footer va fuera del main
      .map((section) => {
        switch (section.id) {
          case "hero":
            return (
              <Hero
                title={config.heroTitle}
                subtitle={config.heroSubtitle}
                backgroundImage={config.heroImage}
                scheduleLabel={scheduleLabel}
                address={config.address}
                phone={config.phone}
              />
            );
          case "features":
            return (
              <Features
                title={serviceFeatures?.title}
                subtitle={serviceFeatures?.subtitle}
                features={serviceFeatures?.features}
              />
            );
          case "services":
            return <Services categories={serviceCategories} />;
          case "booking":
            return (
              <AppointmentForm
                webhookUrl={config.webhookUrl}
                websiteId={currentWebsiteId}
                address={config.address}
                phone={config.phone}
                email={config.email}
              />
            );
          default:
            return null;
        }
      })}
  </main>

  {/* Footer siempre va al final si esta habilitado */}
  {isSectionEnabled("footer") && (
    <FooterComponent
      businessName={config.businessName}
      address={config.address}
      phone={config.phone}
      email={config.email}
      socialLinks={config.socialLinks}
    />
  )}
</Layout>
