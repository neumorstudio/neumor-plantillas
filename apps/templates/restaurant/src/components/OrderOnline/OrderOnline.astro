---
interface OrderItem {
  id?: string;
  name: string;
  description: string;
  price: string;
  priceCents?: number;
  tag?: string;
  image?: string;
}

interface OrderCategory {
  name: string;
  icon: string;
  items: OrderItem[];
}

interface BusinessHourRow {
  day_of_week: number;
  is_open: boolean;
  open_time: string;
  close_time: string;
}

interface SpecialDayRow {
  date: string;
  is_open: boolean;
  open_time: string | null;
  close_time: string | null;
  note: string | null;
}

interface OrdersUiConfig {
  leadTimeMinutes: number;
  slotIntervalMinutes: number;
  maxOrdersPerSlot: number;
  preparationMinutes: number;
}

interface Props {
  title?: string;
  subtitle?: string;
  categories?: OrderCategory[];
  websiteId?: string;
  orderApiUrl?: string;
  stripePublishableKey?: string;
  paymentMode?: "local" | "stripe";
  pickupStart?: string;
  pickupEnd?: string;
  businessHours?: BusinessHourRow[];
  specialDays?: SpecialDayRow[];
  ordersConfig?: OrdersUiConfig;
}

const defaultCategories: OrderCategory[] = [
  {
    name: "Entrantes",
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>`,
    items: [
      { name: "Carpaccio de Ternera", description: "Finas laminas de ternera con rucula, parmesano y aceite de trufa", price: "14", tag: "popular" },
      { name: "Burrata Fresca", description: "Con tomates cherry confitados, pesto de albahaca", price: "12" },
      { name: "Tartar de Atun", description: "Atun rojo con aguacate, sesamo y salsa ponzu", price: "16", tag: "nuevo" },
    ],
  },
  {
    name: "Principales",
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20"/></svg>`,
    items: [
      { name: "Solomillo Wellington", description: "Solomillo envuelto en hojaldre con duxelles de setas", price: "32", tag: "popular" },
      { name: "Lubina a la Espalda", description: "Lubina salvaje con verduras de temporada", price: "28" },
      { name: "Risotto de Boletus", description: "Arroz carnaroli con boletus edulis y trufa", price: "22", tag: "vegano" },
    ],
  },
  {
    name: "Postres",
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/></svg>`,
    items: [
      { name: "Tarta de Queso", description: "Nuestra famosa tarta cremosa con coulis de frutos rojos", price: "8", tag: "popular" },
      { name: "Coulant de Chocolate", description: "Bizcocho tibio de chocolate con helado de vainilla", price: "9" },
    ],
  },
];

const {
  title = "Pedido Para Recoger",
  subtitle = "Haz tu pedido en pocos pasos y paga directamente en el local al recogerlo.",
  categories = defaultCategories,
  websiteId = "",
  orderApiUrl = "",
  stripePublishableKey = "",
  paymentMode = "local",
  pickupStart = "12:00",
  pickupEnd = "22:00",
  businessHours = [],
  specialDays = [],
  ordersConfig = {
    leadTimeMinutes: 30,
    slotIntervalMinutes: 15,
    maxOrdersPerSlot: 0,
    preparationMinutes: 20,
  },
} = Astro.props;

const stripeEnabled = paymentMode === "stripe" && Boolean(stripePublishableKey);
---

<section
  id="orders"
  class="orders-section"
  data-website-id={websiteId}
  data-order-api={orderApiUrl}
  data-stripe-key={stripePublishableKey}
  data-payment-mode={stripeEnabled ? "stripe" : "local"}
  data-pickup-start={pickupStart}
  data-pickup-end={pickupEnd}
>
  <script type="application/json" data-business-hours>{JSON.stringify(businessHours)}</script>
  <script type="application/json" data-special-days>{JSON.stringify(specialDays)}</script>
  <script type="application/json" data-orders-config>{JSON.stringify(ordersConfig)}</script>
  <div class="container">
    <div class="section-header">
      <h2 class="section-title">{title}</h2>
      <p class="section-subtitle">{subtitle}</p>
      <div class="pickup-window neumor-inset">
        <span>Recogidas:</span>
        <strong>{pickupStart} - {pickupEnd}</strong>
      </div>
    </div>

    <div class="orders-grid">
      <div class="orders-menu">
        <div class="category-tabs">
          {categories.map((category, index) => (
            <button
              class={`category-tab neumor-btn ${index === 0 ? "active" : ""}`}
              data-category={index}
            >
              <span class="tab-icon" set:html={category.icon} />
              <span class="tab-name">{category.name}</span>
            </button>
          ))}
        </div>

        <div class="orders-content">
          {categories.map((category, catIndex) => (
            <div
              class={`orders-category ${catIndex === 0 ? "active" : ""}`}
              data-category-content={catIndex}
            >
              <div class="orders-list">
                {category.items.map((item, itemIndex) => (
                  <article class="order-item neumor-card" style={`animation-delay: ${itemIndex * 75}ms`}>
                    <div class="item-content">
                      <div class="item-header">
                        <h3 class="item-name">{item.name}</h3>
                        {item.tag && <span class={`item-tag tag-${item.tag}`}>{item.tag}</span>}
                      </div>
                      <p class="item-description">{item.description}</p>
                    </div>
                    <div class="item-actions">
                      <div class="item-price">
                        <span class="price-value">{item.price}</span>
                        <span class="price-currency">€</span>
                      </div>
                      <button
                        class="add-to-cart neumor-btn"
                        data-add-item
                        data-item-id={item.id || item.name}
                        data-item-name={item.name}
                        data-item-price={item.priceCents ?? Math.round(parseFloat(item.price) * 100)}
                      >
                        Anadir
                      </button>
                    </div>
                  </article>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>

      <aside class="orders-summary neumor-card">
        <div class="summary-header">
          <h3>Tu pedido</h3>
          <span class="summary-count" data-cart-count>0 items</span>
        </div>

        <div class="cart-empty" data-cart-empty>
          Aun no has anadido platos a tu carrito.
        </div>

        <ul class="cart-items" data-cart-items></ul>

        <div class="cart-total">
          <span>Total</span>
          <strong data-cart-total>0 €</strong>
        </div>

        <form class="order-form" data-order-form>
          <div class="form-group">
            <label for="order-name">Nombre</label>
            <input id="order-name" name="name" type="text" class="neumor-input" placeholder="Tu nombre" required />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="order-phone">Telefono</label>
              <input id="order-phone" name="phone" type="tel" class="neumor-input" placeholder="+34 600 000 000" required />
            </div>
            <div class="form-group">
              <label for="order-email">Email (opcional)</label>
              <input id="order-email" name="email" type="email" class="neumor-input" placeholder="tu@email.com" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="order-date">Fecha de recogida</label>
              <input id="order-date" name="pickup_date" type="date" class="neumor-input" required />
            </div>
            <div class="form-group">
              <label for="order-time">Hora de recogida</label>
              <input id="order-time" name="pickup_time" type="time" class="neumor-input" required />
            </div>
          </div>
          <div class="form-group">
            <label for="order-notes">Notas</label>
            <textarea id="order-notes" name="notes" class="neumor-input" rows="3" placeholder="Alergias, indicaciones, etc."></textarea>
          </div>
          <p class="payment-inline-note">
            Pago en el local al recoger. Sin registro.
          </p>
          <button type="submit" class="neumor-btn neumor-btn-accent" data-submit-order>
            Enviar pedido
          </button>
          <button type="button" class="neumor-btn" data-reset-intent>
            Editar pedido
          </button>
        </form>

        {stripeEnabled && (
          <div class="payment-section is-hidden" data-payment-section>
            <div id="payment-element"></div>
            <button type="button" class="neumor-btn neumor-btn-accent" data-confirm-payment>
              Pagar ahora
            </button>
            <p class="payment-note">
              Tu pago se procesa de forma segura con Stripe.
            </p>
          </div>
        )}

        <p class="order-error is-hidden" data-order-error role="alert"></p>
        <p class="order-success is-hidden" data-order-success>
          Pedido enviado. Te esperamos en tu franja de recogida.
        </p>
      </aside>
    </div>
  </div>
</section>

<style>
  .orders-section {
    padding: 6rem 0;
  }

  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
  }

  .section-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto 1.25rem;
  }

  .pickup-window {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 1.25rem;
    border-radius: 999px;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .orders-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(320px, 0.7fr);
    gap: 2.5rem;
    align-items: start;
  }

  .orders-menu {
    min-width: 0;
  }

  .category-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 2rem;
  }

  .category-tab {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.2rem;
    border-radius: 1rem;
    font-weight: 500;
  }

  .category-tab.active {
    background: var(--accent);
    color: white;
    box-shadow: 4px 4px 12px var(--shadow-dark), -2px -2px 8px var(--shadow-light);
  }

  .tab-icon {
    width: 20px;
    height: 20px;
    display: flex;
  }

  .tab-icon :global(svg) {
    width: 100%;
    height: 100%;
  }

  .orders-category {
    display: none;
    animation: fadeIn 0.4s ease;
  }

  .orders-category.active {
    display: block;
  }

  .orders-list {
    display: grid;
    gap: 1.25rem;
  }

  .order-item {
    display: flex;
    justify-content: space-between;
    gap: 1.5rem;
    padding: 1.5rem;
    border-radius: 1.25rem;
    animation: slideUp 0.5s ease backwards;
  }

  .item-content {
    flex: 1;
  }

  .item-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
  }

  .item-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
  }

  .item-tag {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.25rem 0.6rem;
    border-radius: 2rem;
  }

  .tag-popular { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
  .tag-nuevo { background: linear-gradient(135deg, #10b981, #059669); color: white; }
  .tag-vegano { background: linear-gradient(135deg, #34d399, #10b981); color: white; }

  .item-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
  }

  .item-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.75rem;
  }

  .item-price {
    display: flex;
    align-items: baseline;
    gap: 0.2rem;
    font-weight: 600;
  }

  .price-value {
    font-size: 1.4rem;
  }

  .price-currency {
    font-size: 0.9rem;
    color: var(--accent);
  }

  .add-to-cart {
    padding: 0.5rem 0.9rem;
  }

  .orders-summary {
    padding: 2rem;
    position: sticky;
    top: 110px;
  }

  .summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .summary-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .cart-empty {
    font-size: 0.9rem;
    color: var(--text-secondary);
    padding: 0.75rem 0;
  }

  .cart-items {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.75rem;
  }

  .cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 0.9rem;
    background: var(--neumor-bg);
    box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
  }

  .cart-item-info {
    flex: 1;
  }

  .cart-item-name {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0.2rem;
  }

  .cart-item-price {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .cart-item-controls {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .cart-item-controls button {
    width: 28px;
    height: 28px;
    border-radius: 0.6rem;
    padding: 0;
  }

  .cart-item-qty {
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 18px;
    text-align: center;
  }

  .cart-total {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    margin: 1.5rem 0;
  }

  .order-form {
    display: grid;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .order-form button {
    width: 100%;
  }

  .payment-inline-note {
    margin: 0.25rem 0 0.25rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
  }

  .order-form [data-reset-intent] {
    display: none;
  }

  .payment-section {
    display: grid;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .payment-note {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-align: center;
  }

  .order-error {
    color: #dc2626;
    font-size: 0.9rem;
    text-align: center;
    margin-top: 0.5rem;
  }

  .order-success {
    color: #059669;
    font-size: 0.9rem;
    text-align: center;
    margin-top: 0.5rem;
  }

  .is-hidden {
    display: none;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 1024px) {
    .orders-grid {
      grid-template-columns: 1fr;
    }

    .orders-summary {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .order-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .item-actions {
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script src="https://js.stripe.com/v3/"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const section = document.querySelector(".orders-section");
    if (!section) return;

    const orderApiUrl = section.getAttribute("data-order-api") || "";
    const stripeKey = section.getAttribute("data-stripe-key") || "";
    const paymentMode = section.getAttribute("data-payment-mode") || "local";
    const websiteId = section.getAttribute("data-website-id") || "";
    const pickupStart = section.getAttribute("data-pickup-start") || "";
    const pickupEnd = section.getAttribute("data-pickup-end") || "";

    const parseJsonScript = (selector) => {
      const el = section.querySelector(selector);
      if (!el) return null;
      try {
        return JSON.parse(el.textContent || "null");
      } catch (err) {
        console.error("Error parsing JSON config:", err);
        return null;
      }
    };

    const businessHours = parseJsonScript("script[data-business-hours]") || [];
    const specialDays = parseJsonScript("script[data-special-days]") || [];
    const ordersConfig = parseJsonScript("script[data-orders-config]") || {};

    const leadTimeMinutes = Number(ordersConfig.leadTimeMinutes || 30);
    const stripeEnabled = paymentMode === "stripe" && Boolean(stripeKey);

    const cartItemsEl = section.querySelector("[data-cart-items]");
    const cartEmptyEl = section.querySelector("[data-cart-empty]");
    const cartTotalEl = section.querySelector("[data-cart-total]");
    const cartCountEl = section.querySelector("[data-cart-count]");
    const orderForm = section.querySelector("[data-order-form]");
    const submitBtn = section.querySelector("[data-submit-order]");
    const resetIntentBtn = section.querySelector("[data-reset-intent]");
    const paymentSection = section.querySelector("[data-payment-section]");
    const confirmPaymentBtn = section.querySelector("[data-confirm-payment]");
    const errorEl = section.querySelector("[data-order-error]");
    const successEl = section.querySelector("[data-order-success]");

    const dateInput = section.querySelector("#order-date");
    const timeInput = section.querySelector("#order-time");

    const todayStr = new Date().toISOString().split("T")[0];
    if (dateInput) {
      dateInput.min = todayStr;
      if (!dateInput.value) dateInput.value = todayStr;
    }

    const toMinutes = (value) => {
      if (!value || typeof value !== "string") return null;
      const [h, m] = value.slice(0, 5).split(":").map(Number);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h * 60 + m;
    };

    const toTimeString = (minutes) => {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
    };

    const clampWindow = (open, close) => {
      const start = toMinutes(pickupStart);
      const end = toMinutes(pickupEnd);
      if (start === null || end === null) {
        return { isOpen: true, open: pickupStart, close: pickupEnd || pickupStart };
      }
      const openMin = Math.max(open, start);
      const closeMin = Math.min(close, end);
      if (openMin >= closeMin) {
        return { isOpen: false, open: pickupStart, close: pickupEnd || pickupStart };
      }
      return { isOpen: true, open: toTimeString(openMin), close: toTimeString(closeMin) };
    };

    const getScheduleForDate = (dateStr) => {
      const date = new Date(`${dateStr}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return { isOpen: true, open: pickupStart, close: pickupEnd || pickupStart };
      }

      const special = specialDays.find((item) => item.date === dateStr);
      if (special) {
        if (!special.is_open) {
          return { isOpen: false, open: pickupStart, close: pickupEnd || pickupStart };
        }
        const openMin = toMinutes(special.open_time || pickupStart) ?? toMinutes(pickupStart) ?? 0;
        const closeMin = toMinutes(special.close_time || pickupEnd || pickupStart) ?? toMinutes(pickupEnd || pickupStart) ?? openMin + 60;
        return clampWindow(openMin, closeMin);
      }

      const dayOfWeek = date.getDay();
      const day = businessHours.find((item) => item.day_of_week === dayOfWeek);
      if (!day) {
        return { isOpen: true, open: pickupStart, close: pickupEnd || pickupStart };
      }
      if (!day.is_open) {
        return { isOpen: false, open: pickupStart, close: pickupEnd || pickupStart };
      }

      const openMin = toMinutes(day.open_time) ?? toMinutes(pickupStart) ?? 0;
      const closeMin = toMinutes(day.close_time) ?? toMinutes(pickupEnd || pickupStart) ?? openMin + 60;
      return clampWindow(openMin, closeMin);
    };

    const applyTimeBounds = () => {
      if (!timeInput || !dateInput) return;
      const schedule = getScheduleForDate(dateInput.value || todayStr);

      if (!schedule.isOpen) {
        timeInput.value = "";
        timeInput.setAttribute("disabled", "true");
        showError("No hay recogidas disponibles para esa fecha.");
        return;
      }

      timeInput.removeAttribute("disabled");
      const minWithLead = (() => {
        if (!dateInput.value || dateInput.value !== todayStr) return schedule.open;
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes() + leadTimeMinutes;
        const scheduleOpenMinutes = toMinutes(schedule.open) ?? nowMinutes;
        return nowMinutes > scheduleOpenMinutes ? toTimeString(nowMinutes) : schedule.open;
      })();

      timeInput.min = minWithLead;
      timeInput.max = schedule.close || schedule.open;
      const currentMinutes = toMinutes(timeInput.value || "");
      const minMinutes = toMinutes(timeInput.min) ?? null;
      const maxMinutes = toMinutes(timeInput.max) ?? null;
      if (
        currentMinutes === null ||
        (minMinutes !== null && currentMinutes < minMinutes) ||
        (maxMinutes !== null && currentMinutes > maxMinutes)
      ) {
        timeInput.value = timeInput.min;
      }
      clearError();
    };

    dateInput?.addEventListener("change", applyTimeBounds);
    applyTimeBounds();

    const cart = new Map();
    let stripe = null;
    let elements = null;
    let paymentElement = null;
    let checkoutLocked = false;

    const tabs = section.querySelectorAll(".category-tab");
    const contents = section.querySelectorAll(".orders-category");
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const categoryIndex = tab.getAttribute("data-category");
        tabs.forEach((btn) => btn.classList.remove("active"));
        tab.classList.add("active");
        contents.forEach((content) => {
          content.classList.remove("active");
          if (content.getAttribute("data-category-content") === categoryIndex) {
            content.classList.add("active");
          }
        });
      });
    });

    const formatCurrency = (value) => {
      return new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "EUR",
      }).format(value / 100);
    };

    const updateCartSummary = () => {
      const totalItems = Array.from(cart.values()).reduce((sum, item) => sum + item.quantity, 0);
      const totalAmount = Array.from(cart.values()).reduce((sum, item) => sum + item.quantity * item.price, 0);

      if (cartTotalEl) cartTotalEl.textContent = `${formatCurrency(totalAmount)}`;
      if (cartCountEl) cartCountEl.textContent = `${totalItems} items`;
      if (cartEmptyEl) cartEmptyEl.classList.toggle("is-hidden", totalItems > 0);
    };

    const renderCart = () => {
      if (!cartItemsEl) return;
      cartItemsEl.innerHTML = "";

      cart.forEach((item) => {
        const li = document.createElement("li");
        li.className = "cart-item";
        const info = document.createElement("div");
        info.className = "cart-item-info";

        const name = document.createElement("div");
        name.className = "cart-item-name";
        name.textContent = item.name;

        const price = document.createElement("div");
        price.className = "cart-item-price";
        price.textContent = formatCurrency(item.price);

        info.append(name, price);

        const controls = document.createElement("div");
        controls.className = "cart-item-controls";

        const decreaseBtn = document.createElement("button");
        decreaseBtn.type = "button";
        decreaseBtn.className = "neumor-btn";
        decreaseBtn.dataset.action = "decrease";
        decreaseBtn.dataset.itemId = item.id;
        decreaseBtn.textContent = "-";

        const quantity = document.createElement("span");
        quantity.className = "cart-item-qty";
        quantity.textContent = String(item.quantity);

        const increaseBtn = document.createElement("button");
        increaseBtn.type = "button";
        increaseBtn.className = "neumor-btn";
        increaseBtn.dataset.action = "increase";
        increaseBtn.dataset.itemId = item.id;
        increaseBtn.textContent = "+";

        controls.append(decreaseBtn, quantity, increaseBtn);
        li.append(info, controls);
        cartItemsEl.appendChild(li);
      });

      updateCartSummary();
    };

    const addItem = (item) => {
      if (checkoutLocked) return;
      const existing = cart.get(item.id);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.set(item.id, { ...item, quantity: 1 });
      }
      renderCart();
    };

    const changeQuantity = (id, delta) => {
      if (checkoutLocked) return;
      const item = cart.get(id);
      if (!item) return;
      item.quantity += delta;
      if (item.quantity <= 0) {
        cart.delete(id);
      }
      renderCart();
    };

    section.querySelectorAll("[data-add-item]").forEach((button) => {
      button.addEventListener("click", () => {
        const id = button.getAttribute("data-item-id");
        const name = button.getAttribute("data-item-name");
        const price = Number(button.getAttribute("data-item-price")) || 0;
        if (!id || !name || !price) return;
        addItem({ id, name, price });
      });
    });

    cartItemsEl?.addEventListener("click", (event) => {
      const target = event.target.closest("[data-action]");
      if (!target) return;
      const action = target.getAttribute("data-action");
      const id = target.getAttribute("data-item-id");
      if (!id) return;
      if (action === "increase") changeQuantity(id, 1);
      if (action === "decrease") changeQuantity(id, -1);
    });

    function showError(message) {
      if (!errorEl) return;
      errorEl.textContent = message;
      errorEl.classList.remove("is-hidden");
    }

    function clearError() {
      if (!errorEl) return;
      errorEl.textContent = "";
      errorEl.classList.add("is-hidden");
    }

    const showSuccess = (pickupDate, pickupTime) => {
      if (!successEl) return;
      const pickupLabel = pickupDate && pickupTime ? ` Recoge el ${pickupDate} a las ${pickupTime}.` : "";
      successEl.textContent = `Pedido enviado.${pickupLabel}`;
      successEl.classList.remove("is-hidden");
    };

    const hideSuccess = () => {
      if (!successEl) return;
      successEl.classList.add("is-hidden");
    };

    const resetCheckout = () => {
      checkoutLocked = false;
      clearError();
      hideSuccess();
      if (paymentElement) {
        paymentElement.unmount();
        paymentElement = null;
      }
      if (paymentSection) paymentSection.classList.add("is-hidden");
      if (resetIntentBtn) resetIntentBtn.style.display = "none";
      if (submitBtn) submitBtn.removeAttribute("disabled");
    };

    const lockCheckout = () => {
      checkoutLocked = true;
      if (resetIntentBtn) resetIntentBtn.style.display = "inline-flex";
    };

    resetIntentBtn?.addEventListener("click", () => {
      resetCheckout();
      renderCart();
    });

    const ensureStripeLoaded = async () => {
      if (!stripeEnabled || window.Stripe) return;
      await new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = "https://js.stripe.com/v3/";
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };

    const submitOrder = async () => {
      clearError();

      if (!orderApiUrl) {
        showError("El sistema de pedidos no esta configurado.");
        return;
      }

      if (!websiteId) {
        showError("Configura el website id antes de continuar.");
        return;
      }

      if (!cart.size) {
        showError("Anade al menos un plato para continuar.");
        return;
      }

      if (!orderForm) return;
      const formData = new FormData(orderForm);
      const name = String(formData.get("name") || "").trim();
      const phone = String(formData.get("phone") || "").trim();
      const email = String(formData.get("email") || "").trim();
      const pickupDate = String(formData.get("pickup_date") || "").trim();
      const pickupTime = String(formData.get("pickup_time") || "").trim();
      const notes = String(formData.get("notes") || "").trim();

      if (!name || !phone || !pickupDate || !pickupTime) {
        showError("Completa los datos de recogida.");
        return;
      }

      const items = Array.from(cart.values()).map((item) => ({
        id: item.id,
        quantity: item.quantity,
      }));

      submitBtn?.setAttribute("disabled", "true");

      try {
        const response = await fetch(orderApiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            website_id: websiteId,
            items,
            customer: { name, phone, email },
            pickup_date: pickupDate,
            pickup_time: pickupTime,
            notes,
          }),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || "Error al crear el pedido");
        }

        if (!stripeEnabled || !data.client_secret) {
          lockCheckout();
          showSuccess(pickupDate, pickupTime);
          return;
        }

        await ensureStripeLoaded();
        if (!window.Stripe) {
          throw new Error("Stripe no disponible");
        }
        stripe = stripe || window.Stripe(stripeKey);
        elements = stripe.elements({ clientSecret: data.client_secret });
        paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");

        if (paymentSection) paymentSection.classList.remove("is-hidden");
        lockCheckout();
      } catch (error) {
        showError(error.message || "Error al enviar el pedido");
        submitBtn?.removeAttribute("disabled");
      }
    };

    orderForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      if (checkoutLocked) return;
      submitOrder();
    });

    confirmPaymentBtn?.addEventListener("click", async () => {
      clearError();
      if (!stripe || !elements) return;

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.href,
        },
        redirect: "if_required",
      });

      if (error) {
        showError(error.message || "Error al confirmar el pago");
        return;
      }

      const pickupDate = dateInput?.value || "";
      const pickupTime = timeInput?.value || "";
      showSuccess(pickupDate, pickupTime);
    });

    updateCartSummary();
  });
</script>
