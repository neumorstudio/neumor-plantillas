---
interface OrderCategory {
  name: string;
  icon: string;
  items: Array<{
    id: string;
    name: string;
    description: string;
    price: string;
    priceCents: number;
    tag?: string;
    image?: string;
  }>;
}

interface Props {
  title?: string;
  subtitle?: string;
  categories?: OrderCategory[];
  websiteId: string;
  webhookUrl?: string;
  pickupStart?: string;
  pickupEnd?: string;
  currency?: string;
  prefillName?: string;
  prefillEmail?: string;
  prefillPhone?: string;
}

const {
  title = "Pedidos para recoger",
  subtitle = "Elige tus platos, paga online y recoge sin esperas.",
  categories = [],
  websiteId,
  webhookUrl = "",
  pickupStart,
  pickupEnd,
  currency = "EUR",
  prefillName = "",
  prefillEmail = "",
  prefillPhone = "",
} = Astro.props;

const hasMenu = categories.length > 0;
const pickupWindow = pickupStart && pickupEnd ? `${pickupStart} - ${pickupEnd}` : null;
---

<section id="orders" class="orders-section" data-orders data-website-id={websiteId} data-currency={currency}>
  {/* Toast de notificaciones */}
  <div class="order-toast" data-order-toast role="alert" aria-live="polite">
    <div class="toast-content">
      <span class="toast-icon" data-toast-icon></span>
      <span class="toast-message" data-toast-message></span>
      <button type="button" class="toast-close" data-toast-close aria-label="Cerrar notificación">×</button>
    </div>
  </div>

  <div class="container">
    <div class="section-header">
      <h2 class="section-title" data-content="ordersTitle">{title}</h2>
      <p class="section-subtitle" data-content="ordersSubtitle">{subtitle}</p>
      {pickupWindow && (
        <div class="pickup-window">
          Recogida disponible: <strong>{pickupWindow}</strong>
        </div>
      )}
    </div>

    {!hasMenu ? (
      <div class="orders-empty neumor-card">
        Todavia no hay platos disponibles para pedir.
      </div>
    ) : (
      <div class="orders-layout">
        <div class="orders-menu neumor-card">
          <div class="menu-tabs">
            {categories.map((category, index) => (
              <button
                type="button"
                class={`menu-tab neumor-btn ${index === 0 ? "active" : ""}`}
                data-category={index}
              >
                <span class="tab-icon" set:html={category.icon} />
                <span class="tab-name">{category.name}</span>
              </button>
            ))}
          </div>

          <div class="menu-content">
            {categories.map((category, catIndex) => (
              <div class={`menu-category ${catIndex === 0 ? "active" : ""}`} data-category-content={catIndex}>
                <div class="menu-grid">
                  {category.items.map((item) => (
                    <article class="menu-item neumor-card">
                      {item.image && (
                        <div class="menu-image">
                          <img src={item.image} alt={item.name} loading="lazy" />
                        </div>
                      )}
                      <div class="menu-info">
                        <div class="menu-header">
                          <h3 class="menu-name">{item.name}</h3>
                          {item.tag && <span class={`menu-tag tag-${item.tag}`}>{item.tag}</span>}
                        </div>
                        <p class="menu-description">{item.description}</p>
                      </div>
                      <div class="menu-actions">
                        <div class="menu-price">
                          <span class="price-value">{item.price}</span>
                          <span class="price-currency">€</span>
                        </div>
                        <button
                          type="button"
                          class="order-add neumor-btn"
                          data-add-item
                          data-item-id={item.id}
                          data-item-name={item.name}
                          data-item-price={item.priceCents}
                        >
                          Anadir
                        </button>
                      </div>
                    </article>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        <aside class="orders-cart neumor-card">
          <div class="cart-header">
            <h3 class="cart-title">Tu pedido</h3>
            <span class="cart-count" data-cart-count>0</span>
          </div>

          <div class="cart-empty" data-cart-empty>
            Tu carrito esta vacio.
          </div>

          <div class="cart-items" data-cart-items></div>

          <div class="cart-total">
            <span>Total</span>
            <strong data-cart-total>0.00 EUR</strong>
          </div>

          <form class="orders-form" data-webhook={webhookUrl} data-website-id={websiteId}>
            <div class="form-grid">
              <label class="form-field">
                Nombre
                <input type="text" name="name" placeholder="Tu nombre" value={prefillName} required />
              </label>
              <label class="form-field">
                Telefono
                <input type="tel" name="phone" placeholder="+34 000 000 000" value={prefillPhone} required />
              </label>
              <label class="form-field">
                Email
                <input type="email" name="email" placeholder="tucorreo@email.com" value={prefillEmail} />
              </label>
              <label class="form-field">
                Fecha de recogida
                <input type="date" name="pickupDate" required />
              </label>
              <label class="form-field">
                Hora de recogida
                <input type="time" name="pickupTime" step="900" required data-pickup-start={pickupStart} data-pickup-end={pickupEnd} />
              </label>
              <label class="form-field form-notes">
                Notas
                <textarea name="notes" rows="3" placeholder="Indicaciones para tu pedido"></textarea>
              </label>
            </div>

            <div class="order-message" data-order-message></div>

            <button type="submit" class="neumor-btn neumor-btn-accent order-submit" data-order-submit>
              Pagar y recoger
            </button>
          </form>
        </aside>
      </div>
    )}
  </div>
</section>

<style>
  .orders-section { padding: 6rem 0; }
  .section-header { text-align: center; margin-bottom: 2.5rem; }
  .section-title { font-size: clamp(2rem, 5vw, 3rem); font-weight: 700; margin-bottom: 0.75rem; color: var(--text-primary); }
  .section-subtitle { font-size: 1.05rem; color: var(--text-secondary); max-width: 560px; margin: 0 auto; }
  .pickup-window { margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary); }

  .orders-layout { display: grid; grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.6fr); gap: 2rem; align-items: start; }
  .orders-empty { padding: 2rem; text-align: center; color: var(--text-secondary); }

  .orders-menu { padding: 2rem; }
  .menu-tabs { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 2rem; }
  .menu-tab { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.65rem 1.1rem; border-radius: 999px; font-weight: 600; }
  .menu-tab.active { background: var(--accent); color: #fff; box-shadow: 4px 4px 12px var(--shadow-dark), -2px -2px 8px var(--shadow-light); }
  .tab-icon { width: 20px; height: 20px; display: flex; }
  .tab-icon :global(svg) { width: 100%; height: 100%; }

  .menu-content { position: relative; }
  .menu-category { display: none; animation: fadeIn 0.35s ease; }
  .menu-category.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
  .menu-item { display: flex; flex-direction: column; gap: 0.75rem; padding: 1.25rem; border-radius: 1.25rem; }
  .menu-image img { width: 100%; border-radius: 1rem; aspect-ratio: 4 / 3; object-fit: cover; }
  .menu-header { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
  .menu-name { font-size: 1.05rem; font-weight: 600; margin: 0; color: var(--text-primary); }
  .menu-tag { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; padding: 0.2rem 0.6rem; border-radius: 999px; background: var(--accent); color: #fff; }
  .menu-description { font-size: 0.9rem; color: var(--text-secondary); margin: 0; }
  .menu-actions { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
  .menu-price { display: flex; align-items: baseline; gap: 0.2rem; font-weight: 700; }
  .price-value { font-size: 1.2rem; color: var(--text-primary); }
  .price-currency { font-size: 0.85rem; color: var(--accent); }
  .order-add { padding: 0.5rem 0.9rem; border-radius: 0.75rem; font-size: 0.85rem; }

  .orders-cart { position: sticky; top: 100px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
  .cart-header { display: flex; align-items: center; justify-content: space-between; }
  .cart-title { margin: 0; font-size: 1.1rem; }
  .cart-count { background: var(--accent); color: #fff; border-radius: 999px; padding: 0.1rem 0.5rem; font-size: 0.8rem; }
  .cart-empty { color: var(--text-secondary); font-size: 0.9rem; }
  .cart-items { display: flex; flex-direction: column; gap: 0.75rem; }
  .cart-item { display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; padding: 0.75rem; border-radius: 0.9rem; background: var(--neumor-bg); box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light); }
  .cart-item-info { display: flex; flex-direction: column; gap: 0.2rem; }
  .cart-item-name { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
  .cart-item-price { font-size: 0.8rem; color: var(--text-secondary); }
  .cart-item-controls { display: flex; align-items: center; gap: 0.4rem; }
  .qty-btn { border: none; background: var(--neumor-bg); box-shadow: 2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); border-radius: 999px; width: 26px; height: 26px; cursor: pointer; }
  .qty-value { font-weight: 600; min-width: 20px; text-align: center; }
  .cart-item-total { font-size: 0.85rem; font-weight: 700; color: var(--text-primary); }
  .cart-remove { border: none; background: transparent; color: var(--text-secondary); cursor: pointer; }

  .cart-total { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--shadow-dark); padding-top: 0.75rem; }

  .orders-form { display: flex; flex-direction: column; gap: 1rem; }
  .form-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.75rem; }
  .form-field { display: flex; flex-direction: column; gap: 0.35rem; font-size: 0.85rem; color: var(--text-secondary); }
  .form-field input,
  .form-field textarea {
    border: none;
    border-radius: 0.75rem;
    padding: 0.7rem 0.8rem;
    background: var(--neumor-bg);
    box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
    font-size: 0.9rem;
    color: var(--text-primary);
  }
  .form-field input:focus,
  .form-field textarea:focus { outline: 2px solid rgba(var(--accent-rgb, 99, 102, 241), 0.3); }
  .form-notes { grid-column: 1 / -1; }
  .order-message { font-size: 0.85rem; color: var(--text-secondary); min-height: 1.2rem; }
  .order-message.is-error { color: #dc2626; }
  .order-message.is-success { color: #16a34a; }
  .order-submit { width: 100%; padding: 0.9rem 1rem; font-size: 1rem; }
  .order-submit:disabled { opacity: 0.7; cursor: not-allowed; }
  .order-submit .spinner {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 0.5em;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Toast de notificaciones */
  .order-toast {
    position: fixed;
    top: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(-150%);
    z-index: 10000;
    min-width: 320px;
    max-width: 90vw;
    padding: 1rem 1.25rem;
    background: var(--neumor-bg, #f0f0f3);
    border-radius: 1rem;
    box-shadow: 
      8px 8px 20px var(--shadow-dark, rgba(163,177,198,0.4)),
      -4px -4px 12px var(--shadow-light, rgba(255,255,255,0.8));
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    opacity: 0;
    pointer-events: none;
  }
  .order-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
    pointer-events: auto;
  }
  .order-toast.toast-error {
    border-left: 4px solid #dc2626;
  }
  .order-toast.toast-success {
    border-left: 4px solid #16a34a;
  }
  .toast-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .toast-icon {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.9rem;
  }
  .toast-error .toast-icon {
    background: #dc2626;
    color: white;
  }
  .toast-success .toast-icon {
    background: #16a34a;
    color: white;
  }
  .toast-message {
    flex: 1;
    font-size: 0.95rem;
    color: var(--text-primary, #1f2937);
    line-height: 1.4;
  }
  .toast-close {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    color: var(--text-secondary, #6b7280);
    font-size: 1.25rem;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
  }
  .toast-close:hover {
    background: var(--shadow-dark, rgba(163,177,198,0.2));
    color: var(--text-primary, #1f2937);
  }
  /* Banner de confirmación de pago */
  .payment-success-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .payment-success-banner.show {
    opacity: 1;
    pointer-events: auto;
  }
  .success-card {
    background: var(--neumor-bg, #f0f0f3);
    border-radius: 1.5rem;
    padding: 2.5rem;
    text-align: center;
    max-width: 400px;
    width: 100%;
    box-shadow: 
      12px 12px 30px var(--shadow-dark, rgba(163,177,198,0.4)),
      -6px -6px 20px var(--shadow-light, rgba(255,255,255,0.8));
    transform: scale(0.9);
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .payment-success-banner.show .success-card {
    transform: scale(1);
  }
  .success-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, #16a34a, #22c55e);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(22, 163, 74, 0.3);
  }
  .success-icon svg {
    width: 40px;
    height: 40px;
    color: white;
  }
  .success-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary, #1f2937);
    margin-bottom: 0.5rem;
  }
  .success-text {
    font-size: 1rem;
    color: var(--text-secondary, #6b7280);
    line-height: 1.5;
    margin-bottom: 1.5rem;
  }
  .success-close {
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 0.75rem;
    background: var(--accent, #6366f1);
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 4px 4px 12px var(--shadow-dark, rgba(163,177,198,0.4)), -2px -2px 8px var(--shadow-light, rgba(255,255,255,0.8));
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .success-close:hover {
    transform: translateY(-2px);
    box-shadow: 6px 6px 16px var(--shadow-dark, rgba(163,177,198,0.5)), -3px -3px 10px var(--shadow-light, rgba(255,255,255,0.9));
  }

  @media (max-width: 1024px) {
    .orders-layout { grid-template-columns: 1fr; }
    .orders-cart { position: static; }
  }

  @media (max-width: 640px) {
    .orders-section { padding: 4rem 0; }
    .orders-menu { padding: 1.5rem; }
    .form-grid { grid-template-columns: 1fr; }
    .menu-grid { grid-template-columns: 1fr; }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const root = document.querySelector("[data-orders]");
    if (!root) return;

    const cartItemsEl = root.querySelector("[data-cart-items]");
    const cartEmptyEl = root.querySelector("[data-cart-empty]");
    const cartTotalEl = root.querySelector("[data-cart-total]");
    const cartCountEl = root.querySelector("[data-cart-count]");
    const messageEl = root.querySelector("[data-order-message]");
    const form = root.querySelector(".orders-form");
    const submitBtn = root.querySelector("[data-order-submit]");

    if (!cartItemsEl || !cartEmptyEl || !cartTotalEl || !cartCountEl || !form || !submitBtn) return;

    const websiteId = root.getAttribute("data-website-id") || "";
    const currency = root.getAttribute("data-currency") || "EUR";
    const storageKey = `neumor-orders:${websiteId}`;

    const tabs = root.querySelectorAll(".menu-tab");
    const contents = root.querySelectorAll(".menu-category");
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const categoryIndex = tab.getAttribute("data-category");
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        contents.forEach((content) => {
          content.classList.remove("active");
          if (content.getAttribute("data-category-content") === categoryIndex) {
            content.classList.add("active");
          }
        });
      });
    });

    const formatMoney = (cents) => {
      try {
        return new Intl.NumberFormat("es-ES", {
          style: "currency",
          currency,
          minimumFractionDigits: 2,
        }).format(cents / 100);
      } catch {
        return `${(cents / 100).toFixed(2)} ${currency}`;
      }
    };

    const escapeHtml = (value) => {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    };

    const loadCart = () => {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch {
        return {};
      }
    };

    const saveCart = (cart) => {
      try {
        localStorage.setItem(storageKey, JSON.stringify(cart));
      } catch {
        // ignore
      }
    };

    let cart = loadCart();

    const updateMessage = (text, type) => {
      if (!messageEl) return;
      messageEl.textContent = text || "";
      messageEl.classList.remove("is-error", "is-success");
      if (type === "error") messageEl.classList.add("is-error");
      if (type === "success") messageEl.classList.add("is-success");
    };

    const renderCart = () => {
      const entries = Object.values(cart);
      cartItemsEl.innerHTML = "";

      if (entries.length === 0) {
        cartEmptyEl.style.display = "block";
      } else {
        cartEmptyEl.style.display = "none";
      }

      let total = 0;
      let totalItems = 0;

      entries.forEach((item) => {
        const itemTotal = item.priceCents * item.quantity;
        total += itemTotal;
        totalItems += item.quantity;

        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${escapeHtml(item.name)}</div>
            <div class="cart-item-price">${formatMoney(item.priceCents)}</div>
          </div>
          <div class="cart-item-controls">
            <button type="button" class="qty-btn" data-qty-minus="${item.id}">-</button>
            <span class="qty-value">${item.quantity}</span>
            <button type="button" class="qty-btn" data-qty-plus="${item.id}">+</button>
          </div>
          <div class="cart-item-total">${formatMoney(itemTotal)}</div>
          <button type="button" class="cart-remove" data-remove="${item.id}">x</button>
        `;
        cartItemsEl.appendChild(row);
      });

      cartTotalEl.textContent = formatMoney(total);
      cartCountEl.textContent = totalItems.toString();
      submitBtn.disabled = entries.length === 0 || !form.dataset.webhook;
    };

    const addItem = (id, name, priceCents) => {
      if (!id) return;
      if (!cart[id]) {
        cart[id] = { id, name, priceCents, quantity: 1 };
      } else {
        cart[id].quantity += 1;
      }
      saveCart(cart);
      renderCart();
    };

    const adjustQty = (id, delta) => {
      if (!cart[id]) return;
      cart[id].quantity += delta;
      if (cart[id].quantity <= 0) {
        delete cart[id];
      }
      saveCart(cart);
      renderCart();
    };

    const removeItem = (id) => {
      if (!cart[id]) return;
      delete cart[id];
      saveCart(cart);
      renderCart();
    };

    root.addEventListener("click", (event) => {
      const addBtn = event.target.closest("[data-add-item]");
      if (addBtn) {
        const id = addBtn.getAttribute("data-item-id");
        const name = addBtn.getAttribute("data-item-name") || "";
        const price = Number(addBtn.getAttribute("data-item-price"));
        if (Number.isFinite(price)) {
          addItem(id, name, price);
          updateMessage("Plato anadido al carrito.", "success");
        }
        return;
      }

      const minusBtn = event.target.closest("[data-qty-minus]");
      if (minusBtn) {
        adjustQty(minusBtn.getAttribute("data-qty-minus"), -1);
        return;
      }

      const plusBtn = event.target.closest("[data-qty-plus]");
      if (plusBtn) {
        adjustQty(plusBtn.getAttribute("data-qty-plus"), 1);
        return;
      }

      const removeBtn = event.target.closest("[data-remove]");
      if (removeBtn) {
        removeItem(removeBtn.getAttribute("data-remove"));
      }
    });

    const pickupTimeInput = form.querySelector('input[name="pickupTime"]');
    if (pickupTimeInput) {
      const start = pickupTimeInput.getAttribute("data-pickup-start");
      const end = pickupTimeInput.getAttribute("data-pickup-end");
      if (start) pickupTimeInput.setAttribute("min", start);
      if (end) pickupTimeInput.setAttribute("max", end);
    }

    const pickupDateInput = form.querySelector('input[name="pickupDate"]');
    if (pickupDateInput) {
      const today = new Date();
      const iso = today.toISOString().split("T")[0];
      pickupDateInput.setAttribute("min", iso);
    }

    // Sistema de Toast mejorado
    const toastEl = root.closest("[data-orders]")?.parentElement?.querySelector("[data-order-toast]") as HTMLElement | null;
    const toastMessageEl = toastEl?.querySelector("[data-toast-message]") as HTMLElement | null;
    const toastIconEl = toastEl?.querySelector("[data-toast-icon]") as HTMLElement | null;
    const toastCloseEl = toastEl?.querySelector("[data-toast-close]") as HTMLElement | null;
    let toastTimeout: ReturnType<typeof setTimeout> | null = null;

    const showToast = (message: string, type = "error", duration = 5000) => {
      if (!toastEl || !toastMessageEl) {
        // Fallback al mensaje inline si no hay toast
        updateMessage(message, type);
        return;
      }
      
      toastEl.classList.remove("toast-error", "toast-success", "show");
      void (toastEl as HTMLElement).offsetWidth; // Force reflow
      
      toastEl.classList.add(`toast-${type}`);
      toastMessageEl.textContent = message;
      
      if (toastIconEl) {
        toastIconEl.textContent = type === "success" ? "✓" : "!";
      }
      
      toastEl.classList.add("show");
      
      if (toastTimeout) clearTimeout(toastTimeout);
      if (duration > 0) {
        toastTimeout = setTimeout(() => {
          toastEl.classList.remove("show");
        }, duration);
      }
    };

    const hideToast = () => {
      if (toastEl) toastEl.classList.remove("show");
      if (toastTimeout) clearTimeout(toastTimeout);
    };

    toastCloseEl?.addEventListener("click", hideToast);

    // Banner de éxito de pago
    const createSuccessBanner = () => {
      const existing = document.querySelector("[data-payment-success-banner]");
      if (existing) existing.remove();

      const banner = document.createElement("div");
      banner.className = "payment-success-banner";
      banner.setAttribute("data-payment-success-banner", "");
      banner.innerHTML = `
        <div class="success-card">
          <div class="success-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <h3 class="success-title">¡Pedido confirmado!</h3>
          <p class="success-text">Tu pago se ha procesado correctamente. Te esperamos para recoger tu pedido en la fecha y hora seleccionadas.</p>
          <button type="button" class="success-close" data-success-close>Entendido</button>
        </div>
      `;
      document.body.appendChild(banner);

      const closeBtn = banner.querySelector("[data-success-close]");
      closeBtn?.addEventListener("click", () => {
        banner.classList.remove("show");
        setTimeout(() => banner.remove(), 300);
      });

      return banner;
    };

    const showSuccessBanner = () => {
      const banner = createSuccessBanner();
      requestAnimationFrame(() => {
        banner.classList.add("show");
      });
    };

    // Manejar retorno desde Stripe
    const url = new URL(window.location.href);
    const orderStatus = url.searchParams.get("order");
    if (orderStatus === "success") {
      // Limpiar carrito completamente
      cart = {};
      saveCart(cart);
      renderCart();
      
      // Mostrar banner de éxito
      showSuccessBanner();
      
      // Limpiar URL
      url.searchParams.delete("order");
      window.history.replaceState({}, document.title, url.toString());
    } else if (orderStatus === "cancel") {
      showToast("Pago cancelado. Puedes intentarlo de nuevo cuando quieras.", "error", 6000);
      url.searchParams.delete("order");
      window.history.replaceState({}, document.title, url.toString());
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      hideToast();
      updateMessage("", null);
      
      const webhookUrl = (form as HTMLFormElement).dataset.webhook;
      const websiteIdValue = (form as HTMLFormElement).dataset.websiteId;

      if (!webhookUrl || !websiteIdValue) {
        showToast("Pedidos no disponibles en este momento. Inténtalo más tarde.", "error");
        return;
      }

      // Validación: carrito vacío
      const cartEntries = Object.values(cart) as Array<{ id: string; name: string; priceCents: number; quantity: number }>;
      if (cartEntries.length === 0) {
        showToast("Añade al menos un plato a tu pedido para continuar.", "error");
        return;
      }

      // Validación: cada producto debe tener precio válido
      const invalidItems = cartEntries.filter(item => !item.priceCents || item.priceCents <= 0);
      if (invalidItems.length > 0) {
        const itemNames = invalidItems.slice(0, 2).map(i => i.name).join(", ");
        const more = invalidItems.length > 2 ? ` y ${invalidItems.length - 2} más` : "";
        showToast(`Error con: ${itemNames}${more}. Contacta con el restaurante.`, "error", 6000);
        return;
      }

      const items = cartEntries.map(item => ({
        id: item.id,
        quantity: item.quantity,
      }));

      const formData = new FormData(form as HTMLFormElement);
      const payload = {
        website_id: websiteIdValue,
        items,
        customer: {
          name: formData.get("name"),
          email: formData.get("email"),
          phone: formData.get("phone"),
        },
        pickup_date: formData.get("pickupDate"),
        pickup_time: formData.get("pickupTime"),
        notes: formData.get("notes"),
      };

      // Estado de carga
      (submitBtn as HTMLButtonElement).disabled = true;
      const originalText = submitBtn.textContent || "Pagar y recoger";
      submitBtn.innerHTML = '<span class="spinner"></span>Procesando tu pedido...';

      try {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let result = {};
        try {
          result = await response.json();
        } catch {
          result = {};
        }

        if (!response.ok) {
          // Mostrar mensaje específico del backend si existe
          const errorMessage = (result as { message?: string; error?: string }).message || (result as { message?: string; error?: string }).error || "No se pudo crear el pedido. Inténtalo de nuevo.";
          showToast(errorMessage, "error", 6000);
          (submitBtn as HTMLButtonElement).disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        if ((result as { url?: string }).url) {
          // Redirección a Stripe - el carrito se limpiará al volver con ?order=success
          window.location.href = (result as { url: string }).url;
          return;
        }

        showToast("No se pudo iniciar el pago. Por favor, inténtalo de nuevo.", "error");
      } catch (error) {
        showToast("Error de conexión. Comprueba tu internet e inténtalo de nuevo.", "error", 6000);
      } finally {
        (submitBtn as HTMLButtonElement).disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    renderCart();
  });
</script>
