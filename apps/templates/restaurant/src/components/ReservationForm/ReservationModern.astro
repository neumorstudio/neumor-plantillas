---
/**
 * ReservationModern - Single page mejorado
 * Calendario visual inline, time slots, y dise√±o premium en una sola vista
 */
interface Props {
  title?: string;
  subtitle?: string;
  webhookUrl?: string;
  websiteId?: string;
  phone?: string;
  zones?: string[];
  occasions?: { id: string; label: string; icon: string }[];
  businessHours?: { day_of_week: number; is_open: boolean; open_time: string; close_time: string }[];
  businessHourSlots?: { day_of_week: number; open_time: string; close_time: string; sort_order?: number; is_active?: boolean }[];
  specialDays?: { id?: string; date: string; is_open: boolean; open_time: string | null; close_time: string | null; note: string | null }[];
  specialDaySlots?: { special_day_id: string; open_time: string; close_time: string; sort_order?: number }[];
  bookings?: { booking_date: string; booking_time: string | null; guests: number | null; status: string }[];
  capacity?: number | null;
}

const {
  title = "Reserva tu Mesa",
  subtitle = "Elige fecha, hora y personaliza tu experiencia",
  webhookUrl = "",
  websiteId = "",
  phone = "+34 912 345 678",
  zones = ["Interior", "Terraza", "Barra"],
  occasions = [
    { id: "normal", label: "Normal", icon: "üçΩÔ∏è" },
    { id: "birthday", label: "Cumplea√±os", icon: "üéÇ" },
    { id: "anniversary", label: "Aniversario", icon: "üíï" },
    { id: "business", label: "Negocios", icon: "üíº" },
  ],
  businessHours = [],
  businessHourSlots = [],
  specialDays = [],
  specialDaySlots = [],
  bookings = [],
  capacity = null,
} = Astro.props;

---

<section id="reserve" class="section reservation-modern">
  <div class="container">
    <div class="reservation-header">
      <h2 class="reservation-title">{title}</h2>
      <p class="reservation-subtitle">{subtitle}</p>
    </div>

    <form class="reservation-grid" data-step="date" data-webhook={webhookUrl} data-website-id={websiteId}>
      <script type="application/json" data-hours>{JSON.stringify(businessHours)}</script>
      <script type="application/json" data-business-hour-slots>{JSON.stringify(businessHourSlots)}</script>
      <script type="application/json" data-special-days>{JSON.stringify(specialDays)}</script>
      <script type="application/json" data-special-day-slots>{JSON.stringify(specialDaySlots)}</script>
      <script type="application/json" data-bookings>{JSON.stringify(bookings)}</script>
      <script type="application/json" data-capacity>{JSON.stringify(capacity)}</script>
      <!-- Left Column: Date & Time -->
      <div class="reservation-datetime neumor-card">
        <!-- Mini Calendar -->
        <div class="calendar-section step-panel step-date" data-panel="date">
          <div class="calendar-header">
            <button type="button" class="calendar-nav prev-month" aria-label="Mes anterior">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <span class="calendar-month-year"></span>
            <button type="button" class="calendar-nav next-month" aria-label="Mes siguiente">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
          <div class="calendar-weekdays">
            <span>L</span><span>M</span><span>X</span><span>J</span><span>V</span><span>S</span><span>D</span>
          </div>
          <div class="calendar-days"></div>
          <input type="hidden" name="date" id="selectedDate" required />
        </div>

        <!-- Time Slots -->
        <div class="time-section step-panel step-time" data-panel="time">
          <div class="time-period">
            <h4 class="period-label">
              <span class="period-icon">‚òÄÔ∏è</span>
              Horarios disponibles
            </h4>
            <p class="time-hint">Selecciona una hora para continuar</p>
            <div class="time-grid" data-time-grid>
              
            </div>
          </div>
          <div class="time-period">
            <h4 class="period-label">
              <span class="period-icon">üåô</span>
              Cena
            </h4>
            <div class="time-grid">
              
            </div>
          </div>
          <input type="hidden" name="time" id="selectedTime" required />
        </div>
      </div>

      <!-- Right Column: Details & Contact -->
      <div class="reservation-details step-panel step-details" data-panel="details">
        <div class="summary-card neumor-inset" data-summary>
          <div class="summary-row">
            <span class="summary-label">Fecha</span>
            <strong data-summary-date>‚Äî</strong>
          </div>
          <div class="summary-row">
            <span class="summary-label">Hora</span>
            <strong data-summary-time>‚Äî</strong>
          </div>
          <div class="summary-row">
            <span class="summary-label">Personas</span>
            <strong data-summary-guests>2</strong>
          </div>
        </div>
        <!-- Guests & Zone -->
        <div class="details-card neumor-card">
          <div class="guests-zone-row">
            <!-- Guests -->
            <div class="guests-section">
              <label class="section-label">Personas</label>
              <div class="guests-selector">
                <button type="button" class="guest-btn minus" aria-label="Menos">‚àí</button>
                <span class="guest-count">2</span>
                <button type="button" class="guest-btn plus" aria-label="M√°s">+</button>
              </div>
              <input type="hidden" name="guests" value="2" />
            </div>

            <!-- Zone -->
            <div class="zone-section">
              <label class="section-label">Zona</label>
              <div class="zone-selector">
                {zones.map((zone, i) => (
                  <button type="button" class={`zone-btn ${i === 0 ? 'active' : ''}`} data-zone={zone}>
                    {zone}
                  </button>
                ))}
              </div>
              <input type="hidden" name="zone" value={zones[0]} />
            </div>
          </div>

          <!-- Occasion -->
          <div class="occasion-section">
            <label class="section-label">Ocasi√≥n</label>
            <div class="occasion-pills">
              {occasions.map((occ, i) => (
                <button type="button" class={`occasion-pill ${i === 0 ? 'active' : ''}`} data-occasion={occ.id}>
                  <span class="pill-icon">{occ.icon}</span>
                  <span class="pill-label">{occ.label}</span>
                </button>
              ))}
            </div>
            <input type="hidden" name="occasion" value="normal" />
          </div>
        </div>

        <!-- Contact Form -->
        <div class="contact-card neumor-card">
          <h3 class="card-title">Datos de contacto</h3>

          <div class="form-fields">
            <div class="form-group">
              <input type="text" name="name" class="neumor-input" placeholder="Nombre completo" required />
            </div>
            <div class="form-row">
              <div class="form-group">
                <input type="email" name="email" class="neumor-input" placeholder="Email" required />
              </div>
              <div class="form-group">
                <input type="tel" name="phone" class="neumor-input" placeholder="Tel√©fono" required />
              </div>
            </div>
            <div class="form-group">
              <textarea name="notes" class="neumor-input" rows="2" placeholder="Peticiones especiales (opcional)"></textarea>
            </div>
          </div>

          <button type="submit" class="submit-btn neumor-btn neumor-btn-accent">
            <span class="btn-content">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <span class="btn-text">Enviar reserva</span>
            </span>
            <span class="btn-loader"></span>
          </button>

          <p class="phone-note">
            <span class="phone-icon">üìû</span>
            ¬øPrefieres llamar? <a href="tel:{phone}"><span data-content="phone">{phone}</span></a>
          </p>
        </div>
      </div>
    </form>

    <!-- Success Message -->
    <div class="success-message neumor-card" style="display: none;">
      <div class="success-content">
        <div class="success-icon-wrapper">
          <svg class="success-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <h3>¬°Reserva confirmada!</h3>
        <p class="success-details">
          <span id="success-date"></span> a las <span id="success-time"></span><br/>
          <span id="success-guests"></span> en <span id="success-zone"></span>
        </p>
        <p class="success-note">Te hemos enviado un email con todos los detalles</p>
        <button type="button" class="neumor-btn new-reservation">Nueva reserva</button>
      </div>
    </div>
  </div>
</section>

<style>
  .reservation-modern {
    padding: 4rem 0;
  }

  .reservation-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .reservation-title {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .reservation-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  .reservation-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-width: 1100px;
    margin: 0 auto;
  }

  .reservation-grid .step-panel {
    transition: opacity 240ms ease, transform 240ms ease;
  }

  .reservation-grid[data-step="date"] .step-time,
  .reservation-grid[data-step="date"] .step-details {
    display: none;
  }

  .reservation-grid[data-step="time"] .step-details {
    display: none;
  }

  .reservation-grid[data-step="time"] .step-time,
  .reservation-grid[data-step="details"] .step-details {
    animation: stepFadeIn 240ms ease;
  }

  @keyframes stepFadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Left Column */
  .reservation-datetime {
    padding: 1.5rem;
  }

  /* Calendar */
  .calendar-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--shadow-dark);
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .calendar-month-year {
    font-weight: 600;
    font-size: 1rem;
  }

  .calendar-nav {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--neumor-bg);
    border: none;
    cursor: pointer;
    color: var(--text-primary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: all 0.2s;
  }

  .calendar-nav:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .calendar-nav:active {
    box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .calendar-weekdays span {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 0.25rem;
  }

  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }

  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 0.8rem;
    transition: transform 160ms ease, box-shadow 160ms ease, background-color 160ms ease, color 160ms ease, font-weight 160ms ease;
    border: none;
    background: transparent;
    color: var(--text-primary);
  }

  .calendar-day.day--active {
    cursor: pointer;
  }

  .calendar-day.day--active:hover:not(.selected) {
    background: rgba(99, 102, 241, 0.12);
    color: var(--accent);
    font-weight: 700;
    box-shadow:
      inset 0 0 0 1px rgba(99, 102, 241, 0.25),
      0 6px 12px rgba(99, 102, 241, 0.18);
  }

  .calendar-day.today {
    font-weight: 700;
    color: var(--accent);
    box-shadow: inset 0 0 0 2px var(--accent);
  }

  .calendar-day.selected {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 3px 10px rgba(var(--accent-rgb, 99, 102, 241), 0.4);
  }

  .calendar-day.disabled {
    opacity: 0.25;
    pointer-events: none;
  }

  .calendar-day.day--disabled {
    cursor: default;
  }

  .calendar-day.other-month {
    opacity: 0.25;
  }

  /* Time Slots */
  .time-section {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .period-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
  }

  .time-hint {
    margin: -0.25rem 0 0.75rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .time-section .time-period + .time-period {
    display: none;
  }

  .period-icon {
    font-size: 1rem;
  }

  .time-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  .time-btn {
    padding: 0.625rem 0.5rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: transform 160ms ease, box-shadow 160ms ease, background-color 160ms ease, color 160ms ease, font-weight 160ms ease;
  }

  .time-btn:hover:not(:disabled):not(.is-full) {
    background: rgba(99, 102, 241, 0.12);
    color: var(--accent);
    font-weight: 700;
    transform: translateY(-1px);
    box-shadow:
      4px 4px 10px var(--shadow-dark),
      -4px -4px 10px var(--shadow-light),
      0 8px 16px rgba(99, 102, 241, 0.18);
  }

  .time-btn.active {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 3px 10px rgba(var(--accent-rgb, 99, 102, 241), 0.4);
  }

  .time-btn.is-full,
  .time-btn:disabled {
    opacity: 0.45;
    cursor: not-allowed;
    box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
  }

  .time-empty {
    grid-column: 1 / -1;
    padding: 0.75rem;
    border-radius: 0.75rem;
    text-align: center;
    color: var(--text-secondary);
    background: rgba(0, 0, 0, 0.04);
  }

  /* Right Column */
  .reservation-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .summary-card {
    padding: 1rem 1.25rem;
    display: grid;
    gap: 0.5rem;
    border-radius: 1rem;
  }

  .summary-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.95rem;
  }

  .summary-label {
    color: var(--text-secondary);
  }

  .details-card,
  .contact-card {
    padding: 1.5rem;
  }

  .card-title {
    font-size: 1rem;
    margin-bottom: 1.25rem;
    color: var(--text-primary);
  }

  .section-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Guests & Zone Row */
  .guests-zone-row {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--shadow-dark);
  }

  .guests-selector {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .guest-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 1.25rem;
    font-weight: 600;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: all 0.2s;
  }

  .guest-btn:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .guest-btn:active {
    box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
  }

  .guest-count {
    font-size: 1.5rem;
    font-weight: 700;
    min-width: 40px;
    text-align: center;
    color: var(--accent);
  }

  .zone-selector {
    display: flex;
    gap: 0.5rem;
  }

  .zone-btn {
    flex: 1;
    padding: 0.625rem 0.75rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.8rem;
    background: var(--neumor-bg);
    color: var(--text-secondary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: all 0.2s;
  }

  .zone-btn:hover {
    color: var(--text-primary);
  }

  .zone-btn.active {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 3px 10px rgba(var(--accent-rgb, 99, 102, 241), 0.3);
  }

  /* Occasion Pills */
  .occasion-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .occasion-pill {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    border-radius: 2rem;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    background: var(--neumor-bg);
    color: var(--text-secondary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: all 0.2s;
  }

  .occasion-pill:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .occasion-pill.active {
    box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
    color: var(--accent);
  }

  .pill-icon {
    font-size: 0.9rem;
  }

  /* Contact Form */
  .form-fields {
    margin-bottom: 1.25rem;
  }

  .form-group {
    margin-bottom: 0.875rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.875rem;
  }

  textarea.neumor-input {
    resize: none;
    min-height: 60px;
  }

  .submit-btn {
    width: 100%;
    position: relative;
  }

  .btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .submit-btn .btn-loader {
    display: none;
  }

  .submit-btn.loading .btn-content {
    visibility: hidden;
  }

  .submit-btn.loading .btn-loader {
    display: block;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .phone-note {
    text-align: center;
    margin-top: 1rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .phone-note a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
  }

  .phone-note a:hover {
    text-decoration: underline;
  }

  .phone-icon {
    margin-right: 0.25rem;
  }

  /* Success Message */
  .success-message {
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
    padding: 3rem 2rem;
  }

  .success-icon-wrapper {
    margin-bottom: 1.5rem;
  }

  .success-icon {
    color: var(--accent);
    animation: successPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes successPop {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .success-message h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--accent);
  }

  .success-details {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  .success-note {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .reservation-grid {
      grid-template-columns: 1fr;
    }

    .reservation-title {
      font-size: 2rem;
    }
  }

  @media (max-width: 600px) {
    .guests-zone-row {
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }

    .time-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .occasion-pills {
      justify-content: center;
    }
  }
</style>

<script>
  // @ts-nocheck
  (function () {
    const form = document.querySelector('.reservation-modern .reservation-grid');
    const successMessage = document.querySelector('.reservation-modern .success-message');
    const newReservationBtn = document.querySelector('.reservation-modern .new-reservation');
    let isSubmitting = false;
    const submitBtn = document.querySelector('.reservation-modern .submit-btn');

    if (!form) return;

    const calendarDays = form.querySelector('.calendar-days');
    const monthYearDisplay = form.querySelector('.calendar-month-year');
    const prevMonthBtn = form.querySelector('.prev-month');
    const nextMonthBtn = form.querySelector('.next-month');

    const selectedDateInput = form.querySelector('#selectedDate');
    const selectedTimeInput = form.querySelector('#selectedTime');
    const guestsInput = form.querySelector('input[name="guests"]');
    const guestCountEl = form.querySelector('.guest-count');
    const timeGrid = form.querySelector('[data-time-grid]');

    const summaryDate = form.querySelector('[data-summary-date]');
    const summaryTime = form.querySelector('[data-summary-time]');
    const summaryGuests = form.querySelector('[data-summary-guests]');

    const successDate = document.getElementById('success-date');
    const successTime = document.getElementById('success-time');
    const successGuests = document.getElementById('success-guests');
    const successZone = document.getElementById('success-zone');

    const parseJsonScript = (selector, fallback) => {
      const el = form.querySelector(selector);
      if (!el) return fallback;
      try {
        const parsed = JSON.parse(el.textContent || 'null');
        return parsed ?? fallback;
      } catch (err) {
        console.error('Error parsing reservation data:', err);
        return fallback;
      }
    };

    const businessHours = parseJsonScript('script[data-hours]', []);
    const businessHourSlots = parseJsonScript('script[data-business-hour-slots]', []);
    const specialDays = parseJsonScript('script[data-special-days]', []);
    const specialDaySlots = parseJsonScript('script[data-special-day-slots]', []);
    const bookings = parseJsonScript('script[data-bookings]', []);
    const capacityRaw = parseJsonScript('script[data-capacity]', null);
    const capacityNum = Number(capacityRaw);
    const capacity = Number.isFinite(capacityNum) && capacityNum > 0 ? capacityNum : null;

    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    const slotIntervalMinutes = 30;
    const maxAdvanceDays = 90;

    let currentDate = new Date();
    let selectedDate = null;
    let selectedTime = null;
    let guestCount = Number(guestsInput?.value || 2);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const toIsoDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    const toMinutes = (value) => {
      if (!value || typeof value !== 'string') return null;
      const [h, m] = value.slice(0, 5).split(':').map(Number);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h * 60 + m;
    };
    const normalizeTime = (value) => {
      if (typeof value !== 'string') return '';
      return value.slice(0, 5);
    };
    const toTimeString = (minutes) => {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    };

    const clampToWindow = (openMin, closeMin) => {
      if (!Number.isFinite(openMin) || !Number.isFinite(closeMin) || openMin >= closeMin) {
        return null;
      }
      return { openMin, closeMin };
    };

    const buildRangesFromSlots = (slots) => {
      if (!Array.isArray(slots) || slots.length === 0) return [];
      return slots
        .map((slot) => {
          const openMin = toMinutes(slot.open_time || '');
          const closeMin = toMinutes(slot.close_time || '');
          return clampToWindow(openMin, closeMin);
        })
        .filter((range) => range !== null);
    };

    const getFallbackRangesForDay = (date) => {
      const dayOfWeek = (date.getDay() + 6) % 7;
      const day = businessHours.find((d) => d.day_of_week === dayOfWeek);
      if (!day) {
        const fallback = clampToWindow(13 * 60, 23 * 60);
        return fallback ? [fallback] : [];
      }
      if (!day.is_open) return [];
      const openMin = toMinutes(day.open_time) ?? 13 * 60;
      const closeMin = toMinutes(day.close_time) ?? 23 * 60;
      const range = clampToWindow(openMin, closeMin) ?? clampToWindow(13 * 60, 23 * 60);
      return range ? [range] : [];
    };

    const getRangesForDate = (date) => {
      const iso = toIsoDate(date);
      const special = specialDays.find((d) => d.date === iso);

      if (special) {
        if (!special.is_open) return [];
        const specialSlotRanges = buildRangesFromSlots(
          specialDaySlots
            .filter((slot) => slot.special_day_id === special.id)
            .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
        );
        if (specialSlotRanges.length) return specialSlotRanges;

        const specialOpen = toMinutes(special.open_time || '');
        const specialClose = toMinutes(special.close_time || '');
        if (specialOpen !== null && specialClose !== null) {
          const range = clampToWindow(specialOpen, specialClose);
          if (range) return [range];
        }

        return getFallbackRangesForDay(date);
      }

      const dayOfWeek = (date.getDay() + 6) % 7;
      const daySlots = businessHourSlots
        .filter((slot) => slot.day_of_week === dayOfWeek && slot.is_active !== false)
        .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
      const daySlotRanges = buildRangesFromSlots(daySlots);
      if (daySlotRanges.length) return daySlotRanges;

      return getFallbackRangesForDay(date);
    };

    const getBookingsForDate = (isoDate) =>
      bookings.filter((b) => b.booking_date === isoDate && b.status !== 'cancelled');

    const getBookedGuestsForSlot = (isoDate, time) => {
      const slotTime = normalizeTime(time);
      return getBookingsForDate(isoDate)
        .filter((b) => normalizeTime(b.booking_time || '') === slotTime)
        .reduce((sum, b) => sum + (Number(b.guests) || 2), 0);
    };

    const generateSlotsForDate = (date) => {
      const ranges = getRangesForDate(date);
      if (!ranges.length) return [];
      const isoDate = toIsoDate(date);
      const slots = [];
      ranges.forEach((range) => {
        for (let minutes = range.openMin; minutes + slotIntervalMinutes <= range.closeMin; minutes += slotIntervalMinutes) {
          const time = toTimeString(minutes);
          const bookedGuests = getBookedGuestsForSlot(isoDate, time);
          const remaining = capacity ? Math.max(0, capacity - bookedGuests) : null;
          const isFull = capacity ? remaining <= 0 : false;
          slots.push({ time, remaining, isFull });
        }
      });
      return slots;
    };

    const hasAvailability = (date) => {
      if (!date) return false;
      const maxDate = new Date(today);
      maxDate.setDate(maxDate.getDate() + maxAdvanceDays);
      if (date < today || date > maxDate) return false;
      const slots = generateSlotsForDate(date);
      if (!capacity) {
        return slots.length > 0;
      }
      const isoDate = toIsoDate(date);
      // Para el calendario, basta con que exista al menos 1 hueco
      // con capacidad restante. El ajuste por tama√±o de grupo se
      // aplica en la fase de horarios.
      return slots.some((slot) => {
        const bookedGuests = getBookedGuestsForSlot(isoDate, slot.time);
        const remaining = Math.max(0, capacity - bookedGuests);
        return remaining > 0;
      });
    };

    const setStep = (nextStep) => {
      form.dataset.step = nextStep;
      if (nextStep === 'time') {
        form.querySelector('.step-time')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      if (nextStep === 'details') {
        form.querySelector('.step-details')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    const updateSummary = () => {
      if (summaryGuests) summaryGuests.textContent = String(guestCount);
      if (selectedDate && summaryDate) {
        summaryDate.textContent = selectedDate.toLocaleDateString('es-ES', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
        });
      }
      if (summaryTime) summaryTime.textContent = selectedTime || '‚Äî';
    };

    const renderTimeSlots = () => {
      if (!timeGrid || !selectedDate) return;
      const isoDate = toIsoDate(selectedDate);
      const slots = generateSlotsForDate(selectedDate);
      timeGrid.innerHTML = '';

      const availableSlots = slots.filter((slot) => {
        if (!capacity) return true;
        const bookedGuests = getBookedGuestsForSlot(isoDate, slot.time);
        const remaining = Math.max(0, capacity - bookedGuests);
        return remaining >= guestCount;
      });

      if (availableSlots.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'time-empty';
        empty.textContent = 'No hay horarios disponibles para esa fecha.';
        timeGrid.appendChild(empty);
        return;
      }

      availableSlots.forEach((slot) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-btn';
        btn.dataset.time = slot.time;
        btn.textContent = slot.time;

        btn.addEventListener('click', () => {
          selectedTime = slot.time;
          if (selectedTimeInput) selectedTimeInput.value = selectedTime;
          timeGrid.querySelectorAll('.time-btn').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          updateSummary();
          setStep('details');
        });

        timeGrid.appendChild(btn);
      });
    };

    const renderCalendar = () => {
      if (!calendarDays || !monthYearDisplay) return;

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = (firstDay.getDay() + 6) % 7;

      calendarDays.innerHTML = '';

      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const day = document.createElement('button');
        day.type = 'button';
        day.className = 'calendar-day other-month disabled day--disabled';
        day.textContent = String(prevMonthLastDay - i);
        calendarDays.appendChild(day);
      }

      const maxDate = new Date(today);
      maxDate.setDate(maxDate.getDate() + maxAdvanceDays);

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dayDate = new Date(year, month, d);
        const isoDate = toIsoDate(dayDate);
        const day = document.createElement('button');
        day.type = 'button';
        day.className = 'calendar-day';
        day.textContent = String(d);
        day.dataset.date = isoDate;

        const invalid = dayDate < today || dayDate > maxDate || !hasAvailability(dayDate);
        if (invalid) {
          day.classList.add('disabled', 'day--disabled');
        } else {
          day.classList.add('day--active');
        }

        if (dayDate.toDateString() === today.toDateString()) day.classList.add('today');
        if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) day.classList.add('selected');

        if (!invalid) {
          day.addEventListener('click', () => {
            selectedDate = dayDate;
            if (selectedDateInput) selectedDateInput.value = isoDate;
            selectedTime = null;
            if (selectedTimeInput) selectedTimeInput.value = '';
            renderCalendar();
            renderTimeSlots();
            updateSummary();
            setStep('time');
          });
        }

        calendarDays.appendChild(day);
      }

      const totalCells = calendarDays.children.length;
      const remaining = 42 - totalCells;
      for (let i = 1; i <= remaining && totalCells + i <= 42; i++) {
        const day = document.createElement('button');
        day.type = 'button';
        day.className = 'calendar-day other-month disabled day--disabled';
        day.textContent = String(i);
        calendarDays.appendChild(day);
      }
    };

    prevMonthBtn?.addEventListener('click', () => {
      currentDate.setDate(1);
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });
    nextMonthBtn?.addEventListener('click', () => {
      currentDate.setDate(1);
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    const guestMinusBtn = form.querySelector('.guest-btn.minus');
    const guestPlusBtn = form.querySelector('.guest-btn.plus');
    guestMinusBtn?.addEventListener('click', () => {
      if (guestCount > 1) {
        guestCount -= 1;
        if (guestCountEl) guestCountEl.textContent = String(guestCount);
        if (guestsInput) guestsInput.value = String(guestCount);
        updateSummary();
        renderCalendar();
        if (selectedDate) renderTimeSlots();
      }
    });
    guestPlusBtn?.addEventListener('click', () => {
      if (guestCount < 12) {
        guestCount += 1;
        if (guestCountEl) guestCountEl.textContent = String(guestCount);
        if (guestsInput) guestsInput.value = String(guestCount);
        updateSummary();
        renderCalendar();
        if (selectedDate) renderTimeSlots();
      }
    });

    const zoneBtns = form.querySelectorAll('.zone-btn');
    const zoneInput = form.querySelector('input[name="zone"]');
    zoneBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        zoneBtns.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        if (zoneInput) zoneInput.value = btn.dataset.zone || '';
      });
    });

    const occasionPills = form.querySelectorAll('.occasion-pill');
    const occasionInput = form.querySelector('input[name="occasion"]');
    occasionPills.forEach((pill) => {
      pill.addEventListener('click', () => {
        occasionPills.forEach((p) => p.classList.remove('active'));
        pill.classList.add('active');
        if (occasionInput) occasionInput.value = pill.dataset.occasion || '';
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isSubmitting) return;
      if (!selectedDateInput?.value || !selectedTimeInput?.value) {
        setStep('date');
        return;
      }

      isSubmitting = true;
      submitBtn?.classList.add('loading');
      submitBtn?.setAttribute('disabled', 'true');

      const webhookUrl = form.dataset.webhook;
      const websiteId = form.dataset.websiteId;
      const formData = new FormData(form);
      const rawData = Object.fromEntries(formData);

      const payload = {
        website_id: websiteId,
        nombre: rawData.name,
        email: rawData.email,
        telefono: rawData.phone,
        fecha: rawData.date,
        hora: rawData.time,
        personas: Number(rawData.guests),
        zona: rawData.zone,
        ocasion: rawData.occasion,
        notas: rawData.notes,
        status: 'pending',
        source: 'website',
      };

      if (!webhookUrl) {
        submitBtn?.classList.remove('loading');
        submitBtn?.removeAttribute('disabled');
        isSubmitting = false;
        return;
      }

      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const result = await response.json();
        if (!response.ok) {
          submitBtn?.classList.remove('loading');
          alert(result.error || 'Error al enviar la reserva.');
          return;
        }

        const dateObj = new Date(String(rawData.date));
        if (successDate) {
          successDate.textContent = dateObj.toLocaleDateString('es-ES', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
          });
        }
        if (successTime) successTime.textContent = String(rawData.time);
        if (successGuests) successGuests.textContent = `${rawData.guests} personas`;
        if (successZone) successZone.textContent = String(rawData.zone || 'el restaurante');

        form.dataset.step = 'success';
        form.style.display = 'none';
        if (successMessage) successMessage.style.display = 'block';
      } catch (error) {
        console.error(error);
        alert('Error al enviar la reserva. Por favor, int√©ntalo de nuevo.');
      } finally {
        submitBtn?.classList.remove('loading');
        submitBtn?.removeAttribute('disabled');
        isSubmitting = false;
      }
    });

    newReservationBtn?.addEventListener('click', () => {
      form.style.display = 'grid';
      if (successMessage) successMessage.style.display = 'none';
      form.dataset.step = 'date';
      form.reset();
      submitBtn?.classList.remove('loading');
      submitBtn?.removeAttribute('disabled');
      isSubmitting = false;

      guestCount = 2;
      if (guestCountEl) guestCountEl.textContent = '2';
      if (guestsInput) guestsInput.value = '2';

      selectedDate = null;
      selectedTime = null;
      currentDate = new Date();
      renderCalendar();
      if (timeGrid) timeGrid.innerHTML = '';
      updateSummary();
    });

    renderCalendar();
    updateSummary();
  })();

  if (false) {
  // Calendar Logic
  const calendarDays = document.querySelector('.reservation-modern .calendar-days');
  const monthYearDisplay = document.querySelector('.reservation-modern .calendar-month-year');
  const prevMonthBtn = document.querySelector('.reservation-modern .prev-month');
  const nextMonthBtn = document.querySelector('.reservation-modern .next-month');
  const selectedDateInput = document.getElementById('selectedDate') as HTMLInputElement;

  let currentDate = new Date();
  let selectedDate: Date | null = null;

  const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

  function renderCalendar() {
    if (!calendarDays || !monthYearDisplay) return;

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = (firstDay.getDay() + 6) % 7;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    calendarDays.innerHTML = '';

    // Previous month days
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startDay - 1; i >= 0; i--) {
      const day = document.createElement('button');
      day.type = 'button';
      day.className = 'calendar-day other-month disabled';
      day.textContent = String(prevMonthLastDay - i);
      calendarDays.appendChild(day);
    }

    // Current month days
    for (let d = 1; d <= lastDay.getDate(); d++) {
      const dayDate = new Date(year, month, d);
      const day = document.createElement('button');
      day.type = 'button';
      day.className = 'calendar-day';
      day.textContent = String(d);
      day.dataset.date = dayDate.toISOString().split('T')[0];

      if (dayDate < today) {
        day.classList.add('disabled');
      }

      if (dayDate.toDateString() === today.toDateString()) {
        day.classList.add('today');
      }

      if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) {
        day.classList.add('selected');
      }

      if (!day.classList.contains('disabled')) {
        day.addEventListener('click', () => selectDate(dayDate));
      }

      calendarDays.appendChild(day);
    }

    // Next month days
    const totalCells = calendarDays.children.length;
    const remaining = 42 - totalCells;
    for (let i = 1; i <= remaining && totalCells + i <= 42; i++) {
      const day = document.createElement('button');
      day.type = 'button';
      day.className = 'calendar-day other-month disabled';
      day.textContent = String(i);
      calendarDays.appendChild(day);
    }
  }

  function selectDate(date: Date) {
    selectedDate = date;
    selectedDateInput.value = date.toISOString().split('T')[0];
    renderCalendar();
  }

  prevMonthBtn?.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });

  nextMonthBtn?.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });

  // Select today by default
  const today = new Date();
  selectDate(today);

  // Time slots
  const timeBtns = document.querySelectorAll('.reservation-modern .time-btn');
  const selectedTimeInput = document.getElementById('selectedTime') as HTMLInputElement;

  timeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      timeBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedTimeInput.value = (btn as HTMLElement).dataset.time || '';
    });
  });

  // Guests counter
  const guestMinusBtn = document.querySelector('.reservation-modern .guest-btn.minus');
  const guestPlusBtn = document.querySelector('.reservation-modern .guest-btn.plus');
  const guestCountEl = document.querySelector('.reservation-modern .guest-count') as HTMLElement;
  const guestsInput = document.querySelector('.reservation-modern input[name="guests"]') as HTMLInputElement;

  let guestCount = 2;

  guestMinusBtn?.addEventListener('click', () => {
    if (guestCount > 1) {
      guestCount--;
      guestCountEl.textContent = String(guestCount);
      guestsInput.value = String(guestCount);
    }
  });

  guestPlusBtn?.addEventListener('click', () => {
    if (guestCount < 12) {
      guestCount++;
      guestCountEl.textContent = String(guestCount);
      guestsInput.value = String(guestCount);
    }
  });

  // Zone buttons
  const zoneBtns = document.querySelectorAll('.reservation-modern .zone-btn');
  const zoneInput = document.querySelector('.reservation-modern input[name="zone"]') as HTMLInputElement;

  zoneBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      zoneBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      zoneInput.value = (btn as HTMLElement).dataset.zone || '';
    });
  });

  // Occasion pills
  const occasionPills = document.querySelectorAll('.reservation-modern .occasion-pill');
  const occasionInput = document.querySelector('.reservation-modern input[name="occasion"]') as HTMLInputElement;

  occasionPills.forEach(pill => {
    pill.addEventListener('click', () => {
      occasionPills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      occasionInput.value = (pill as HTMLElement).dataset.occasion || '';
    });
  });

  // Form submit
  const form = document.querySelector('.reservation-modern .reservation-grid') as HTMLFormElement;
  const submitBtn = document.querySelector('.reservation-modern .submit-btn') as HTMLButtonElement;
  const successMessage = document.querySelector('.reservation-modern .success-message') as HTMLElement;
  const newReservationBtn = document.querySelector('.reservation-modern .new-reservation');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!selectedDateInput.value) {
      alert('Por favor, selecciona una fecha');
      return;
    }

    submitBtn?.classList.add('loading');

    const webhookUrl = form.dataset.webhook;
    const websiteId = form.dataset.websiteId;
    const formData = new FormData(form);
    const rawData = Object.fromEntries(formData);

    const data = {
      website_id: websiteId,
      nombre: rawData.name,
      email: rawData.email,
      telefono: rawData.phone,
      fecha: rawData.date,
      hora: rawData.time,
      personas: parseInt(rawData.guests as string) || 2,
      zona: rawData.zone,
      ocasion: rawData.occasion,
      notas: rawData.notes || "",
    };

    await new Promise(resolve => setTimeout(resolve, 1200));

    if (webhookUrl) {
      try {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error("Error");
      } catch {
        submitBtn?.classList.remove('loading');
        alert("Error al enviar la reserva. Por favor, int√©ntalo de nuevo.");
        return;
      }
    }

    submitBtn?.classList.remove('loading');

    // Update success message
    const dateObj = new Date(rawData.date as string);
    document.getElementById('success-date')!.textContent = dateObj.toLocaleDateString('es-ES', {
      weekday: 'long', day: 'numeric', month: 'long'
    });
    document.getElementById('success-time')!.textContent = rawData.time as string;
    document.getElementById('success-guests')!.textContent = `${rawData.guests} personas`;
    document.getElementById('success-zone')!.textContent = rawData.zone as string;

    // Show success
    form.style.display = 'none';
    successMessage.style.display = 'block';
  });

  newReservationBtn?.addEventListener('click', () => {
    form.style.display = 'grid';
    successMessage.style.display = 'none';
    form.reset();
    guestCount = 2;
    guestCountEl.textContent = '2';
    selectDate(new Date());
    timeBtns.forEach((b, i) => b.classList.toggle('active', i === 8)); // 21:00
    zoneBtns.forEach((b, i) => b.classList.toggle('active', i === 0));
    occasionPills.forEach((p, i) => p.classList.toggle('active', i === 0));
  });
}
</script>
