---
/**
 * ReservationModal - Bot√≥n flotante + Modal elegante
 * Dise√±o minimalista con glassmorphism y animaciones
 */
interface Props {
  title?: string;
  subtitle?: string;
  webhookUrl?: string;
  websiteId?: string;
  buttonText?: string;
  zones?: string[];
}

const {
  title = "Reserva tu Mesa",
  subtitle = "Selecciona los detalles de tu visita",
  webhookUrl = "",
  websiteId = "",
  buttonText = "Reservar Mesa",
  zones = ["Interior", "Terraza", "Barra"],
} = Astro.props;

const timeSlots = [
  "13:00", "13:30", "14:00", "14:30", "15:00",
  "20:00", "20:30", "21:00", "21:30", "22:00", "22:30"
];
---

<!-- Floating Button -->
<button class="reservation-fab" aria-label="Abrir reservas" data-open-modal>
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
    <line x1="16" y1="2" x2="16" y2="6"></line>
    <line x1="8" y1="2" x2="8" y2="6"></line>
    <line x1="3" y1="10" x2="21" y2="10"></line>
  </svg>
  <span>{buttonText}</span>
</button>

<!-- Modal Overlay -->
<div class="reservation-modal-overlay" data-modal>
  <div class="reservation-modal">
    <!-- Close Button -->
    <button class="modal-close" aria-label="Cerrar" data-close-modal>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <!-- Modal Content -->
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">{title}</h2>
        <p class="modal-subtitle">{subtitle}</p>
      </div>

      <form class="modal-form" data-webhook={webhookUrl} data-website-id={websiteId}>
        <!-- Date Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">üìÖ</span>
            Fecha
          </label>
          <div class="date-quick-select">
            <button type="button" class="date-chip active" data-date="today">Hoy</button>
            <button type="button" class="date-chip" data-date="tomorrow">Ma√±ana</button>
            <button type="button" class="date-chip" data-date="custom">Otra fecha</button>
          </div>
          <input type="date" name="date" class="date-input-hidden neumor-input" />
        </div>

        <!-- Time Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">‚è∞</span>
            Hora
          </label>
          <div class="time-slots">
            {timeSlots.map((time, i) => (
              <button type="button" class={`time-slot ${i === 3 ? 'active' : ''}`} data-time={time}>
                {time}
              </button>
            ))}
          </div>
          <input type="hidden" name="time" value="14:30" />
        </div>

        <!-- Guests Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">üë•</span>
            Personas
          </label>
          <div class="guests-counter">
            <button type="button" class="counter-btn minus" aria-label="Menos">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <span class="guests-count">2</span>
            <button type="button" class="counter-btn plus" aria-label="M√°s">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
          <input type="hidden" name="guests" value="2" />
        </div>

        <!-- Zone Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">üìç</span>
            Zona
          </label>
          <div class="zone-tabs">
            {zones.map((zone, i) => (
              <button type="button" class={`zone-tab ${i === 0 ? 'active' : ''}`} data-zone={zone}>
                {zone}
              </button>
            ))}
          </div>
          <input type="hidden" name="zone" value={zones[0]} />
        </div>

        <!-- Contact Info (collapsible) -->
        <div class="form-section contact-section">
          <button type="button" class="contact-toggle">
            <span>Datos de contacto</span>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="contact-fields">
            <div class="field-row">
              <input type="text" name="name" class="neumor-input" placeholder="Nombre" required />
            </div>
            <div class="field-row two-cols">
              <input type="email" name="email" class="neumor-input" placeholder="Email" required />
              <input type="tel" name="phone" class="neumor-input" placeholder="Tel√©fono" required />
            </div>
            <div class="field-row">
              <textarea name="notes" class="neumor-input" placeholder="Peticiones especiales (opcional)" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" class="submit-btn neumor-btn neumor-btn-accent">
          <span class="btn-text">Confirmar Reserva</span>
          <span class="btn-loader"></span>
        </button>
      </form>

      <!-- Success State -->
      <div class="modal-success" style="display: none;">
        <div class="success-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h3>¬°Reserva confirmada!</h3>
        <p>Te hemos enviado un email con los detalles</p>
        <button type="button" class="neumor-btn" data-close-modal>Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden section anchor -->
<section id="reserve" style="display: none;"></section>

<style>
  /* Floating Action Button */
  .reservation-fab {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-radius: 3rem;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow:
      0 10px 40px rgba(var(--accent-rgb, 99, 102, 241), 0.4),
      0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .reservation-fab:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow:
      0 14px 50px rgba(var(--accent-rgb, 99, 102, 241), 0.5),
      0 8px 20px rgba(0, 0, 0, 0.2);
  }

  .reservation-fab:active {
    transform: translateY(-2px) scale(0.98);
  }

  .reservation-fab svg {
    flex-shrink: 0;
  }

  /* Modal Overlay */
  .reservation-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .reservation-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* Modal */
  .reservation-modal {
    position: relative;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    background: var(--neumor-bg);
    border-radius: 1.5rem;
    box-shadow:
      20px 20px 60px var(--shadow-dark),
      -20px -20px 60px var(--shadow-light);
    transform: translateY(20px) scale(0.95);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .reservation-modal-overlay.active .reservation-modal {
    transform: translateY(0) scale(1);
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--neumor-bg);
    color: var(--text-secondary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .modal-close:hover {
    color: var(--text-primary);
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .modal-content {
    padding: 2rem;
  }

  .modal-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .modal-title {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .modal-subtitle {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  /* Form Sections */
  .form-section {
    margin-bottom: 1.75rem;
  }

  .section-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
  }

  .label-icon {
    font-size: 1.1rem;
  }

  /* Date Quick Select */
  .date-quick-select {
    display: flex;
    gap: 0.5rem;
  }

  .date-chip {
    flex: 1;
    padding: 0.75rem;
    border-radius: 0.75rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.875rem;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .date-chip:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .date-chip.active {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 4px 15px rgba(var(--accent-rgb, 99, 102, 241), 0.4);
  }

  .date-input-hidden {
    display: none;
    margin-top: 0.75rem;
  }

  .date-input-hidden.visible {
    display: block;
  }

  /* Time Slots */
  .time-slots {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
  }

  .time-slot {
    padding: 0.625rem 0.5rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.8rem;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: all 0.2s;
  }

  .time-slot:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .time-slot.active {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 3px 10px rgba(var(--accent-rgb, 99, 102, 241), 0.4);
  }

  /* Guests Counter */
  .guests-counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
  }

  .counter-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .counter-btn:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .counter-btn:active {
    box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
  }

  .guests-count {
    font-size: 2rem;
    font-weight: 700;
    min-width: 60px;
    text-align: center;
    color: var(--accent);
  }

  /* Zone Tabs */
  .zone-tabs {
    display: flex;
    gap: 0.5rem;
    background: var(--neumor-bg);
    padding: 0.375rem;
    border-radius: 0.75rem;
    box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
  }

  .zone-tab {
    flex: 1;
    padding: 0.625rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.875rem;
    background: transparent;
    color: var(--text-secondary);
    transition: all 0.2s;
  }

  .zone-tab:hover {
    color: var(--text-primary);
  }

  .zone-tab.active {
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
  }

  /* Contact Section */
  .contact-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-radius: 0.75rem;
    border: none;
    cursor: pointer;
    background: var(--neumor-bg);
    color: var(--text-primary);
    font-weight: 500;
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .contact-toggle:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .toggle-icon {
    transition: transform 0.3s;
  }

  .contact-section.expanded .toggle-icon {
    transform: rotate(180deg);
  }

  .contact-fields {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }

  .contact-section.expanded .contact-fields {
    max-height: 300px;
    padding-top: 1rem;
  }

  .field-row {
    margin-bottom: 0.75rem;
  }

  .field-row.two-cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  .field-row .neumor-input {
    width: 100%;
  }

  .field-row textarea.neumor-input {
    resize: none;
  }

  /* Submit Button */
  .submit-btn {
    width: 100%;
    margin-top: 0.5rem;
    position: relative;
  }

  .submit-btn .btn-loader {
    display: none;
  }

  .submit-btn.loading .btn-text {
    visibility: hidden;
  }

  .submit-btn.loading .btn-loader {
    display: block;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Success State */
  .modal-success {
    text-align: center;
    padding: 2rem 0;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    color: var(--accent);
    animation: scaleIn 0.4s ease-out;
  }

  @keyframes scaleIn {
    from {
      transform: scale(0);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  .modal-success h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
  }

  .modal-success p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .reservation-fab {
      bottom: 1rem;
      right: 1rem;
      padding: 0.875rem 1.25rem;
    }

    .reservation-fab span {
      display: none;
    }

    .modal-content {
      padding: 1.5rem;
    }

    .time-slots {
      grid-template-columns: repeat(3, 1fr);
    }

    .field-row.two-cols {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const fab = document.querySelector('[data-open-modal]');
  const modal = document.querySelector('[data-modal]') as HTMLElement;
  const closeButtons = document.querySelectorAll('[data-close-modal]');
  const form = document.querySelector('.modal-form') as HTMLFormElement;
  const successEl = document.querySelector('.modal-success') as HTMLElement;

  // Open modal
  fab?.addEventListener('click', () => {
    modal?.classList.add('active');
    document.body.style.overflow = 'hidden';
  });

  // Close modal
  function closeModal() {
    modal?.classList.remove('active');
    document.body.style.overflow = '';
  }

  closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('active')) {
      closeModal();
    }
  });

  // Date chips
  const dateChips = document.querySelectorAll('.date-chip');
  const dateInput = document.querySelector('.date-input-hidden') as HTMLInputElement;

  function getDateString(offset: number) {
    const date = new Date();
    date.setDate(date.getDate() + offset);
    return date.toISOString().split('T')[0];
  }

  dateChips.forEach(chip => {
    chip.addEventListener('click', () => {
      dateChips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');

      const dateType = (chip as HTMLElement).dataset.date;

      if (dateType === 'today') {
        dateInput.value = getDateString(0);
        dateInput.classList.remove('visible');
      } else if (dateType === 'tomorrow') {
        dateInput.value = getDateString(1);
        dateInput.classList.remove('visible');
      } else {
        dateInput.classList.add('visible');
        dateInput.focus();
      }
    });
  });

  // Initialize with today
  dateInput.value = getDateString(0);

  // Time slots
  const timeSlots = document.querySelectorAll('.time-slot');
  const timeInput = document.querySelector('input[name="time"]') as HTMLInputElement;

  timeSlots.forEach(slot => {
    slot.addEventListener('click', () => {
      timeSlots.forEach(s => s.classList.remove('active'));
      slot.classList.add('active');
      timeInput.value = (slot as HTMLElement).dataset.time || '';
    });
  });

  // Guests counter
  const minusBtn = document.querySelector('.counter-btn.minus');
  const plusBtn = document.querySelector('.counter-btn.plus');
  const guestsCount = document.querySelector('.guests-count') as HTMLElement;
  const guestsInput = document.querySelector('input[name="guests"]') as HTMLInputElement;

  let guests = 2;

  minusBtn?.addEventListener('click', () => {
    if (guests > 1) {
      guests--;
      guestsCount.textContent = String(guests);
      guestsInput.value = String(guests);
    }
  });

  plusBtn?.addEventListener('click', () => {
    if (guests < 12) {
      guests++;
      guestsCount.textContent = String(guests);
      guestsInput.value = String(guests);
    }
  });

  // Zone tabs
  const zoneTabs = document.querySelectorAll('.zone-tab');
  const zoneInput = document.querySelector('input[name="zone"]') as HTMLInputElement;

  zoneTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      zoneTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      zoneInput.value = (tab as HTMLElement).dataset.zone || '';
    });
  });

  // Contact toggle
  const contactSection = document.querySelector('.contact-section');
  const contactToggle = document.querySelector('.contact-toggle');

  contactToggle?.addEventListener('click', () => {
    contactSection?.classList.toggle('expanded');
  });

  // Auto-expand contact on form focus
  const contactInputs = document.querySelectorAll('.contact-fields input, .contact-fields textarea');
  contactInputs.forEach(input => {
    input.addEventListener('focus', () => {
      contactSection?.classList.add('expanded');
    });
  });

  // Form submit
  const submitBtn = document.querySelector('.submit-btn') as HTMLButtonElement;
  let isSubmitting = false;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isSubmitting) return;

    // Ensure contact section is expanded and has required fields
    if (!contactSection?.classList.contains('expanded')) {
      contactSection?.classList.add('expanded');
      const nameInput = document.querySelector('input[name="name"]') as HTMLInputElement;
      nameInput?.focus();
      return;
    }

    isSubmitting = true;
    submitBtn?.classList.add('loading');
    submitBtn?.setAttribute('disabled', 'true');

    const webhookUrl = form.dataset.webhook;
    const websiteId = form.dataset.websiteId;
    const formData = new FormData(form);
    const rawData = Object.fromEntries(formData);

    const data = {
      website_id: websiteId,
      nombre: rawData.name,
      email: rawData.email,
      telefono: rawData.phone,
      fecha: rawData.date,
      hora: rawData.time,
      personas: parseInt(rawData.guests as string) || 2,
      zona: rawData.zone,
      notas: rawData.notes || "",
    };

    // Simulate delay
    await new Promise(resolve => setTimeout(resolve, 1200));

    try {
      if (webhookUrl) {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error("Error");
      }

      // Show success
      form.style.display = 'none';
      successEl.style.display = 'block';
    } catch {
      alert("Error al enviar la reserva. Por favor, int√©ntalo de nuevo.");
    } finally {
      submitBtn?.classList.remove('loading');
      submitBtn?.removeAttribute('disabled');
      isSubmitting = false;
    }
  });

  // Reset on close
  closeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      setTimeout(() => {
        form.style.display = 'block';
        successEl.style.display = 'none';
        form.reset();
        guests = 2;
        guestsCount.textContent = '2';
        dateChips.forEach((c, i) => c.classList.toggle('active', i === 0));
        dateInput.classList.remove('visible');
        dateInput.value = getDateString(0);
        timeSlots.forEach((s, i) => s.classList.toggle('active', i === 3));
        zoneTabs.forEach((t, i) => t.classList.toggle('active', i === 0));
        contactSection?.classList.remove('expanded');
      }, 300);
    });
  });
</script>
