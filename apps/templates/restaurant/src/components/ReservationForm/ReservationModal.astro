---
/**
 * ReservationModal - Bot√≥n flotante + Modal elegante
 * Dise√±o minimalista con glassmorphism y animaciones
 */
interface Props {
  title?: string;
  subtitle?: string;
  webhookUrl?: string;
  websiteId?: string;
  currentUser?: { email: string; id: string; customerId: string | null; name?: string; phone?: string | null } | null;
  buttonText?: string;
  zones?: string[];
  businessHours?: { day_of_week: number; is_open: boolean; open_time: string; close_time: string }[];
  businessHourSlots?: { day_of_week: number; open_time: string; close_time: string; sort_order?: number; is_active?: boolean }[];
  specialDays?: { id?: string; date: string; is_open: boolean; open_time: string | null; close_time: string | null; note: string | null }[];
  specialDaySlots?: { special_day_id: string; open_time: string; close_time: string; sort_order?: number }[];
  bookings?: { booking_date: string; booking_time: string | null; guests: number | null; status: string }[];
  capacity?: number | null;
}

const {
  title = "Reserva tu Mesa",
  subtitle = "Selecciona los detalles de tu visita",
  webhookUrl = "",
  websiteId = "",
  currentUser = null,
  buttonText = "Reservar Mesa",
  zones = ["Interior", "Terraza", "Barra"],
  businessHours = [],
  businessHourSlots = [],
  specialDays = [],
  specialDaySlots = [],
  bookings = [],
  capacity = null,
} = Astro.props;

const timeSlots = [
  "13:00", "13:30", "14:00", "14:30", "15:00",
  "20:00", "20:30", "21:00", "21:30", "22:00", "22:30"
];

const hoursPayload = JSON.stringify(businessHours);
const businessHourSlotsPayload = JSON.stringify(businessHourSlots);
const specialDaysPayload = JSON.stringify(specialDays);
const specialDaySlotsPayload = JSON.stringify(specialDaySlots);
const bookingsPayload = JSON.stringify(bookings);
const capacityPayload = JSON.stringify(capacity);
---

<!-- Floating Button -->
<button class="reservation-fab" aria-label="Abrir reservas" data-open-modal>
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
    <line x1="16" y1="2" x2="16" y2="6"></line>
    <line x1="8" y1="2" x2="8" y2="6"></line>
    <line x1="3" y1="10" x2="21" y2="10"></line>
  </svg>
  <span>{buttonText}</span>
</button>

<!-- Modal Overlay -->
<div class="reservation-modal-overlay" data-modal>
  <div class="reservation-modal">
    <!-- Close Button -->
    <button class="modal-close" aria-label="Cerrar" data-close-modal>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <!-- Modal Content -->
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">{title}</h2>
        <p class="modal-subtitle">{subtitle}</p>
      </div>

      <form
        class="modal-form"
        data-webhook={webhookUrl}
        data-website-id={websiteId}
        data-current-user={currentUser ? JSON.stringify(currentUser) : ""}
        data-require-auth="true"
      >
        <script type="application/json" data-hours set:html={hoursPayload}></script>
        <script type="application/json" data-business-hour-slots set:html={businessHourSlotsPayload}></script>
        <script type="application/json" data-special-days set:html={specialDaysPayload}></script>
        <script type="application/json" data-special-day-slots set:html={specialDaySlotsPayload}></script>
        <script type="application/json" data-bookings set:html={bookingsPayload}></script>
        <script type="application/json" data-capacity set:html={capacityPayload}></script>

        <div class="auth-block neumor-inset" data-auth-block>
          <div class="auth-content">
            <div class="auth-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div>
              <h5>Inicia sesion para reservar</h5>
              <p>Necesitas iniciar sesion con Google para confirmar tu reserva.</p>
            </div>
          </div>
          <div class="auth-actions">
            <button type="button" class="neumor-btn neumor-btn-accent" data-auth-google>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
              </svg>
              Continuar con Google
            </button>
            <span class="auth-user" data-auth-user hidden></span>
          </div>
        </div>
        <!-- Date Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">üìÖ</span>
            Fecha
          </label>
          <div class="date-quick-select">
            <button type="button" class="date-chip active" data-date="today">Hoy</button>
            <button type="button" class="date-chip" data-date="tomorrow">Ma√±ana</button>
            <button type="button" class="date-chip" data-date="custom">Otra fecha</button>
          </div>
          <input type="date" name="date" class="date-input-hidden neumor-input" />
        </div>

        <!-- Time Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">‚è∞</span>
            Hora
          </label>
          <div class="time-slots">
            {timeSlots.map((time, i) => (
              <button type="button" class={`time-slot ${i === 3 ? 'active' : ''}`} data-time={time}>
                {time}
              </button>
            ))}
          </div>
          <input type="hidden" name="time" value="14:30" />
        </div>

        <!-- Guests Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">üë•</span>
            Personas
          </label>
          <div class="guests-counter">
            <button type="button" class="counter-btn minus" aria-label="Menos">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <span class="guests-count">2</span>
            <button type="button" class="counter-btn plus" aria-label="M√°s">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
          <input type="hidden" name="guests" value="2" />
        </div>

        <!-- Zone Selection -->
        <div class="form-section">
          <label class="section-label">
            <span class="label-icon">üìç</span>
            Zona
          </label>
          <div class="zone-tabs">
            {zones.map((zone, i) => (
              <button type="button" class={`zone-tab ${i === 0 ? 'active' : ''}`} data-zone={zone}>
                {zone}
              </button>
            ))}
          </div>
          <input type="hidden" name="zone" value={zones[0]} />
        </div>

        <!-- Contact Info (collapsible) -->
        <div class="form-section contact-section">
          <button type="button" class="contact-toggle">
            <span>Datos de contacto</span>
            <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="contact-fields">
            <div class="field-row">
              <input type="text" name="name" class="neumor-input" placeholder="Nombre" required />
            </div>
            <div class="field-row two-cols">
              <input type="email" name="email" class="neumor-input" placeholder="Email" required />
              <input type="tel" name="phone" class="neumor-input" placeholder="Tel√©fono" required />
            </div>
            <div class="field-row">
              <textarea name="notes" class="neumor-input" placeholder="Peticiones especiales (opcional)" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" class="submit-btn neumor-btn neumor-btn-accent">
          <span class="btn-text">Confirmar Reserva</span>
          <span class="btn-loader"></span>
        </button>
      </form>

      <!-- Success State -->
      <div class="modal-success" style="display: none;">
        <div class="success-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h3>¬°Reserva confirmada!</h3>
        <p>Te hemos enviado un email con los detalles</p>
        <button type="button" class="neumor-btn" data-close-modal>Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden section anchor -->
<section id="reserve" style="display: none;"></section>

<style>
  /* Floating Action Button */
  .reservation-fab {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-radius: 3rem;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow:
      0 10px 40px rgba(var(--accent-rgb, 99, 102, 241), 0.4),
      0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .reservation-fab:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow:
      0 14px 50px rgba(var(--accent-rgb, 99, 102, 241), 0.5),
      0 8px 20px rgba(0, 0, 0, 0.2);
  }

  .reservation-fab:active {
    transform: translateY(-2px) scale(0.98);
  }

  .reservation-fab svg {
    flex-shrink: 0;
  }

  /* Modal Overlay */
  .reservation-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .reservation-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* Modal */
  .reservation-modal {
    position: relative;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    background: var(--neumor-bg);
    border-radius: 1.5rem;
    box-shadow:
      20px 20px 60px var(--shadow-dark),
      -20px -20px 60px var(--shadow-light);
    transform: translateY(20px) scale(0.95);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .reservation-modal-overlay.active .reservation-modal {
    transform: translateY(0) scale(1);
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--neumor-bg);
    color: var(--text-secondary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .modal-close:hover {
    color: var(--text-primary);
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .modal-content {
    padding: 2rem;
  }

  .modal-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .modal-title {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .modal-subtitle {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .auth-block {
    display: grid;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: 1rem;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, rgba(var(--accent-rgb, 99, 102, 241), 0.08), rgba(var(--accent-rgb, 99, 102, 241), 0.02));
    border: 1px solid rgba(var(--accent-rgb, 99, 102, 241), 0.15);
  }

  .auth-block.is-authenticated {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02));
    border-color: rgba(16, 185, 129, 0.2);
  }

  .auth-content {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .auth-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 0.75rem;
    background: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .auth-block.is-authenticated .auth-icon {
    background: #10b981;
  }

  .auth-block h5 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
  }

  .auth-block p {
    margin: 0.2rem 0 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .auth-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .auth-actions button svg {
    margin-right: 0.4rem;
  }

  .auth-user {
    font-size: 0.85rem;
    color: var(--text-primary);
    font-weight: 500;
  }

  .auth-block.is-authenticated .auth-actions button {
    display: none;
  }

  .auth-block:not(.is-authenticated) .auth-user {
    display: none !important;
  }

  /* Form Sections */
  .form-section {
    margin-bottom: 1.75rem;
  }

  .section-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
  }

  .label-icon {
    font-size: 1.1rem;
  }

  /* Date Quick Select */
  .date-quick-select {
    display: flex;
    gap: 0.5rem;
  }

  .date-chip {
    flex: 1;
    padding: 0.75rem;
    border-radius: 0.75rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.875rem;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .date-chip:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .date-chip.active {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 4px 15px rgba(var(--accent-rgb, 99, 102, 241), 0.4);
  }

  .date-input-hidden {
    display: none;
    margin-top: 0.75rem;
  }

  .date-input-hidden.visible {
    display: block;
  }

  /* Time Slots */
  .time-slots {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
  }

  .time-slot {
    padding: 0.625rem 0.5rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.8rem;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    transition: all 0.2s;
  }

  .time-slot:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .time-slot.active {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
    box-shadow: 0 3px 10px rgba(var(--accent-rgb, 99, 102, 241), 0.4);
  }

  .time-empty {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.85rem;
    padding: 0.5rem;
  }

  /* Guests Counter */
  .guests-counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
  }

  .counter-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .counter-btn:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .counter-btn:active {
    box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
  }

  .guests-count {
    font-size: 2rem;
    font-weight: 700;
    min-width: 60px;
    text-align: center;
    color: var(--accent);
  }

  /* Zone Tabs */
  .zone-tabs {
    display: flex;
    gap: 0.5rem;
    background: var(--neumor-bg);
    padding: 0.375rem;
    border-radius: 0.75rem;
    box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
  }

  .zone-tab {
    flex: 1;
    padding: 0.625rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.875rem;
    background: transparent;
    color: var(--text-secondary);
    transition: all 0.2s;
  }

  .zone-tab:hover {
    color: var(--text-primary);
  }

  .zone-tab.active {
    background: var(--neumor-bg);
    color: var(--text-primary);
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
  }

  /* Contact Section */
  .contact-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-radius: 0.75rem;
    border: none;
    cursor: pointer;
    background: var(--neumor-bg);
    color: var(--text-primary);
    font-weight: 500;
    box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    transition: all 0.2s;
  }

  .contact-toggle:hover {
    box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
  }

  .toggle-icon {
    transition: transform 0.3s;
  }

  .contact-section.expanded .toggle-icon {
    transform: rotate(180deg);
  }

  .contact-fields {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }

  .contact-section.expanded .contact-fields {
    max-height: 300px;
    padding-top: 1rem;
  }

  .field-row {
    margin-bottom: 0.75rem;
  }

  .field-row.two-cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  .field-row .neumor-input {
    width: 100%;
  }

  .field-row textarea.neumor-input {
    resize: none;
  }

  /* Submit Button */
  .submit-btn {
    width: 100%;
    margin-top: 0.5rem;
    position: relative;
  }

  .submit-btn .btn-loader {
    display: none;
  }

  .submit-btn.loading .btn-text {
    visibility: hidden;
  }

  .submit-btn.loading .btn-loader {
    display: block;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Success State */
  .modal-success {
    text-align: center;
    padding: 2rem 0;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    color: var(--accent);
    animation: scaleIn 0.4s ease-out;
  }

  @keyframes scaleIn {
    from {
      transform: scale(0);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  .modal-success h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
  }

  .modal-success p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .reservation-fab {
      bottom: 1rem;
      right: 1rem;
      padding: 0.875rem 1.25rem;
    }

    .reservation-fab span {
      display: none;
    }

    .modal-content {
      padding: 1.5rem;
    }

    .time-slots {
      grid-template-columns: repeat(3, 1fr);
    }

    .field-row.two-cols {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  (function () {
    const fab = document.querySelector('[data-open-modal]');
    const modal = document.querySelector('[data-modal]') as HTMLElement | null;
    const closeButtons = document.querySelectorAll('[data-close-modal]');
    const form = document.querySelector('.modal-form') as HTMLFormElement | null;
    const successEl = document.querySelector('.modal-success') as HTMLElement | null;

    if (!form) return;

    const parseJsonScript = (selector: string, fallback: unknown) => {
      const el = form.querySelector(selector);
      if (!el) return fallback;
      try {
        const parsed = JSON.parse(el.textContent || 'null');
        return parsed ?? fallback;
      } catch {
        return fallback;
      }
    };

    const businessHours = parseJsonScript('script[data-hours]', []) as {
      day_of_week: number;
      is_open: boolean;
      open_time: string;
      close_time: string;
    }[];
    const businessHourSlots = parseJsonScript('script[data-business-hour-slots]', []) as {
      day_of_week: number;
      open_time: string;
      close_time: string;
      sort_order?: number;
      is_active?: boolean;
    }[];
    const specialDays = parseJsonScript('script[data-special-days]', []) as {
      id?: string;
      date: string;
      is_open: boolean;
      open_time: string | null;
      close_time: string | null;
      note: string | null;
    }[];
    const specialDaySlots = parseJsonScript('script[data-special-day-slots]', []) as {
      special_day_id: string;
      open_time: string;
      close_time: string;
      sort_order?: number;
    }[];
    const bookings = parseJsonScript('script[data-bookings]', []) as {
      booking_date: string;
      booking_time: string | null;
      guests: number | null;
      status: string;
    }[];
    const capacityRaw = parseJsonScript('script[data-capacity]', null) as number | null;
    const capacityNum = Number(capacityRaw);
    const capacity = Number.isFinite(capacityNum) && capacityNum > 0 ? capacityNum : null;

    const slotIntervalMinutes = 30;
    const maxAdvanceDays = 90;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dateChips = form.querySelectorAll('.date-chip');
    const dateInput = form.querySelector('.date-input-hidden') as HTMLInputElement;
    const timeSlotsContainer = form.querySelector('.time-slots') as HTMLElement | null;
    const timeInput = form.querySelector('input[name="time"]') as HTMLInputElement;
    const minusBtn = form.querySelector('.counter-btn.minus');
    const plusBtn = form.querySelector('.counter-btn.plus');
    const guestsCount = form.querySelector('.guests-count') as HTMLElement;
    const guestsInput = form.querySelector('input[name="guests"]') as HTMLInputElement;
    const zoneTabs = form.querySelectorAll('.zone-tab');
    const zoneInput = form.querySelector('input[name="zone"]') as HTMLInputElement;
    const contactSection = form.querySelector('.contact-section');
    const contactToggle = form.querySelector('.contact-toggle');
    const contactInputs = form.querySelectorAll('.contact-fields input, .contact-fields textarea');
    const submitBtn = document.querySelector('.submit-btn') as HTMLButtonElement;

    const authBlock = form.querySelector('[data-auth-block]');
    const authButton = form.querySelector('[data-auth-google]');
    const authUser = form.querySelector('[data-auth-user]');
    const requireAuth = form.dataset.requireAuth === 'true';
    let isAuthenticated = false;

    const setAuthState = (email: string) => {
      isAuthenticated = Boolean(email);
      if (authUser) {
        if (email) {
          authUser.textContent = `Conectado como ${email}`;
          authUser.removeAttribute('hidden');
        } else {
          authUser.textContent = '';
          authUser.setAttribute('hidden', 'true');
        }
      }
      if (authBlock) {
        authBlock.classList.toggle('is-authenticated', Boolean(email));
        const title = authBlock.querySelector('h5');
        const subtitle = authBlock.querySelector('p');
        if (title && subtitle) {
          if (email) {
            title.textContent = 'Sesion iniciada';
            subtitle.textContent = 'Ya puedes confirmar tu reserva.';
          } else {
            title.textContent = 'Inicia sesion para reservar';
            subtitle.textContent = 'Necesitas iniciar sesion con Google para confirmar tu reserva.';
          }
        }
      }
      if (submitBtn && requireAuth) {
        submitBtn.disabled = !isAuthenticated;
      }
    };

    const currentUserRaw = form.dataset.currentUser || '';
    if (currentUserRaw) {
      try {
        const parsed = JSON.parse(currentUserRaw);
        if (parsed && parsed.email) {
          setAuthState(parsed.email);
        }
      } catch {
        setAuthState('');
      }
    } else {
      setAuthState('');
    }

    authButton?.addEventListener('click', () => {
      const returnUrl = `${window.location.pathname}${window.location.search}#reserve`;
      window.location.href = `/mi-cuenta/auth/google?return_url=${encodeURIComponent(returnUrl)}`;
    });

    const toIsoDate = (date: Date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const fromIsoDate = (value: string) => {
      const [year, month, day] = value.split('-').map(Number);
      return new Date(year, (month || 1) - 1, day || 1);
    };

    const toMinutes = (value: string) => {
      if (!value || typeof value !== 'string') return null;
      const [h, m] = value.slice(0, 5).split(':').map(Number);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h * 60 + m;
    };

    const normalizeTime = (value: string) => (typeof value === 'string' ? value.slice(0, 5) : '');

    const toTimeString = (minutes: number) => {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    };

    const clampToWindow = (openMin: number | null, closeMin: number | null) => {
      if (!Number.isFinite(openMin) || !Number.isFinite(closeMin) || (openMin as number) >= (closeMin as number)) {
        return null;
      }
      return { openMin: openMin as number, closeMin: closeMin as number };
    };

    const buildRangesFromSlots = (slots: { open_time: string; close_time: string }[]) => {
      if (!Array.isArray(slots) || slots.length === 0) return [];
      return slots
        .map((slot) => clampToWindow(toMinutes(slot.open_time), toMinutes(slot.close_time)))
        .filter((range): range is { openMin: number; closeMin: number } => range !== null);
    };

    const getFallbackRangesForDay = (date: Date) => {
      const dayOfWeek = (date.getDay() + 6) % 7;
      const day = businessHours.find((d) => d.day_of_week === dayOfWeek);
      if (!day) {
        const fallback = clampToWindow(13 * 60, 23 * 60);
        return fallback ? [fallback] : [];
      }
      if (!day.is_open) return [];
      const range = clampToWindow(toMinutes(day.open_time), toMinutes(day.close_time))
        || clampToWindow(13 * 60, 23 * 60);
      return range ? [range] : [];
    };

    const getRangesForDate = (date: Date) => {
      const iso = toIsoDate(date);
      const special = specialDays.find((d) => d.date === iso);

      if (special) {
        if (!special.is_open) return [];
        const specialSlotRanges = buildRangesFromSlots(
          specialDaySlots
            .filter((slot) => slot.special_day_id === special.id)
            .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
        );
        if (specialSlotRanges.length) return specialSlotRanges;

        const specialRange = clampToWindow(toMinutes(special.open_time || ''), toMinutes(special.close_time || ''));
        if (specialRange) return [specialRange];

        return getFallbackRangesForDay(date);
      }

      const dayOfWeek = (date.getDay() + 6) % 7;
      const daySlots = businessHourSlots
        .filter((slot) => slot.day_of_week === dayOfWeek && slot.is_active !== false)
        .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
      const daySlotRanges = buildRangesFromSlots(daySlots);
      if (daySlotRanges.length) return daySlotRanges;

      return getFallbackRangesForDay(date);
    };

    const getBookingsForDate = (isoDate: string) =>
      bookings.filter((b) => b.booking_date === isoDate && b.status !== 'cancelled');

    const getBookedGuestsForSlot = (isoDate: string, time: string) => {
      const slotTime = normalizeTime(time);
      return getBookingsForDate(isoDate)
        .filter((b) => normalizeTime(b.booking_time || '') === slotTime)
        .reduce((sum, b) => sum + (Number(b.guests) || 2), 0);
    };

    const generateSlotsForDate = (date: Date) => {
      const ranges = getRangesForDate(date);
      if (!ranges.length) return [];
      const isoDate = toIsoDate(date);
      const slots: { time: string; remaining: number | null; isFull: boolean }[] = [];
      ranges.forEach((range) => {
        for (let minutes = range.openMin; minutes + slotIntervalMinutes <= range.closeMin; minutes += slotIntervalMinutes) {
          const time = toTimeString(minutes);
          const bookedGuests = getBookedGuestsForSlot(isoDate, time);
          const remaining = capacity ? Math.max(0, capacity - bookedGuests) : null;
          const isFull = capacity ? remaining <= 0 : false;
          slots.push({ time, remaining, isFull });
        }
      });
      return slots;
    };

    const getGuestCount = () => Number(guestsInput?.value || 2);

    const getAvailableSlotsForDate = (date: Date, guests: number) => {
      const slots = generateSlotsForDate(date);
      if (!capacity) return slots;
      return slots.filter((slot) => (slot.remaining ?? 0) >= guests);
    };

    const isSlotAvailable = (isoDate: string, time: string, guests: number) => {
      const dateObj = fromIsoDate(isoDate);
      const availableSlots = getAvailableSlotsForDate(dateObj, guests);
      return availableSlots.some((slot) => slot.time === time);
    };

    function getDateString(offset: number) {
      const date = new Date();
      date.setDate(date.getDate() + offset);
      return toIsoDate(date);
    }

    const minDate = getDateString(0);
    const maxDate = getDateString(maxAdvanceDays);
    if (dateInput) {
      dateInput.min = minDate;
      dateInput.max = maxDate;
    }

    const renderTimeSlots = () => {
      if (!timeSlotsContainer) return;
      timeSlotsContainer.innerHTML = '';

      const dateValue = dateInput?.value;
      if (!dateValue) {
        timeInput.value = '';
        const empty = document.createElement('div');
        empty.className = 'time-empty';
        empty.textContent = 'Selecciona una fecha';
        timeSlotsContainer.appendChild(empty);
        return;
      }

      const dateObj = fromIsoDate(dateValue);
      const slots = getAvailableSlotsForDate(dateObj, getGuestCount());

      if (!slots.length) {
        timeInput.value = '';
        const empty = document.createElement('div');
        empty.className = 'time-empty';
        empty.textContent = 'No hay horarios disponibles';
        timeSlotsContainer.appendChild(empty);
        return;
      }

      slots.forEach((slot, index) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `time-slot ${index === 0 ? 'active' : ''}`;
        button.dataset.time = slot.time;
        button.textContent = slot.time;
        button.addEventListener('click', () => {
          timeSlotsContainer.querySelectorAll('.time-slot').forEach((s) => s.classList.remove('active'));
          button.classList.add('active');
          timeInput.value = slot.time;
        });
        timeSlotsContainer.appendChild(button);
      });

      timeInput.value = slots[0].time;
    };

    const setDateFromChip = (offset: number) => {
      dateInput.value = getDateString(offset);
      dateInput.classList.remove('visible');
      renderTimeSlots();
    };

    dateChips.forEach(chip => {
      chip.addEventListener('click', () => {
        dateChips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');

        const dateType = (chip as HTMLElement).dataset.date;
        if (dateType === 'today') {
          setDateFromChip(0);
        } else if (dateType === 'tomorrow') {
          setDateFromChip(1);
        } else {
          dateInput.classList.add('visible');
          dateInput.focus();
        }
      });
    });

    dateInput?.addEventListener('change', () => {
      renderTimeSlots();
    });

    let guests = 2;

    minusBtn?.addEventListener('click', () => {
      if (guests > 1) {
        guests--;
        guestsCount.textContent = String(guests);
        guestsInput.value = String(guests);
        renderTimeSlots();
      }
    });

    plusBtn?.addEventListener('click', () => {
      if (guests < 12) {
        guests++;
        guestsCount.textContent = String(guests);
        guestsInput.value = String(guests);
        renderTimeSlots();
      }
    });

    zoneTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        zoneTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        zoneInput.value = (tab as HTMLElement).dataset.zone || '';
      });
    });

    contactToggle?.addEventListener('click', () => {
      contactSection?.classList.toggle('expanded');
    });

    contactInputs.forEach(input => {
      input.addEventListener('focus', () => {
        contactSection?.classList.add('expanded');
      });
    });

    // Open modal
    fab?.addEventListener('click', () => {
      modal?.classList.add('active');
      document.body.style.overflow = 'hidden';
    });

    function closeModal() {
      modal?.classList.remove('active');
      document.body.style.overflow = '';
    }

    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.classList.contains('active')) {
        closeModal();
      }
    });

    let isSubmitting = false;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isSubmitting) return;
      if (requireAuth && !isAuthenticated) {
        alert('Necesitas iniciar sesion con Google para reservar.');
        authBlock?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      if (!contactSection?.classList.contains('expanded')) {
        contactSection?.classList.add('expanded');
        const nameInput = form.querySelector('input[name="name"]') as HTMLInputElement;
        nameInput?.focus();
        return;
      }

      const dateValue = dateInput?.value;
      const timeValue = timeInput?.value;
      if (!dateValue || !timeValue) {
        alert('Selecciona fecha y hora.');
        return;
      }

      if (!isSlotAvailable(dateValue, timeValue, getGuestCount())) {
        alert('Ese horario ya no est√° disponible. Elige otro.');
        renderTimeSlots();
        return;
      }

      isSubmitting = true;
      submitBtn?.classList.add('loading');
      submitBtn?.setAttribute('disabled', 'true');

      const webhookUrl = form.dataset.webhook;
      const websiteId = form.dataset.websiteId;
      const formData = new FormData(form);
      const rawData = Object.fromEntries(formData);

      const data = {
        website_id: websiteId,
        nombre: rawData.name,
        email: rawData.email,
        telefono: rawData.phone,
        fecha: rawData.date,
        hora: rawData.time,
        personas: parseInt(rawData.guests as string) || 2,
        zona: rawData.zone,
        notas: rawData.notes || "",
      };

      await new Promise(resolve => setTimeout(resolve, 1200));

      try {
        if (webhookUrl) {
          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          if (!response.ok) throw new Error("Error");
        }

        form.style.display = 'none';
        if (successEl) successEl.style.display = 'block';
      } catch {
        alert("Error al enviar la reserva. Por favor, int√©ntalo de nuevo.");
      } finally {
        submitBtn?.classList.remove('loading');
        submitBtn?.removeAttribute('disabled');
        isSubmitting = false;
      }
    });

    closeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        setTimeout(() => {
          form.style.display = 'block';
          if (successEl) successEl.style.display = 'none';
          form.reset();
          guests = 2;
          guestsCount.textContent = '2';
          dateChips.forEach((c, i) => c.classList.toggle('active', i === 0));
          dateInput.classList.remove('visible');
          dateInput.value = minDate;
          zoneTabs.forEach((t, i) => t.classList.toggle('active', i === 0));
          contactSection?.classList.remove('expanded');
          renderTimeSlots();
        }, 300);
      });
    });

    dateInput.value = minDate;
    renderTimeSlots();
  })();
</script>
