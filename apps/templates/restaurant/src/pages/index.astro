---
/**
 * NEUMORSTUDIO - Plantilla Restaurante
 *
 * Esta plantilla carga la configuración desde Supabase automáticamente.
 * Si no hay conexión a Supabase, usa los valores por defecto.
 *
 * Variables de entorno requeridas:
 * - PUBLIC_SUPABASE_URL: URL de tu proyecto Supabase
 * - PUBLIC_SUPABASE_ANON_KEY: Clave anónima de Supabase
 * - PUBLIC_WEBSITE_ID: ID del website en la tabla websites
 *
 * Preview Mode:
 * Añadir ?preview=1 a la URL para activar el modo preview.
 * Parametros de preview:
 * - theme: Tema a previsualizar
 * - v_hero, v_menu, v_features, v_reviews, v_footer, v_reservation: Variantes individuales
 * - v_team, v_gallery, v_faq, v_plans, v_contact: Variantes de secciones genericas
 */

import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";

// Importar TODAS las variantes de componentes
import { HeroClassic, HeroModern, HeroBold, HeroMinimal, HeroFullscreen, HeroSplit } from "@components/Hero";
import { MenuTabs, MenuGrid, MenuList, MenuCarousel } from "@components/Menu";
import { FeaturesCards, FeaturesIcons, FeaturesBanner } from "@components/Features";
import { FooterFull, FooterMinimal, FooterCentered } from "@components/Footer";
import { ReviewsGrid, ReviewsCarousel, ReviewsMinimal } from "@components/Reviews";
import { FAQSection, ContactSection, TeamSection, GallerySection, BrandsSection, PlansSection } from "@components/Sections";
import { StatusPulse, StatusMorph, StatusLiquid, StatusTime } from "@components/OpenStatus";
import { ReservationClassic, ReservationWizard, ReservationModal, ReservationModern } from "@components/ReservationForm";
import { OrdersDefault } from "@components/Orders";

// Importar cliente Supabase
import {
  getWebsiteConfig,
  getMenuItems,
  getBusinessHours,
  getBusinessHourSlots,
  getSpecialDays,
  getSpecialDaySlots,
  getBookingsInRange,
  getRestaurantSettings,
  getOrderSettings,
  type Theme,
  type WebsiteVariants,
  type OpenStatusConfig,
  type WeekSchedule,
  type MenuItemRow,
  type BusinessHourRow,
  type BusinessHourSlotRow,
  type SpecialDayRow,
  type SpecialDaySlotRow,
  type BookingRow,
  type RestaurantRow,
  type OrderSettingsRow,
  type SectionConfig,
  type SectionsConfig,
} from "@lib/supabase";

// ============================================
// PREVIEW MODE - Leer parametros de URL
// ============================================
const url = new URL(Astro.request.url);
const isPreview = url.searchParams.get("preview") === "1";

// Parametros de preview
const previewTheme = url.searchParams.get("theme") as Theme | null;
const previewVariants = {
  hero: url.searchParams.get("v_hero"),
  menu: url.searchParams.get("v_menu"),
  features: url.searchParams.get("v_features"),
  reviews: url.searchParams.get("v_reviews"),
  footer: url.searchParams.get("v_footer"),
  openStatus: url.searchParams.get("v_status"),
  reservation: url.searchParams.get("v_reservation"),
};
const previewSectionVariants = {
  team: url.searchParams.get("v_team"),
  gallery: url.searchParams.get("v_gallery"),
  brands: url.searchParams.get("v_brands"),
  faq: url.searchParams.get("v_faq"),
  plans: url.searchParams.get("v_plans"),
  contact: url.searchParams.get("v_contact"),
};
const previewStatusPosition = url.searchParams.get("status_pos") as "floating" | "inline" | "header" | null;

// ============================================
// MAPEO DE VARIANTES
// ============================================
const componentMap = {
  hero: {
    classic: HeroClassic,
    modern: HeroModern,
    bold: HeroBold,
    minimal: HeroMinimal,
    fullscreen: HeroFullscreen,
    split: HeroSplit,
  },
  menu: {
    tabs: MenuTabs,
    grid: MenuGrid,
    list: MenuList,
    carousel: MenuCarousel,
  },
  features: {
    cards: FeaturesCards,
    icons: FeaturesIcons,
    banner: FeaturesBanner,
  },
  reviews: {
    grid: ReviewsGrid,
    carousel: ReviewsCarousel,
    minimal: ReviewsMinimal,
  },
  footer: {
    full: FooterFull,
    minimal: FooterMinimal,
    centered: FooterCentered,
  },
  openStatus: {
    pulse: StatusPulse,
    morph: StatusMorph,
    liquid: StatusLiquid,
    time: StatusTime,
  },
  reservation: {
    classic: ReservationClassic,
    wizard: ReservationWizard,
    modal: ReservationModal,
    modern: ReservationModern,
  },
  orders: {
    default: OrdersDefault,
  },
};

// ============================================
// VALORES POR DEFECTO (fallback si no hay Supabase)
// ============================================
// Horario por defecto (ejemplo típico de restaurante)
const defaultSchedule: WeekSchedule = {
  lunes: { open: "13:00", close: "23:00", closed: true },
  martes: { open: "13:00", close: "16:00" },
  miercoles: { open: "13:00", close: "16:00" },
  jueves: { open: "13:00", close: "16:00" },
  viernes: { open: "13:00", close: "16:00" },
  sabado: { open: "13:00", close: "23:00" },
  domingo: { open: "13:00", close: "23:00" },
};

const defaultConfig = {
  restaurantName: "Mi Restaurante",
  theme: "light" as Theme,
  variants: {
    hero: "classic",
    menu: "tabs",
    features: "cards",
    footer: "full",
    openStatus: "pulse",
    reservation: "modern",
  } as WebsiteVariants,
  siteTitle: "Mi Restaurante | Bienvenidos",
  siteDescription: "Restaurante con estilo neumórfico",
  heroTitle: "Bienvenidos a Nuestro Restaurante",
  heroSubtitle: "Una experiencia culinaria única",
  heroImage: "https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=800&q=80",
  ordersTitle: "Pedidos para recoger",
  ordersSubtitle: "Elige tus platos, paga online y recoge sin esperas.",
  webhookUrl: import.meta.env.PUBLIC_ADMIN_URL ? `${import.meta.env.PUBLIC_ADMIN_URL}/api/reservas` : (import.meta.env.PUBLIC_RESERVATION_WEBHOOK_URL || ""),
  ordersWebhookUrl: import.meta.env.PUBLIC_ADMIN_URL ? `${import.meta.env.PUBLIC_ADMIN_URL}/api/pedidos` : (import.meta.env.PUBLIC_ORDERS_WEBHOOK_URL || ""),
  address: "Tu dirección aquí",
  phone: "+34 000 000 000",
  email: "contacto@turestaurante.com",
  socialLinks: {
    instagram: "#",
    facebook: "#",
    tripadvisor: "#",
  } as { instagram: string; facebook: string; tripadvisor: string },
  // Configuración del indicador de estado
  openStatus: {
    enabled: true,
    variant: "pulse",
    position: "floating",
    schedule: defaultSchedule,
    forceStatus: null,
    showScheduleInfo: true,
    language: "es",
  } as OpenStatusConfig,
};

const formatPrice = (priceCents: number) => {
  return new Intl.NumberFormat("es-ES", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(priceCents / 100);
};

const normalizeTimeString = (value: string) => (value ? value.slice(0, 5) : "");

const toIsoDate = (date: Date) => date.toISOString().split("T")[0];

const getCategoryIcon = (category: string) => {
  const key = category.toLowerCase();
  if (key.includes("entrante")) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>`;
  }
  if (key.includes("principal")) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20"/></svg>`;
  }
  if (key.includes("postre")) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/></svg>`;
  }

  return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/></svg>`;
};

const buildMenuCategories = (items: MenuItemRow[]) => {
  const categories: {
    name: string;
    icon: string;
    items: Array<{
      id: string;
      name: string;
      description: string;
      price: string;
      priceCents: number;
      tag?: string;
      image?: string;
    }>;
  }[] = [];
  const categoryMap = new Map<string, typeof categories[number]>();

  items.forEach((item) => {
    const categoryName = item.category || "Otros";
    let category = categoryMap.get(categoryName);
    if (!category) {
      category = {
        name: categoryName,
        icon: getCategoryIcon(categoryName),
        items: [],
      };
      categoryMap.set(categoryName, category);
      categories.push(category);
    }

    category.items.push({
      id: item.id,
      name: item.name,
      description: item.description || "",
      price: formatPrice(item.price_cents),
      priceCents: item.price_cents,
      tag: item.tag || undefined,
      image: item.image_url || undefined,
    });
  });

  return categories;
};

// ============================================
// CARGAR CONFIGURACION DESDE SUPABASE
// ============================================
const websiteId = import.meta.env.PUBLIC_WEBSITE_ID;
const websiteData = await getWebsiteConfig(websiteId, url.hostname);

// Construir configuración final mezclando Supabase + defaults
let config: typeof defaultConfig;

if (websiteData) {
  // Tenemos datos de Supabase
  const dbConfig = websiteData.config || {};

  // Merge socialLinks asegurando que todos los campos existan
  const mergedSocialLinks = {
    instagram: dbConfig.socialLinks?.instagram || defaultConfig.socialLinks.instagram,
    facebook: dbConfig.socialLinks?.facebook || defaultConfig.socialLinks.facebook,
    tripadvisor: dbConfig.socialLinks?.tripadvisor || defaultConfig.socialLinks.tripadvisor,
  };

  // Merge openStatus config
  const mergedOpenStatus: OpenStatusConfig = {
    enabled: dbConfig.openStatus?.enabled ?? defaultConfig.openStatus.enabled,
    variant: dbConfig.openStatus?.variant || defaultConfig.openStatus.variant,
    position: dbConfig.openStatus?.position || defaultConfig.openStatus.position,
    schedule: dbConfig.openStatus?.schedule || defaultConfig.openStatus.schedule,
    forceStatus: dbConfig.openStatus?.forceStatus ?? defaultConfig.openStatus.forceStatus,
    showScheduleInfo: dbConfig.openStatus?.showScheduleInfo ?? defaultConfig.openStatus.showScheduleInfo,
    language: dbConfig.openStatus?.language || defaultConfig.openStatus.language,
  };

  // Merge variants asegurando que todos los campos existan
  const mergedVariants: WebsiteVariants = {
    ...(dbConfig.variants || defaultConfig.variants),
    openStatus: dbConfig.variants?.openStatus || defaultConfig.variants.openStatus,
    reservation: dbConfig.variants?.reservation || defaultConfig.variants.reservation,
  };

  config = {
    restaurantName: dbConfig.businessName || defaultConfig.restaurantName,
    theme: websiteData.theme || defaultConfig.theme,
    variants: mergedVariants,
    siteTitle: `${dbConfig.businessName || defaultConfig.restaurantName} | Restaurante`,
    siteDescription: defaultConfig.siteDescription,
    heroTitle: dbConfig.heroTitle || defaultConfig.heroTitle,
    heroSubtitle: dbConfig.heroSubtitle || defaultConfig.heroSubtitle,
    heroImage: dbConfig.heroImage || defaultConfig.heroImage,
    ordersTitle: dbConfig.ordersTitle || defaultConfig.ordersTitle,
    ordersSubtitle: dbConfig.ordersSubtitle || defaultConfig.ordersSubtitle,
    webhookUrl: defaultConfig.webhookUrl,
    ordersWebhookUrl: defaultConfig.ordersWebhookUrl,
    address: dbConfig.address || defaultConfig.address,
    phone: dbConfig.phone || defaultConfig.phone,
    email: dbConfig.email || defaultConfig.email,
    socialLinks: mergedSocialLinks,
    openStatus: mergedOpenStatus,
  };

  console.log("✅ Configuración cargada desde Supabase:", websiteData.domain);
} else {
  // No hay conexión a Supabase, usar defaults
  config = defaultConfig;
  console.log("⚠️ Usando configuración por defecto (Supabase no disponible)");
}

// Extraer configuración de personalización visual
const customization = websiteData?.config ? {
  colors: websiteData.config.colors,
  primaryColor: websiteData.config.primaryColor,
  secondaryColor: websiteData.config.secondaryColor,
  typography: websiteData.config.typography,
  effects: websiteData.config.effects,
  branding: websiteData.config.branding,
  logo: websiteData.config.logo,
} : {};
const rawConfig = websiteData?.config as Record<string, unknown> | undefined;
const nestedContent = rawConfig && typeof rawConfig === "object" && rawConfig.content && typeof rawConfig.content === "object"
  ? (rawConfig.content as Record<string, unknown>)
  : undefined;
const reviewsConfig = nestedContent ? { ...rawConfig, ...nestedContent } : rawConfig;
const contentConfig = reviewsConfig;
const getContentText = (key: string) => {
  const value = contentConfig?.[key];
  if (typeof value !== "string") return undefined;
  const trimmed = value.trim();
  return trimmed.length > 0 ? trimmed : undefined;
};
const getContentArray = (key: string) => {
  const value = contentConfig?.[key];
  return Array.isArray(value) && value.length > 0 ? value : undefined;
};

const currentWebsiteId = websiteData?.id || websiteId || "";
const menuItems = await getMenuItems(currentWebsiteId);
const businessHours: BusinessHourRow[] = await getBusinessHours(currentWebsiteId);
const businessHourSlots: BusinessHourSlotRow[] = await getBusinessHourSlots(currentWebsiteId);
const specialDays: SpecialDayRow[] = await getSpecialDays(currentWebsiteId);
const specialDaySlots: SpecialDaySlotRow[] = await getSpecialDaySlots(currentWebsiteId);
const restaurantSettings: RestaurantRow | null = await getRestaurantSettings(currentWebsiteId);
const orderSettings: OrderSettingsRow | null = await getOrderSettings(currentWebsiteId);

const bookingsStart = new Date();
const bookingsEnd = new Date();
bookingsEnd.setDate(bookingsEnd.getDate() + 90);
const bookings: BookingRow[] = currentWebsiteId
  ? await getBookingsInRange(currentWebsiteId, toIsoDate(bookingsStart), toIsoDate(bookingsEnd))
  : [];
const menuCategories = menuItems?.length ? buildMenuCategories(menuItems) : undefined;
const buildScheduleLabel = (hours: BusinessHourRow[]) => {
  const openDay = hours.find((item) => item.is_open && item.open_time && item.close_time);
  if (!openDay) return "Cerrado";
  return `${openDay.open_time.slice(0, 5)} - ${openDay.close_time.slice(0, 5)}`;
};
const buildHoursFromSchedule = (
  schedule: Record<string, { open?: string; close?: string; closed?: boolean }> | undefined
) => {
  if (!schedule) return [];
  const dayKeys = [
    ["lunes", "monday"],
    ["martes", "tuesday"],
    ["miércoles", "miercoles", "wednesday"],
    ["jueves", "thursday"],
    ["viernes", "friday"],
    ["sábado", "sabado", "saturday"],
    ["domingo", "sunday"],
  ];

  return dayKeys.map((keys, idx) => {
    const key = keys.find((k) => schedule[k]);
    const entry = key ? schedule[key] : undefined;
    const isClosed = entry?.closed === true || !entry;
    return {
      day_of_week: idx,
      is_open: !isClosed,
      open_time: entry?.open || "09:00",
      close_time: entry?.close || "19:00",
    } as BusinessHourRow;
  });
};

const scheduleFallback = buildHoursFromSchedule(
  (config.openStatus as { schedule?: Record<string, { open?: string; close?: string; closed?: boolean }> } | undefined)
    ?.schedule
);
const resolvedBusinessHours = businessHours.length ? businessHours : scheduleFallback;
const scheduleLabel = buildScheduleLabel(resolvedBusinessHours);
const ordersFeatureEnabled = restaurantSettings?.takeaway_enabled !== false;
const fallbackOrderWindow = (() => {
  const firstOpen = resolvedBusinessHours.find((item) => item.is_open && item.open_time && item.close_time);
  if (firstOpen) {
    return {
      start: normalizeTimeString(firstOpen.open_time),
      end: normalizeTimeString(firstOpen.close_time),
    };
  }
  return { start: "12:00", end: "22:00" };
})();
const pickupWindow = orderSettings
  ? {
      start: normalizeTimeString(orderSettings.pickup_start_time || fallbackOrderWindow.start),
      end: normalizeTimeString(orderSettings.pickup_end_time || fallbackOrderWindow.end),
    }
  : fallbackOrderWindow;

// ============================================
// SELECCION DINAMICA DE COMPONENTES
// ============================================

// Determinar el tema activo (preview override > Supabase)
const activeTheme: Theme = (isPreview && previewTheme)
  ? previewTheme
  : config.theme;

// Determinar variantes: preview override > Supabase config > defaults
let selectedVariants: WebsiteVariants = config.variants;

// En modo preview, aplicar variantes individuales si se especifican
if (isPreview) {
  selectedVariants = {
    hero: (previewVariants.hero as WebsiteVariants["hero"]) || selectedVariants.hero,
    menu: (previewVariants.menu as WebsiteVariants["menu"]) || selectedVariants.menu,
    features: (previewVariants.features as WebsiteVariants["features"]) || selectedVariants.features,
    reviews: (previewVariants.reviews as WebsiteVariants["reviews"]) || selectedVariants.reviews,
    footer: (previewVariants.footer as WebsiteVariants["footer"]) || selectedVariants.footer,
    openStatus: (previewVariants.openStatus as WebsiteVariants["openStatus"]) || selectedVariants.openStatus,
    reservation: (previewVariants.reservation as WebsiteVariants["reservation"]) || selectedVariants.reservation,
  };
}

// Seleccionar componentes segun la configuracion
const Hero = componentMap.hero[selectedVariants.hero] || HeroClassic;
const Menu = componentMap.menu[selectedVariants.menu] || MenuTabs;
const Features = componentMap.features[selectedVariants.features] || FeaturesCards;
const ReviewsComponent = componentMap.reviews[selectedVariants.reviews] || ReviewsCarousel;
const FooterComponent = componentMap.footer[selectedVariants.footer] || FooterFull;
const OpenStatusComponent = componentMap.openStatus[selectedVariants.openStatus] || StatusPulse;
const ReservationForm = componentMap.reservation[selectedVariants.reservation] || ReservationClassic;

// Configuración del OpenStatus (con overrides de preview)
const openStatusConfig = {
  ...config.openStatus,
  variant: selectedVariants.openStatus,
  position: previewStatusPosition || config.openStatus.position,
};


// ============================================
// CONFIGURACION DE SECCIONES DINAMICAS
// ============================================

// Secciones por defecto para restaurant
const defaultSections: SectionConfig[] = [
  { id: "hero", enabled: true, variant: "classic", order: 0 },
  { id: "features", enabled: true, variant: "cards", order: 1 },
  { id: "menu", enabled: true, variant: "tabs", order: 2 },
  { id: "orders", enabled: ordersFeatureEnabled, variant: "default", order: 3 },
  { id: "reservation", enabled: true, variant: "modern", order: 4 },
  { id: "footer", enabled: true, variant: "full", order: 5 },
];

// Obtener sectionsConfig de la BD o usar defaults
const sectionsConfig: SectionsConfig = websiteData?.config?.sectionsConfig || {
  sections: defaultSections,
};

// Crear un mapa para acceso rapido a la configuracion de cada seccion
// IMPORTANTE: Incluir TODAS las secciones (no solo habilitadas) para permitir live preview
const sectionConfigMap = new Map(sectionsConfig.sections.map((s) => [s.id, s]));
const legacyEnabledSections = new Set(
  defaultSections.filter((section) => section.enabled).map((section) => section.id)
);
const isOrdersSectionEnabled = (sectionConfigMap.get("orders")?.enabled ?? legacyEnabledSections.has("orders"))
  && ordersFeatureEnabled;
---

<Layout
  title={config.siteTitle}
  description={config.siteDescription}
  theme={activeTheme}
  customization={customization}
>
  <Header
    restaurantName={config.restaurantName}
    logo={customization.branding?.logo || customization.logo}
    logoDisplay={(customization.branding as { logoDisplay?: "logo" | "name" } | undefined)?.logoDisplay}
    showOrders={isOrdersSectionEnabled}
  />

  {/* Indicador de Estado - Posición Header (barra debajo del header) */}
  {openStatusConfig.enabled && openStatusConfig.position === "header" && (
    <div class="status-header-bar">
      <OpenStatusComponent
        schedule={openStatusConfig.schedule}
        position="inline"
        forceStatus={openStatusConfig.forceStatus}
        showSchedule={openStatusConfig.showScheduleInfo}
        language={openStatusConfig.language}
      />
    </div>
  )}

  <main class="sections-container" style="display: flex; flex-direction: column;">
    {/*
      Renderizado de TODAS las secciones posibles para permitir live preview.
      Las secciones deshabilitadas se ocultan con display:none.
      El orden se controla con CSS order para reordenamiento en tiempo real.
    */}
    {(() => {
      const allSections = [
        "hero",
        "features",
        "menu",
        "orders",
        "testimonials",
        "team",
  "gallery",
  "brands",
        "faq",
        "plans",
        "contact",
        "reservation",
      ];

      return allSections.map((sectionId) => {
        const sectionCfg = sectionConfigMap.get(sectionId);
        const isEnabled = (sectionCfg?.enabled ?? legacyEnabledSections.has(sectionId))
          && (sectionId !== "orders" || ordersFeatureEnabled);
        const order = sectionCfg?.order ?? 99;
        const style = `order: ${order}; ${!isEnabled ? 'display: none;' : ''}`;

        switch (sectionId) {
          case "hero":
            return (
              <section data-section-id="hero" style={style}>
                <Hero
                  title={config.heroTitle}
                  subtitle={config.heroSubtitle}
                  ctaText={getContentText("heroCta")}
                  backgroundImage={config.heroImage}
                  scheduleLabel={scheduleLabel}
                  address={config.address}
                  phone={config.phone}
                />
              </section>
            );
          case "features":
            return (
              <section data-section-id="features" style={style}>
                <Features />
              </section>
            );
          case "menu":
            return (
              <section data-section-id="menu" style={style}>
                <Menu categories={menuCategories} />
              </section>
            );
          case "orders":
            return (
              <section data-section-id="orders" style={style}>
                <OrdersDefault
                  title={getContentText("ordersTitle") || config.ordersTitle}
                  subtitle={getContentText("ordersSubtitle") || config.ordersSubtitle}
                  categories={menuCategories || []}
                  websiteId={currentWebsiteId}
                  webhookUrl={config.ordersWebhookUrl}
                  pickupStart={pickupWindow.start}
                  pickupEnd={pickupWindow.end}
                />
              </section>
            );
          case "testimonials":
            return (
              <section data-section-id="testimonials" style={style}>
                <ReviewsComponent
                  title={reviewsConfig?.reviewsTitle as string | undefined}
                  subtitle={reviewsConfig?.reviewsSubtitle as string | undefined}
                  googleRating={reviewsConfig?.googleRating as number | undefined}
                  totalReviews={reviewsConfig?.totalReviews as number | undefined}
                />
              </section>
            );
          case "team":
            return (
              <section data-section-id="team" style={style}>
                <TeamSection
                  title={getContentText("teamTitle")}
                  subtitle={getContentText("teamSubtitle")}
                  variant={previewSectionVariants.team || sectionCfg?.variant || "grid"}
                />
              </section>
            );
          case "gallery":
            return (
              <section data-section-id="gallery" style={style}>
                <GallerySection
                  title={getContentText("galleryTitle")}
                  subtitle={getContentText("gallerySubtitle")}
                  images={getContentArray("galleryImages")}
                  variant={previewSectionVariants.gallery || sectionCfg?.variant || "masonry"}
                />
              </section>
            );
          case "brands":
            return (
              <section data-section-id="brands" style={style}>
                <BrandsSection
                  title={getContentText("brandsTitle")}
                  subtitle={getContentText("brandsSubtitle")}
                  logos={getContentArray("brandsLogos")}
                  variant={previewSectionVariants.brands || sectionCfg?.variant || "carousel"}
                />
              </section>
            );
          case "faq":
            return (
              <section data-section-id="faq" style={style}>
                <FAQSection
                  title={getContentText("faqTitle")}
                  subtitle={getContentText("faqSubtitle")}
                    items={getContentArray("faqItems")}
                  variant={previewSectionVariants.faq || sectionCfg?.variant || "accordion"}
                />
              </section>
            );
          case "plans":
            return (
              <section data-section-id="plans" style={style}>
                <PlansSection
                  title={getContentText("plansTitle")}
                  subtitle={getContentText("plansSubtitle")}
                  variant={previewSectionVariants.plans || sectionCfg?.variant || "cards"}
                />
              </section>
            );
          case "contact":
            return (
              <section data-section-id="contact" style={style}>
                <ContactSection
                  title={getContentText("contactTitle")}
                  subtitle={getContentText("contactSubtitle")}
                  address={config.address}
                  phone={config.phone}
                  email={config.email}
                  webhookUrl={config.webhookUrl}
                  websiteId={currentWebsiteId}
                  variant={previewSectionVariants.contact || sectionCfg?.variant || "form"}
                />
              </section>
            );
          case "reservation":
            return (
              <section data-section-id="reservation" style={style}>
                <ReservationForm
                  webhookUrl={config.webhookUrl}
                  websiteId={currentWebsiteId}
                  businessHours={resolvedBusinessHours}
                  businessHourSlots={businessHourSlots}
                  specialDays={specialDays}
                  specialDaySlots={specialDaySlots}
                  bookings={bookings}
                  capacity={restaurantSettings?.capacity ?? null}
                />
              </section>
            );
          default:
            return null;
        }
      });
    })()}
  </main>

  {/* Footer - siempre renderizado para live preview */}
  {(() => {
    const footerCfg = sectionConfigMap.get("footer");
    const isFooterEnabled = footerCfg?.enabled ?? true;
    const footerOrder = footerCfg?.order ?? 100;
    const footerStyle = `order: ${footerOrder}; ${!isFooterEnabled ? 'display: none;' : ''}`;

    return (
      <div data-section-id="footer" style={footerStyle}>
        <FooterComponent
          restaurantName={config.restaurantName}
          address={config.address}
          phone={config.phone}
          email={config.email}
          socialLinks={config.socialLinks}
        />
      </div>
    );
  })()}

  {/* Indicador de Estado Abierto/Cerrado */}
  {openStatusConfig.enabled && openStatusConfig.position === "floating" && (
    <OpenStatusComponent
      schedule={openStatusConfig.schedule}
      position="floating"
      forceStatus={openStatusConfig.forceStatus}
      showSchedule={openStatusConfig.showScheduleInfo}
      language={openStatusConfig.language}
    />
  )}
</Layout>

<style>
  /* Barra de estado en posición header */
  .status-header-bar {
    position: fixed;
    top: 80px; /* Debajo del header */
    left: 0;
    right: 0;
    z-index: 99;
    display: flex;
    justify-content: center;
    padding: 0.75rem 1rem;
    background: var(--ng-glass-bg, rgba(255, 255, 255, 0.25));
    backdrop-filter: blur(var(--ng-blur-md, 16px)) saturate(180%);
    -webkit-backdrop-filter: blur(var(--ng-blur-md, 16px)) saturate(180%);
    border-bottom: 1px solid var(--ng-glass-border, rgba(255, 255, 255, 0.4));
    box-shadow: 0 4px 16px var(--ng-shadow-dark, rgba(163, 177, 198, 0.3));
  }

  @media (max-width: 768px) {
    .status-header-bar {
      top: 70px;
      padding: 0.5rem;
    }
  }
</style>
