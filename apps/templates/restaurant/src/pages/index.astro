---
/**
 * NEUMORSTUDIO - Plantilla Restaurante
 *
 * Esta plantilla carga la configuración desde Supabase automáticamente.
 * Si no hay conexión a Supabase, usa los valores por defecto.
 *
 * Variables de entorno requeridas:
 * - PUBLIC_SUPABASE_URL: URL de tu proyecto Supabase
 * - PUBLIC_SUPABASE_ANON_KEY: Clave anónima de Supabase
 * - PUBLIC_WEBSITE_ID: ID del website en la tabla websites
 *
 * Preview Mode:
 * Añadir ?preview=1 a la URL para activar el modo preview.
 * Parametros de preview:
 * - theme: Tema a previsualizar
 * - v_hero, v_menu, v_features, v_reviews, v_footer: Variantes individuales
 */

import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import ReservationForm from "@components/ReservationForm.astro";

// Importar TODAS las variantes de componentes
import { HeroClassic, HeroModern, HeroBold, HeroMinimal } from "@components/Hero";
import { MenuTabs, MenuGrid, MenuList, MenuCarousel } from "@components/Menu";
import { FeaturesCards, FeaturesIcons, FeaturesBanner } from "@components/Features";
import { ReviewsGrid, ReviewsCarousel, ReviewsMinimal } from "@components/Reviews";
import { FooterFull, FooterMinimal, FooterCentered } from "@components/Footer";

// Importar cliente Supabase
import { getWebsiteConfig, type Theme, type WebsiteVariants } from "@lib/supabase";

// ============================================
// PREVIEW MODE - Leer parametros de URL
// ============================================
const url = new URL(Astro.request.url);
const isPreview = url.searchParams.get("preview") === "1";

// Parametros de preview
const previewTheme = url.searchParams.get("theme") as Theme | null;
const previewVariants = {
  hero: url.searchParams.get("v_hero"),
  menu: url.searchParams.get("v_menu"),
  features: url.searchParams.get("v_features"),
  reviews: url.searchParams.get("v_reviews"),
  footer: url.searchParams.get("v_footer"),
};

// ============================================
// MAPEO DE VARIANTES
// ============================================
const componentMap = {
  hero: {
    classic: HeroClassic,
    modern: HeroModern,
    bold: HeroBold,
    minimal: HeroMinimal,
  },
  menu: {
    tabs: MenuTabs,
    grid: MenuGrid,
    list: MenuList,
    carousel: MenuCarousel,
  },
  features: {
    cards: FeaturesCards,
    icons: FeaturesIcons,
    banner: FeaturesBanner,
  },
  reviews: {
    grid: ReviewsGrid,
    carousel: ReviewsCarousel,
    minimal: ReviewsMinimal,
  },
  footer: {
    full: FooterFull,
    minimal: FooterMinimal,
    centered: FooterCentered,
  },
};

// ============================================
// VALORES POR DEFECTO (fallback si no hay Supabase)
// ============================================
const defaultConfig = {
  restaurantName: "Mi Restaurante",
  theme: "light" as Theme,
  variants: {
    hero: "classic",
    menu: "tabs",
    features: "cards",
    reviews: "grid",
    footer: "full",
  } as WebsiteVariants,
  siteTitle: "Mi Restaurante | Bienvenidos",
  siteDescription: "Restaurante con estilo neumórfico",
  heroTitle: "Bienvenidos a Nuestro Restaurante",
  heroSubtitle: "Una experiencia culinaria única",
  heroImage: "https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=800&q=80",
  webhookUrl: import.meta.env.PUBLIC_RESERVATION_WEBHOOK_URL || "",
  address: "Tu dirección aquí",
  phone: "+34 000 000 000",
  email: "contacto@turestaurante.com",
  socialLinks: {
    instagram: "#",
    facebook: "#",
    tripadvisor: "#",
  } as { instagram: string; facebook: string; tripadvisor: string },
  googleRating: 4.5,
  totalReviews: 100,
};

// ============================================
// CARGAR CONFIGURACION DESDE SUPABASE
// ============================================
const websiteId = import.meta.env.PUBLIC_WEBSITE_ID;
const websiteData = await getWebsiteConfig(websiteId, url.hostname);

// Construir configuración final mezclando Supabase + defaults
let config: typeof defaultConfig;

if (websiteData) {
  // Tenemos datos de Supabase
  const dbConfig = websiteData.config || {};

  // Merge socialLinks asegurando que todos los campos existan
  const mergedSocialLinks = {
    instagram: dbConfig.socialLinks?.instagram || defaultConfig.socialLinks.instagram,
    facebook: dbConfig.socialLinks?.facebook || defaultConfig.socialLinks.facebook,
    tripadvisor: dbConfig.socialLinks?.tripadvisor || defaultConfig.socialLinks.tripadvisor,
  };

  config = {
    restaurantName: dbConfig.businessName || defaultConfig.restaurantName,
    theme: websiteData.theme || defaultConfig.theme,
    variants: dbConfig.variants || defaultConfig.variants,
    siteTitle: `${dbConfig.businessName || defaultConfig.restaurantName} | Restaurante`,
    siteDescription: defaultConfig.siteDescription,
    heroTitle: dbConfig.heroTitle || defaultConfig.heroTitle,
    heroSubtitle: dbConfig.heroSubtitle || defaultConfig.heroSubtitle,
    heroImage: dbConfig.heroImage || defaultConfig.heroImage,
    webhookUrl: defaultConfig.webhookUrl,
    address: dbConfig.address || defaultConfig.address,
    phone: dbConfig.phone || defaultConfig.phone,
    email: dbConfig.email || defaultConfig.email,
    socialLinks: mergedSocialLinks,
    googleRating: dbConfig.googleRating || defaultConfig.googleRating,
    totalReviews: dbConfig.totalReviews || defaultConfig.totalReviews,
  };

  console.log("✅ Configuración cargada desde Supabase:", websiteData.domain);
} else {
  // No hay conexión a Supabase, usar defaults
  config = defaultConfig;
  console.log("⚠️ Usando configuración por defecto (Supabase no disponible)");
}

// ============================================
// SELECCION DINAMICA DE COMPONENTES
// ============================================

// Determinar el tema activo (preview override > Supabase)
const activeTheme: Theme = (isPreview && previewTheme)
  ? previewTheme
  : config.theme;

// Determinar variantes: preview override > Supabase config > defaults
let selectedVariants: WebsiteVariants = config.variants;

// En modo preview, aplicar variantes individuales si se especifican
if (isPreview) {
  selectedVariants = {
    hero: (previewVariants.hero as WebsiteVariants["hero"]) || selectedVariants.hero,
    menu: (previewVariants.menu as WebsiteVariants["menu"]) || selectedVariants.menu,
    features: (previewVariants.features as WebsiteVariants["features"]) || selectedVariants.features,
    reviews: (previewVariants.reviews as WebsiteVariants["reviews"]) || selectedVariants.reviews,
    footer: (previewVariants.footer as WebsiteVariants["footer"]) || selectedVariants.footer,
  };
}

// Seleccionar componentes segun la configuracion
const Hero = componentMap.hero[selectedVariants.hero] || HeroClassic;
const Menu = componentMap.menu[selectedVariants.menu] || MenuTabs;
const Features = componentMap.features[selectedVariants.features] || FeaturesCards;
const Reviews = componentMap.reviews[selectedVariants.reviews] || ReviewsGrid;
const FooterComponent = componentMap.footer[selectedVariants.footer] || FooterFull;

// Website ID para el formulario de reservas
const currentWebsiteId = websiteData?.id || websiteId || "";
---

<Layout
  title={config.siteTitle}
  description={config.siteDescription}
  theme={activeTheme}
>
  <Header restaurantName={config.restaurantName} />

  <main>
    <Hero
      title={config.heroTitle}
      subtitle={config.heroSubtitle}
      backgroundImage={config.heroImage}
    />

    <Features />

    <Menu />

    <Reviews
      googleRating={config.googleRating}
      totalReviews={config.totalReviews}
    />

    <ReservationForm webhookUrl={config.webhookUrl} websiteId={currentWebsiteId} />
  </main>

  <FooterComponent
    restaurantName={config.restaurantName}
    address={config.address}
    phone={config.phone}
    email={config.email}
    socialLinks={config.socialLinks}
  />
</Layout>
