---
import "../styles/global.css";
import "../styles/neuglass.css";
import "../styles/skins.css";
import { compileCustomization, applyPreviewParams, type WebsiteCustomization } from "@lib/tokens";

interface Props {
  title: string;
  description?: string;
  theme?: "light" | "dark" | "colorful" | "rustic" | "elegant" | "neuglass" | "neuglass-dark" | "christmas" | "summer" | "autumn" | "spring" | "ocean" | "sunset" | "forest" | "midnight" | "rose" | "lavender" | "coral" | "minimal" | "wellness" | "vintage";
  skin?: "neumorphic" | "brutalist" | "3d" | "flat" | "glassmorphism";
  customization?: WebsiteCustomization;
}

const {
  title,
  description = "Clinica con estilo neumorfico",
  theme = "light",
  skin,
  customization = {},
} = Astro.props;

// === DEBUG LOGS ===
console.log('[Layout.astro] ========== LAYOUT RENDER ==========');
console.log('[Layout.astro] Received props - theme:', theme);
console.log('[Layout.astro] Received customization:', JSON.stringify(customization, null, 2));

// Aplicar par치metros de preview si existen
const url = new URL(Astro.request.url);
const isPreviewMode = url.searchParams.get('preview') === '1';
console.log('[Layout.astro] URL:', url.toString());
console.log('[Layout.astro] Is preview mode:', isPreviewMode);

const finalCustomization = applyPreviewParams(customization, url);
console.log('[Layout.astro] finalCustomization after applyPreviewParams:', JSON.stringify(finalCustomization, null, 2));

// Compilar tokens a CSS
const { cssVariables, inlineColorStyles, fontImports, favicon } = compileCustomization(finalCustomization);
console.log('[Layout.astro] Compiled - cssVariables:', cssVariables ? 'has content' : 'empty');
console.log('[Layout.astro] Compiled - inlineColorStyles:', inlineColorStyles);
console.log('[Layout.astro] Compiled - fontImports:', fontImports);
console.log('[Layout.astro] ========================================');

const pwaBranding = finalCustomization.branding as Record<string, unknown> | undefined;
const pwaLogoCandidate =
  (typeof pwaBranding?.logo === "string" ? pwaBranding.logo : undefined) ||
  (typeof finalCustomization.logo === "string" ? finalCustomization.logo : undefined);
const pwaFallbackIcon =
  (typeof pwaBranding?.favicon === "string" ? pwaBranding.favicon : undefined) ||
  "/favicon.svg";
const pwaLogoCompatible = pwaBranding?.pwaLogoCompatible !== false;
const pwaIcon = pwaLogoCandidate && pwaLogoCompatible ? pwaLogoCandidate : pwaFallbackIcon;
const pwaThemeColor =
  (typeof finalCustomization.colors?.accent === "string"
    ? finalCustomization.colors?.accent
    : undefined) ||
  (typeof finalCustomization.primaryColor === "string"
    ? finalCustomization.primaryColor
    : undefined) ||
  "#6366f1";
const pwaShortName = title.split("|")[0].trim() || title;

// Determinar clase de tema
const themeClass = theme === "light" ? "" : `theme-${theme}`;

// Determinar clase de skin (neumorphic es el default, no necesita clase)
const skinClass = skin && skin !== "neumorphic" ? `skin-${skin}` : "";

// Combinar clases
const htmlClasses = [themeClass, skinClass].filter(Boolean).join(" ");

// Fuentes por defecto si no hay personalizaci칩n
const defaultFonts = !fontImports
  ? "https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
  : fontImports;
---

<!doctype html>
<html lang="es" class={htmlClasses || undefined} style={inlineColorStyles || undefined}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />

    <!-- Critical CSS - Colores personalizados con maxima prioridad para evitar FOUC -->
    {inlineColorStyles && (
      <style set:html={`html{${inlineColorStyles}}`}></style>
    )}

    <!-- Favicon -->
    {favicon ? (
      <link rel="icon" type="image/png" href={favicon} />
    ) : (
      <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    )}
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" href={pwaIcon} />
    <meta name="theme-color" content={pwaThemeColor} />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content={pwaShortName} />
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href={defaultFonts} rel="stylesheet" />
    {fontImports && fontImports !== defaultFonts && (
      <link href={fontImports} rel="stylesheet" />
    )}

    <title>{title}</title>

    <!-- Custom CSS Variables from personalization -->
    {cssVariables && (
      <style set:html={cssVariables}></style>
    )}

    <style is:global>
      :root {
        --font-heading: "Playfair Display", serif;
        --font-body: "Inter", system-ui, sans-serif;
      }

      body {
        font-family: var(--font-body);
      }

      h1, h2, h3 {
        font-family: var(--font-heading);
      }

      .neumor-card, .neumor-btn, .neumor-input {
        border-radius: var(--radius-base, 1rem);
      }
    </style>

    <style is:inline>
      .pwa-install-banner {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: var(--neumor-bg);
        color: var(--text-primary);
        border-radius: 16px;
        box-shadow:
          calc(6px * var(--shadow-intensity, 1)) calc(6px * var(--shadow-intensity, 1)) calc(14px * var(--shadow-intensity, 1)) var(--shadow-dark),
          calc(-6px * var(--shadow-intensity, 1)) calc(-6px * var(--shadow-intensity, 1)) calc(14px * var(--shadow-intensity, 1)) var(--shadow-light);
        z-index: 9999;
        opacity: 0;
        transform: translateY(12px);
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .pwa-install-banner.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .pwa-install-logo {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--shadow-light);
        flex-shrink: 0;
      }

      .pwa-install-text {
        flex: 1;
        min-width: 0;
      }

      .pwa-install-title {
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 1.2;
      }

      .pwa-install-subtitle,
      .pwa-install-ios {
        font-size: 0.72rem;
        color: var(--text-secondary);
      }

      .pwa-install-ios {
        display: none;
        margin-top: 2px;
      }

      .pwa-install-banner.ios .pwa-install-action {
        display: none;
      }

      .pwa-install-banner.ios .pwa-install-ios {
        display: block;
      }

      .pwa-install-action {
        border: none;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 0.75rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent), var(--accent-hover));
        color: #fff;
        cursor: pointer;
        flex-shrink: 0;
      }

      .pwa-install-close {
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.9rem;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
      }

      @media (min-width: 769px) {
        .pwa-install-banner {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <slot />

    <div
      id="pwa-install-banner"
      class="pwa-install-banner"
      aria-hidden="true"
    >
      <img class="pwa-install-logo" src={pwaIcon} alt={pwaShortName} loading="lazy" />
      <div class="pwa-install-text">
        <div class="pwa-install-title">Instalar {pwaShortName}</div>
        <div class="pwa-install-subtitle">Acceso rapido desde tu movil.</div>
        <div class="pwa-install-ios">En iOS: compartir y "Anadir a pantalla de inicio".</div>
      </div>
      <button id="pwa-install-action" class="pwa-install-action" type="button">Instalar</button>
      <button id="pwa-install-close" class="pwa-install-close" type="button" aria-label="Cerrar">x</button>
    </div>

    <script is:inline>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").catch(() => {});
        });
      }
    </script>

    <!-- DEBUG PANEL - Solo visible en modo preview -->
    {inlineColorStyles && (
      <script is:inline define:vars={{ inlineColorStyles, cssVariables, theme }}>
        console.log('[Layout HTML] Theme class:', document.documentElement.className);
        console.log('[Layout HTML] Inline styles on html:', document.documentElement.getAttribute('style'));
        console.log('[Layout HTML] inlineColorStyles variable:', inlineColorStyles);
        console.log('[Layout HTML] Computed --accent:', getComputedStyle(document.documentElement).getPropertyValue('--accent'));

        // Log after a small delay to see final computed values
        setTimeout(() => {
          console.log('[Layout HTML] AFTER LOAD - Computed --accent:', getComputedStyle(document.documentElement).getPropertyValue('--accent'));
          console.log('[Layout HTML] AFTER LOAD - html classes:', document.documentElement.className);
          console.log('[Layout HTML] AFTER LOAD - html style:', document.documentElement.getAttribute('style'));
        }, 100);
      </script>
    )}

    <!-- Live Preview Script - Escucha cambios del admin via postMessage -->
    <script is:inline>
      (function() {
        // Solo activar en modo preview
        if (!window.location.search.includes('preview=1')) return;

        // Mapa de border-radius
        const RADIUS_MAP = {
          sharp: '0.25rem',
          soft: '0.5rem',
          rounded: '1rem',
          pill: '2rem'
        };

        // Ajustar luminosidad de color hex
        function adjustLuminosity(hex, percent) {
          const num = parseInt(hex.replace('#', ''), 16);
          const r = Math.min(255, Math.max(0, (num >> 16) + Math.round(2.55 * percent)));
          const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + Math.round(2.55 * percent)));
          const b = Math.min(255, Math.max(0, (num & 0x0000FF) + Math.round(2.55 * percent)));
          return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        // Convertir hex a rgba
        function hexToRgba(hex, alpha) {
          const num = parseInt(hex.replace('#', ''), 16);
          const r = (num >> 16) & 255;
          const g = (num >> 8) & 255;
          const b = num & 255;
          return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + alpha + ')';
        }

        window.addEventListener('message', function(event) {
          // Verificar origen del mensaje
          if (!event.data || event.data.source !== 'neumorstudio-admin') return;
          if (event.data.type !== 'update-styles') return;

          console.log('[Preview] Received postMessage:', event.data.type);
          console.log('[Preview] Theme value:', event.data.payload.theme);

          const { theme, skin, colors, typography, effects, branding } = event.data.payload;
          const root = document.documentElement;

          // Aplicar tema (cambiar clase en html)
          if (theme) {
            console.log('[Preview] Applying theme:', theme, 'Current classes:', root.className);
            // Lista completa de todos los temas disponibles
            var allThemes = [
              'dark', 'colorful', 'rustic', 'elegant', 'neuglass', 'neuglass-dark',
              'christmas', 'summer', 'autumn', 'spring',
              'ocean', 'sunset', 'forest', 'midnight', 'rose', 'lavender', 'coral', 'minimal',
              'wellness', 'vintage'
            ];
            // Remover todas las clases de tema existentes
            allThemes.forEach(function(t) {
              root.classList.remove('theme-' + t);
            });
            // A침adir la nueva clase de tema (light no tiene clase)
            if (theme !== 'light') {
              root.classList.add('theme-' + theme);
            }
            console.log('[Preview] New classes:', root.className);
          }

          // Aplicar skin (estilo visual de componentes)
          if (skin !== undefined) {
            console.log('[Preview] Applying skin:', skin);
            var allSkins = ['flat', 'glass', 'material', 'brutalist', 'soft', '3d', 'outline'];
            // Remover todas las clases de skin existentes
            allSkins.forEach(function(s) {
              root.classList.remove('skin-' + s);
            });
            // A침adir la nueva clase de skin (neumorphic/default no tiene clase)
            if (skin && skin !== 'neumorphic') {
              root.classList.add('skin-' + skin);
            }
          }

          // Aplicar colores
          if (colors) {
            if (colors.primary) {
              root.style.setProperty('--text-primary', colors.primary);
              root.style.setProperty('--color-primary', colors.primary);
            }
            if (colors.secondary) {
              root.style.setProperty('--text-secondary', colors.secondary);
              root.style.setProperty('--color-secondary', colors.secondary);
            }
            if (colors.accent) {
              // IMPORTANTE: Actualizar --accent que es la variable que usa el CSS
              root.style.setProperty('--accent', colors.accent);
              root.style.setProperty('--color-accent', colors.accent);
              root.style.setProperty('--accent-hover', adjustLuminosity(colors.accent, -10));
              root.style.setProperty('--accent-light', hexToRgba(colors.accent, 0.1));
              root.style.setProperty('--accent-glow', hexToRgba(colors.accent, 0.4));
            }
          }

          // Aplicar tipografia
          if (typography) {
            if (typography.headingFont && typography.headingFont !== 'system') {
              // Cargar fuente si no esta cargada
              const fontName = typography.headingFont;
              if (!document.querySelector('link[href*="' + fontName.replace(/ /g, '+') + '"]')) {
                const link = document.createElement('link');
                link.href = 'https://fonts.googleapis.com/css2?family=' + fontName.replace(/ /g, '+') + ':wght@400;500;600;700&display=swap';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
              }
              root.style.setProperty('--font-heading', "'" + fontName + "', serif");
            }
            if (typography.bodyFont && typography.bodyFont !== 'system') {
              const fontName = typography.bodyFont;
              if (!document.querySelector('link[href*="' + fontName.replace(/ /g, '+') + '"]')) {
                const link = document.createElement('link');
                link.href = 'https://fonts.googleapis.com/css2?family=' + fontName.replace(/ /g, '+') + ':wght@400;500;600;700&display=swap';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
              }
              root.style.setProperty('--font-body', "'" + fontName + "', system-ui, sans-serif");
            }
            if (typography.baseFontSize) {
              root.style.setProperty('--font-size-base', typography.baseFontSize + 'px');
            }
          }

          // Aplicar efectos
          if (effects) {
            if (effects.borderRadius && RADIUS_MAP[effects.borderRadius]) {
              root.style.setProperty('--radius-base', RADIUS_MAP[effects.borderRadius]);
            }
            if (effects.shadowIntensity !== undefined) {
              const intensity = effects.shadowIntensity / 100;
              root.style.setProperty('--shadow-intensity', intensity.toString());
            }
          }

          // Aplicar branding
          if (branding) {
            if (branding.logoSize) {
              const sizeMap = { sm: '2rem', md: '3rem', lg: '4rem' };
              root.style.setProperty('--logo-size', sizeMap[branding.logoSize] || '3rem');
              root.style.setProperty('--logo-height', sizeMap[branding.logoSize] || '3rem');
            }
            // Actualizar logo en tiempo real
            if (branding.logo) {
              const logoImages = document.querySelectorAll('.logo-img, .nav-logo img, .navbar-logo img, [data-logo]');
              logoImages.forEach(function(img) {
                if (img.tagName === 'IMG') {
                  img.src = branding.logo;
                }
              });
              // Marcar que hay logo disponible
              const logoContainers = document.querySelectorAll('.logo, [data-logo-display]');
              logoContainers.forEach(function(el) {
                el.setAttribute('data-has-logo', 'true');
              });
            }
            // Actualizar modo de visualizacion (logo vs nombre)
            if (branding.logoDisplay) {
              const logoContainers = document.querySelectorAll('.logo, [data-logo-display]');
              logoContainers.forEach(function(el) {
                el.setAttribute('data-logo-display', branding.logoDisplay);
              });
            }
          }

          // Aplicar contenido de texto
          const { content } = event.data.payload;
          console.log('[Preview] Content received:', content ? 'yes' : 'no', 'heroImage:', content?.heroImage);
          if (content) {
            // Nombre del negocio
            if (content.businessName) {
              document.querySelectorAll('[data-content="businessName"], .business-name, .nav-logo-text, .footer-business-name').forEach(function(el) {
                el.textContent = content.businessName;
              });
            }

            // Hero title
            if (content.heroTitle) {
              const el = document.querySelector('.hero-title');
              if (el) {
                // Check if hero uses structured title (HeroSplit, HeroFullscreen)
                const titleLines = el.querySelectorAll('.title-line');
                if (titleLines.length > 0) {
                  // Update structured title - split by words
                  const words = content.heroTitle.split(' ');
                  titleLines.forEach(function(span, i) {
                    if (words[i]) span.textContent = words[i];
                  });
                  // If more words than spans, append to last span
                  if (words.length > titleLines.length) {
                    var lastSpan = titleLines[titleLines.length - 1];
                    lastSpan.textContent = words.slice(titleLines.length - 1).join(' ');
                  }
                } else {
                  // Simple title (HeroClassic, HeroModern, etc)
                  el.textContent = content.heroTitle;
                }
              }
            }

            // Hero subtitle
            if (content.heroSubtitle) {
              const el = document.querySelector('.hero-subtitle');
              if (el) el.textContent = content.heroSubtitle;
            }

            // Hero CTA button text
            if (content.heroCta) {
              document.querySelectorAll('.hero-cta, .hero-btn, [data-content="heroCta"]').forEach(function(el) {
                el.textContent = content.heroCta;
              });
            }

            // Siempre intentar actualizar heroImage si existe en el contenido
            if (content.heroImage) {
              console.log('[Preview] Attempting to update hero image to:', content.heroImage);
              var imageUpdated = false;

              // 1. Buscar .hero-image (HeroClassic, HeroBold)
              var heroImg = document.querySelector('.hero-image');
              if (heroImg && heroImg.tagName === 'IMG') {
                console.log('[Preview] Updating .hero-image');
                heroImg.src = content.heroImage;
                imageUpdated = true;
              }

              // 2. Buscar .hero-bg-image (HeroModern - imagen fullscreen)
              var heroBgImg = document.querySelector('.hero-bg-image');
              if (heroBgImg && heroBgImg.tagName === 'IMG') {
                console.log('[Preview] Updating .hero-bg-image (HeroModern)');
                heroBgImg.src = content.heroImage;
                imageUpdated = true;
              }

              // 3. Buscar elementos con data-hero-image
              var dataHeroImg = document.querySelector('[data-hero-image]');
              if (dataHeroImg && dataHeroImg.tagName === 'IMG') {
                console.log('[Preview] Updating [data-hero-image]');
                dataHeroImg.src = content.heroImage;
                imageUpdated = true;
              }

              // 4. Buscar background-image CSS (fallback)
              var heroSection = document.querySelector('[data-hero-bg]');
              if (heroSection) {
                console.log('[Preview] Updating hero section background');
                heroSection.style.backgroundImage = 'url(' + content.heroImage + ')';
                imageUpdated = true;
              }

              if (!imageUpdated) {
                console.log('[Preview] WARNING: No hero image element found. Looking for any img in hero...');
                // Fallback: buscar cualquier img dentro de un section.hero*
                var heroSection = document.querySelector('section[class*="hero"]');
                if (heroSection) {
                  var anyImg = heroSection.querySelector('img');
                  if (anyImg) {
                    console.log('[Preview] Found fallback img in hero section');
                    anyImg.src = content.heroImage;
                  }
                }
              }
            }

            // Contacto
            if (content.address) {
              document.querySelectorAll('[data-content="address"], .footer-address, .contact-address').forEach(function(el) {
                el.textContent = content.address;
              });
            }
            if (content.phone) {
              document.querySelectorAll('[data-content="phone"], .footer-phone, .contact-phone').forEach(function(el) {
                el.textContent = content.phone;
              });
            }
            if (content.email) {
              document.querySelectorAll('[data-content="email"], .footer-email, .contact-email').forEach(function(el) {
                el.textContent = content.email;
              });
            }

            // Horario
            if (content.schedule) {
              if (content.schedule.weekdays) {
                document.querySelectorAll('[data-content="schedule-weekdays"], .schedule-weekdays').forEach(function(el) {
                  el.textContent = content.schedule.weekdays;
                });
              }
              if (content.schedule.saturday) {
                document.querySelectorAll('[data-content="schedule-saturday"], .schedule-saturday').forEach(function(el) {
                  el.textContent = content.schedule.saturday;
                });
              }
              if (content.schedule.sunday) {
                document.querySelectorAll('[data-content="schedule-sunday"], .schedule-sunday').forEach(function(el) {
                  el.textContent = content.schedule.sunday;
                });
              }
            }

            // Reviews section title/subtitle
            if (content.reviewsTitle) {
              document.querySelectorAll('.reviews-title, #reviews h2, #testimonials h2, [data-content="reviewsTitle"]').forEach(function(el) {
                el.textContent = content.reviewsTitle;
              });
            }
            if (content.reviewsSubtitle) {
              document.querySelectorAll('.reviews-subtitle, #reviews .section-subtitle, #testimonials .section-subtitle, [data-content="reviewsSubtitle"]').forEach(function(el) {
                el.textContent = content.reviewsSubtitle;
              });
            }

            if (content.teamTitle) {
              document.querySelectorAll('[data-content="teamTitle"]').forEach(function(el) {
                el.textContent = content.teamTitle;
              });
            }
            if (content.teamSubtitle) {
              document.querySelectorAll('[data-content="teamSubtitle"]').forEach(function(el) {
                el.textContent = content.teamSubtitle;
              });
            }
            if (content.galleryTitle) {
              document.querySelectorAll('[data-content="galleryTitle"]').forEach(function(el) {
                el.textContent = content.galleryTitle;
              });
            }
            if (content.gallerySubtitle) {
              document.querySelectorAll('[data-content="gallerySubtitle"]').forEach(function(el) {
                el.textContent = content.gallerySubtitle;
              });
            }
            if (content.brandsTitle) {
              document.querySelectorAll('[data-content="brandsTitle"]').forEach(function(el) {
                el.textContent = content.brandsTitle;
              });
            }
            if (content.brandsSubtitle) {
              document.querySelectorAll('[data-content="brandsSubtitle"]').forEach(function(el) {
                el.textContent = content.brandsSubtitle;
              });
            }
            if (content.faqTitle) {
              document.querySelectorAll('[data-content="faqTitle"]').forEach(function(el) {
                el.textContent = content.faqTitle;
              });
            }
            if (content.faqSubtitle) {
              document.querySelectorAll('[data-content="faqSubtitle"]').forEach(function(el) {
                el.textContent = content.faqSubtitle;
              });
            }
            if (content.plansTitle) {
              document.querySelectorAll('[data-content="plansTitle"]').forEach(function(el) {
                el.textContent = content.plansTitle;
              });
            }
            if (content.plansSubtitle) {
              document.querySelectorAll('[data-content="plansSubtitle"]').forEach(function(el) {
                el.textContent = content.plansSubtitle;
              });
            }
            if (content.contactTitle) {
              document.querySelectorAll('[data-content="contactTitle"]').forEach(function(el) {
                el.textContent = content.contactTitle;
              });
            }
            if (content.contactSubtitle) {
              document.querySelectorAll('[data-content="contactSubtitle"]').forEach(function(el) {
                el.textContent = content.contactSubtitle;
              });
            }

            if (Array.isArray(content.galleryImages) && content.galleryImages.length > 0) {
              const galleryItems = document.querySelectorAll('[data-section-id="gallery"] .gallery-item');
              galleryItems.forEach(function(item, index) {
                const img = item.querySelector('img');
                if (!img) return;
                if (content.galleryImages[index]) {
                  img.src = content.galleryImages[index];
                  item.style.removeProperty('display');
                } else {
                  item.style.display = 'none';
                }
              });
            }

            if (Array.isArray(content.brandsLogos) && content.brandsLogos.length > 0) {
              const brandItems = document.querySelectorAll('[data-section-id="brands"] .brand-item');
              brandItems.forEach(function(item, index) {
                const img = item.querySelector('img');
                if (!img) return;
                const logoIndex = index % content.brandsLogos.length;
                if (content.brandsLogos[logoIndex]) {
                  img.src = content.brandsLogos[logoIndex];
                }
              });
            }

            // Redes sociales - actualizar enlaces
            if (content.socialLinks) {
              Object.keys(content.socialLinks).forEach(function(network) {
                var url = content.socialLinks[network];
                if (url) {
                  document.querySelectorAll('[data-social="' + network + '"], .social-' + network + ' a').forEach(function(el) {
                    if (el.tagName === 'A') {
                      el.href = url;
                    } else {
                      var link = el.querySelector('a');
                      if (link) link.href = url;
                    }
                  });
                }
              });
            }
          }

          // Aplicar features
          const { features } = event.data.payload;
          if (features) {
            // Titulo y subtitulo de la seccion
            if (features.title) {
              const el = document.querySelector('.features-header h2, #features h2');
              if (el) el.textContent = features.title;
            }
            if (features.subtitle) {
              const el = document.querySelector('.features-header p, #features > .container > .features-header > p');
              if (el) el.textContent = features.subtitle;
            }
            // Items individuales
            if (features.items && features.items.length > 0) {
              const cards = document.querySelectorAll('.feature-card');
              features.items.forEach(function(item, index) {
                if (cards[index]) {
                  const titleEl = cards[index].querySelector('.feature-title, h3');
                  const descEl = cards[index].querySelector('.feature-description, p');
                  const iconEl = cards[index].querySelector('.feature-icon');
                  if (titleEl && item.title) titleEl.textContent = item.title;
                  if (descEl && item.description) descEl.textContent = item.description;
                  if (iconEl && item.iconSvg) iconEl.innerHTML = item.iconSvg;
                }
              });
            }
          }

          // Aplicar sectionsConfig - Mostrar/ocultar y reordenar secciones en tiempo real
          const { sectionsConfig } = event.data.payload;
          if (sectionsConfig && sectionsConfig.sections) {
            console.log('[Preview] Applying sectionsConfig:', sectionsConfig.sections.length, 'sections');

            sectionsConfig.sections.forEach(function(sectionCfg) {
              const sectionEl = document.querySelector('[data-section-id="' + sectionCfg.id + '"]');
              if (sectionEl) {
                // Actualizar visibilidad
                if (sectionCfg.enabled) {
                  sectionEl.style.display = '';
                  console.log('[Preview] Section', sectionCfg.id, 'enabled, order:', sectionCfg.order);
                } else {
                  sectionEl.style.display = 'none';
                  console.log('[Preview] Section', sectionCfg.id, 'disabled');
                }

                // Actualizar orden (CSS order para flexbox)
                if (sectionCfg.order !== undefined) {
                  sectionEl.style.order = sectionCfg.order.toString();
                }
              } else {
                console.log('[Preview] Section element not found:', sectionCfg.id);
              }
            });
          }
        });
      })();
    </script>
    <script is:inline>
      (function () {
        if (window.location.search.includes("preview=1")) return;
        if (!window.matchMedia("(max-width: 768px)").matches) return;
        if (window.matchMedia("(display-mode: standalone)").matches) return;
        if (window.navigator.standalone) return;

        const banner = document.getElementById("pwa-install-banner");
        const actionBtn = document.getElementById("pwa-install-action");
        const closeBtn = document.getElementById("pwa-install-close");
        if (!banner) return;

        if (localStorage.getItem("pwaInstallDismissed") === "1") return;

        const isIos = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
        let deferredPrompt = null;

        const showBanner = () => {
          banner.classList.add("show");
          banner.setAttribute("aria-hidden", "false");
        };

        const hideBanner = () => {
          banner.classList.remove("show");
          banner.setAttribute("aria-hidden", "true");
          localStorage.setItem("pwaInstallDismissed", "1");
        };

        closeBtn?.addEventListener("click", hideBanner);

        if (isIos) {
          banner.classList.add("ios");
          showBanner();
          return;
        }

        window.addEventListener("beforeinstallprompt", (event) => {
          event.preventDefault();
          deferredPrompt = event;
          showBanner();
        });

        window.addEventListener("appinstalled", hideBanner);

        actionBtn?.addEventListener("click", async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          try {
            await deferredPrompt.userChoice;
          } finally {
            hideBanner();
            deferredPrompt = null;
          }
        });
      })();
    </script>
  </body>
</html>
